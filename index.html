<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>纯白人生 · Tabula Rasa</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-canvas: #F7F9FB;
            --bg-warm: #FAFAFA;
            --container: #FFFFFF;
            --shadow-soft: 0 4px 20px rgba(0,0,0,0.03);
            --shadow-card: 0 2px 12px rgba(0,0,0,0.04);
            --accent-health: #A0E7E5;
            --accent-money: #FBE7C6;
            --accent-mood: #FFAEBC;
            --accent-intel: #B4F8C8;
            --accent-intel-alt: #A0C4FF;
            --text-title: #2C3E50;
            --text-body: #5D6D7E;
            --text-muted: #BFC9CA;
            --radius: 12px;
            --radius-lg: 20px;
            --safe-bottom: env(safe-area-inset-bottom, 0px);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body {
            font-family: 'Nunito', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-canvas);
            color: var(--text-body);
            min-height: 100vh;
            min-height: 100dvh;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }
        /* 全局隐藏滚动条，滑动时不再显示滚动框 */
        html, body, * {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        html::-webkit-scrollbar, body::-webkit-scrollbar,
        *::-webkit-scrollbar {
            display: none;
            width: 0;
            height: 0;
        }
        body { padding-bottom: calc(72px + var(--safe-bottom)); }

        /* 主容器 */
        .app-wrap { max-width: 480px; margin: 0 auto; min-height: 100vh; }

        /* 顶部状态栏 */
        .status-bar {
            padding: 12px 20px;
            background: var(--container);
            box-shadow: var(--shadow-soft);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .status-bar-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .status-bar .title { font-size: 18px; font-weight: 700; color: var(--text-title); }
        .status-bar .age-badge {
            background: #fff;
            color: var(--text-title);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: var(--shadow-card);
        }
        .status-bar .age-badge:hover { transform: scale(1.05); box-shadow: 0 2px 12px rgba(0,0,0,0.1); }
        .status-bar .age-badge:active { transform: scale(0.98); }
        .date-bar {
            margin-top: 8px;
            font-size: 14px;
            color: var(--text-muted);
        }

        /* Tab 内容区 */
        .tab-content { display: none; padding: 16px; padding-bottom: 24px; min-height: 60vh; }
        .tab-content.active { display: block; }

        /* ========== 地图 Tab ========== */
        .map-viewport {
            height: 55vh;
            min-height: 280px;
            background: var(--container);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-soft);
            overflow: hidden;
            position: relative;
        }
        .map-layer {
            position: absolute;
            inset: 0;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease, transform 0.5s ease;
        }
        .map-layer.active {
            opacity: 1;
            pointer-events: auto;
        }
        .map-layer.exit {
            opacity: 0;
            transform: scale(1.1);
        }
        .map-grid {
            width: 100%;
            height: 100%;
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            grid-template-rows: repeat(4, 1fr);
            gap: 6px;
            padding: 16px;
        }
        .map-cell {
            background: var(--bg-canvas);
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        .map-cell:hover, .map-cell:active {
            background: #fff;
            border-color: rgba(0,0,0,0.1);
        }
        .map-cell-empty { background: rgba(0,0,0,0.02); cursor: default; }
        .map-cell-empty:hover { background: rgba(0,0,0,0.02); border-color: transparent; }
        .map-cell-icon { font-size: 22px; margin-bottom: 2px; }
        .map-cell-name { font-size: 11px; color: var(--text-body); text-align: center; line-height: 1.2; }
        .map-stage-title {
            position: absolute;
            bottom: 12px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 12px;
            color: var(--text-muted);
        }
        .current-loc-bar {
            margin-top: 12px;
            padding: 10px 16px;
            background: var(--container);
            border-radius: var(--radius);
            box-shadow: var(--shadow-card);
            font-size: 14px;
            color: var(--text-muted);
            text-align: center;
        }

        /* ========== 功能 Tab (Life) ========== */
        .life-panel { display: flex; flex-direction: column; gap: 16px; }
        .card { background: var(--container); border-radius: var(--radius); box-shadow: var(--shadow-card); padding: 20px; }
        .card-title { font-size: 16px; font-weight: 700; color: var(--text-title); margin-bottom: 16px; }
        .stats-radar-wrap {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            background: var(--bg-canvas);
            border-radius: var(--radius);
        }
        .stat-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
        .stat-dot.health { background: var(--accent-health); }
        .stat-dot.money { background: var(--accent-money); }
        .stat-dot.mood { background: var(--accent-mood); }
        .stat-dot.intel { background: var(--accent-intel); }
        .stat-dot.eq { background: var(--accent-intel-alt); }
        .stat-dot.charm { background: #E8B4B8; }
        .stat-dot.appearance { background: #DDA0DD; }
        .stat-label { font-size: 11px; color: var(--text-muted); }
        .stat-value { font-size: 14px; font-weight: 700; color: var(--text-title); }
        .pressure-bar-wrap { margin-top: 12px; }
        .pressure-bar {
            height: 6px;
            background: var(--bg-canvas);
            border-radius: 3px;
            overflow: hidden;
        }
        .pressure-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-mood), #ff6b7a);
            border-radius: 3px;
            transition: width 0.3s;
        }
        .age-specific-wrap { margin-top: 12px; }
        .age-specific-title { font-size: 12px; color: var(--text-muted); margin-bottom: 8px; }
        .age-specific-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 6px; }
        .age-stat { display: flex; align-items: center; justify-content: space-between; padding: 6px 10px; background: var(--bg-canvas); border-radius: 8px; font-size: 12px; }
        .age-stat-name { color: var(--text-muted); }
        .age-stat-val { font-weight: 600; color: var(--text-title); }
        .timeline-toggle { display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .toggle-arrow { font-size: 10px; color: var(--text-muted); }
        .timeline-wrap.collapsed { display: none !important; }
        .timeline-wrap .timeline-line { display: none; }
        .timeline-wrap:not(.collapsed) .timeline-line { display: block; }
        .timeline-wrap {
            position: relative;
            padding-left: 24px;
        }
        .timeline-line {
            position: absolute;
            left: 8px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--accent-mood);
            opacity: 0.4;
            border-radius: 1px;
        }
        .timeline-item {
            position: relative;
            padding: 12px 0;
            border-bottom: 1px solid rgba(0,0,0,0.04);
        }
        .timeline-item:last-child { border-bottom: none; }
        .timeline-bubble {
            position: absolute;
            left: -22px;
            top: 14px;
            width: 12px;
            height: 12px;
            background: #fff;
            border-radius: 50%;
            box-shadow: 0 0 0 3px rgba(0,0,0,0.1);
        }
        .timeline-age { font-size: 12px; color: var(--text-muted); margin-bottom: 4px; }
        .timeline-text { font-size: 14px; color: var(--text-body); line-height: 1.5; }
        .year-btn-wrap { margin-top: 16px; text-align: center; }
        .year-btn {
            padding: 14px 32px;
            background: #fff;
            border: none;
            border-radius: 24px;
            font-size: 16px;
            font-weight: 600;
            color: var(--text-title);
            cursor: pointer;
            font-family: inherit;
            box-shadow: var(--shadow-card);
        }

        /* ========== 关系 Tab ========== */
        .filter-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            overflow-x: auto;
            padding-bottom: 4px;
            -ms-overflow-style: none; /* IE/旧 Edge 隐藏滚动条 */
            scrollbar-width: none; /* Firefox 隐藏滚动条 */
        }
        .filter-tabs::-webkit-scrollbar { display: none; }
        .filter-tab {
            padding: 8px 16px;
            background: var(--container);
            border: none;
            border-radius: 20px;
            font-size: 14px;
            color: var(--text-muted);
            cursor: pointer;
            white-space: nowrap;
            font-family: inherit;
            box-shadow: var(--shadow-card);
        }
        .filter-tab.active { background: var(--accent-mood); color: white; }
        .relation-list { display: flex; flex-direction: column; gap: 12px; }

        /* ========== 朋友圈 Tab ========== */
        .moments-feed { display: flex; flex-direction: column; gap: 16px; }
        .moments-empty { text-align: center; padding: 48px 24px; color: var(--text-muted); font-size: 14px; }
        .relation-card {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: var(--container);
            border-radius: var(--radius);
            box-shadow: var(--shadow-card);
        }
        .relation-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 700;
            color: var(--text-title);
            box-shadow: var(--shadow-card);
        }
        .relation-info { flex: 1; }
        .relation-name { font-size: 16px; font-weight: 600; color: var(--text-title); }
        .relation-role { font-size: 12px; color: var(--text-muted); }
        .relation-affinity {
            font-size: 14px;
            font-weight: 600;
            color: var(--accent-mood);
        }
        .relation-card { cursor: pointer; transition: background 0.2s; }
        .relation-card:hover { background: var(--bg-canvas); }
        .relation-card:active { opacity: 0.95; }

        /* 聊天界面 (QQ 风格) */
        .chat-panel {
            position: fixed;
            inset: 0;
            max-width: 480px;
            margin: 0 auto;
            background: var(--bg-canvas);
            z-index: 250;
            display: none;
            flex-direction: column;
        }
        .chat-panel.show { display: flex; }
        .chat-header {
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            padding: 12px 16px;
            padding-top: calc(12px + env(safe-area-inset-top, 0px));
            background: var(--container);
            box-shadow: var(--shadow-card);
        }
        .chat-back {
            position: absolute;
            left: 10px;
            width: 36px;
            height: 36px;
            border: none;
            background: rgba(255,255,255,0.9);
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-card);
        }
        .chat-more {
            position: absolute;
            right: 16px;
            width: 36px;
            height: 36px;
            border: none;
            background: var(--bg-canvas);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-card);
        }
        .chat-more svg {
            width: 20px;
            height: 20px;
        }
        .chat-title { font-size: 17px; font-weight: 600; color: var(--text-title); text-align: center; }
        .chat-location-share-bar {
            flex-shrink: 0;
            margin: 6px 12px 0;
            padding: 8px 12px;
            border-radius: 999px;
            background: radial-gradient(circle at 20% 0%, rgba(255,255,255,0.98), rgba(230,238,252,0.98));
            box-shadow:
                0 6px 14px rgba(15,23,42,0.18),
                inset 0 0 0 1px rgba(255,255,255,0.8);
            display: none;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }
        .chat-location-share-bar.show { display: flex; }
        .chat-location-share-info {
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 0;
        }
        .chat-location-share-dot {
            width: 8px;
            height: 8px;
            border-radius: 999px;
            background: #22c55e;
            box-shadow: 0 0 0 4px rgba(34,197,94,0.35);
            flex-shrink: 0;
        }
        .chat-location-share-text-main {
            font-size: 12px;
            color: var(--text-title);
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .chat-location-share-text-sub {
            font-size: 11px;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .chat-location-share-action {
            font-size: 11px;
            color: #2563eb;
            cursor: pointer;
            flex-shrink: 0;
        }
        .chat-location-share-action:hover { text-decoration: underline; }
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .chat-msg {
            display: flex;
            align-items: flex-end;
            gap: 8px;
        }
        .chat-msg.mine { flex-direction: row-reverse; }
        .chat-msg-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: var(--text-title);
            flex-shrink: 0;
            box-shadow: var(--shadow-card);
            overflow: hidden;
        }
        .chat-msg-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .chat-msg.mine .chat-msg-avatar { background: #fff; }

        /* 语音通话 P1 界面（QQ 风格抽象版） */
        .voice-call-panel {
            position: fixed;
            inset: 0;
            max-width: 480px;
            margin: 0 auto;
            background: radial-gradient(circle at 20% 0%, #1f2937, #020617);
            color: #e5e7eb;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding: 32px 24px 28px;
            z-index: 260;
        }
        .voice-call-panel.show { display: flex; }
        .voice-call-panel:not(.in-call) .voice-call-input-row {
            display: none;
        }
        .voice-call-top {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 13px;
            color: rgba(248,250,252,0.7);
        }
        .voice-call-tag {
            padding: 4px 10px;
            border-radius: 999px;
            background: rgba(15,23,42,0.6);
            border: 1px solid rgba(148,163,184,0.4);
            font-size: 11px;
            letter-spacing: 0.06em;
        }
        .voice-call-timer {
            font-variant-numeric: tabular-nums;
            font-size: 13px;
            color: rgba(248,250,252,0.9);
        }
        .voice-call-middle {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            gap: 14px;
            margin-top: 16px;
        }
        .voice-call-avatar-wrap {
            width: 120px;
            height: 120px;
            border-radius: 999px;
            background: radial-gradient(circle at 30% 20%, #ffffff, #c4d1ff);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow:
                0 0 0 10px rgba(148,163,184,0.18),
                0 24px 50px rgba(15,23,42,0.9);
            overflow: hidden;
        }
        .voice-call-avatar-wrap img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .voice-call-avatar-fallback {
            font-size: 40px;
            font-weight: 600;
            color: #1f2937;
        }
        .voice-call-name {
            font-size: 18px;
            font-weight: 600;
            color: #f9fafb;
        }
        .voice-call-status {
            font-size: 13px;
            color: rgba(209,213,219,0.85);
            margin-bottom: 8px;
        }
        .voice-call-transcript {
            width: 100%;
            max-height: 140px;
            padding: 10px 12px;
            border-radius: 14px;
            background: var(--voice-call-transcript-bg, linear-gradient(145deg, rgba(15,23,42,0.85), rgba(15,23,42,0.92)));
            box-shadow:
                inset 0 0 0 1px rgba(148,163,184,0.3),
                0 14px 28px rgba(15,23,42,0.85);
            font-size: 12px;
            color: var(--voice-call-transcript-color, #e5e7eb);
            overflow-y: auto;
        }
        .voice-call-transcript-line {
            margin-bottom: 4px;
            line-height: 1.4;
            word-break: break-all;
        }
        .voice-call-transcript-line.me {
            color: #a5b4fc;
        }
        .voice-call-transcript-line.other {
            color: #bfdbfe;
        }
        .voice-call-input-row {
            width: 100%;
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .voice-call-input {
            flex: 1;
            padding: 9px 11px;
            border-radius: 999px;
            border: 1px solid rgba(148,163,184,0.7);
            background: var(--voice-call-input-bg, rgba(15,23,42,0.9));
            color: var(--voice-call-input-color, #e5e7eb);
            font-size: 13px;
            font-family: inherit;
            outline: none;
        }
        .voice-call-input::placeholder {
            color: rgba(148,163,184,0.9);
        }
        .voice-call-send-btn {
            padding: 8px 14px;
            border-radius: 999px;
            border: none;
            background: rgba(249,250,251,0.96);
            color: #111827;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 8px 18px rgba(37,99,235,0.65);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .voice-call-doodle-btn {
            width: 32px;
            height: 32px;
            border-radius: 999px;
            border: 1px solid rgba(148,163,184,0.8);
            background: radial-gradient(circle at 30% 20%, #111827, #020617);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 6px 14px rgba(0,0,0,0.8);
        }
        .voice-call-doodle-btn svg {
            width: 18px;
            height: 18px;
        }
        .voice-call-bottom {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 40px;
        }
        .voice-call-btn {
            width: 56px;
            height: 56px;
            border-radius: 999px;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #e5e7eb;
            background: rgba(15,23,42,0.8);
            box-shadow: 0 14px 28px rgba(0,0,0,0.65);
            transition: transform 0.16s ease, box-shadow 0.16s ease, background 0.16s ease;
        }
        .voice-call-btn:active {
            transform: translateY(2px) scale(0.97);
            box-shadow: 0 6px 16px rgba(0,0,0,0.75);
        }
        .voice-call-btn svg { width: 26px; height: 26px; }
        .voice-call-btn.hangup {
            background: linear-gradient(135deg, #ef4444, #b91c1c);
        }
        .chat-msg-bubble {
            max-width: 75%;
            padding: 10px 14px;
            border-radius: 16px;
            font-size: 15px;
            line-height: 1.4;
        }
        .chat-msg.other .chat-msg-bubble {
            background: #fff;
            box-shadow: var(--shadow-card);
            border-bottom-left-radius: 4px;
            color: var(--text-body);
        }
        .chat-msg.mine .chat-msg-bubble {
            background: #fff;
            box-shadow: var(--shadow-card);
            color: var(--text-body);
            border-bottom-right-radius: 4px;
        }
        .chat-msg-image { cursor: pointer; position: relative; }
        .chat-msg-image-desc {
            display: none;
            margin-top: 8px;
            padding: 10px 14px;
            border-radius: 12px;
            font-size: 13px;
            color: var(--text-body);
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            box-shadow: 
                inset 2px 2px 4px rgba(255, 255, 255, 0.8),
                inset -2px -2px 4px rgba(0, 0, 0, 0.1),
                0 2px 8px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        .chat-msg-image-desc.show { display: block; }
        .chat-msg-gift-card {
            max-width: 280px;
            background: var(--container);
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow-card);
            display: flex;
            flex-direction: column;
        }
        .chat-msg-gift-pic {
            width: 100%;
            aspect-ratio: 1;
            background: var(--bg-canvas);
            object-fit: cover;
        }
        .chat-msg-gift-info {
            padding: 12px;
        }
        .chat-msg-gift-name {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-title);
            margin-bottom: 4px;
        }
        .chat-msg-gift-desc {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 6px;
            line-height: 1.4;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        .chat-msg-gift-price {
            font-size: 16px;
            font-weight: 700;
            color: var(--accent-mood);
        }
        .chat-input-row {
            flex-shrink: 0;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            padding-bottom: calc(12px + var(--safe-bottom));
            background: var(--container);
            border-top: 1px solid rgba(0,0,0,0.06);
            position: relative;
        }
        .chat-plus-btn {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 50%;
            background: #fff;
            color: var(--text-title);
            font-size: 24px;
            font-weight: 300;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-card);
            transition: transform 0.2s;
            flex-shrink: 0;
        }
        .chat-plus-btn:hover { transform: scale(1.1); }
        .chat-plus-btn:active { transform: scale(0.95); }
        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #eee;
            border-radius: 20px;
            font-size: 15px;
            font-family: inherit;
            background: var(--bg-canvas);
        }
        .chat-input:focus { outline: none; border-color: #ddd; }
        .chat-send-wrap {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .chat-send {
            padding: 12px 16px;
            border: none;
            border-radius: 20px;
            background: #fff;
            color: var(--text-title);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            font-family: inherit;
            box-shadow: var(--shadow-card);
        }
        .chat-send-icon {
            width: 28px;
            height: 28px;
            flex-shrink: 0;
            opacity: 0.9;
        }
        .chat-send-icon svg {
            width: 100%;
            height: 100%;
            stroke: var(--accent-mood);
            fill: none;
            stroke-width: 1.8;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        /* 聊天+号菜单 */
        .chat-plus-menu {
            position: absolute;
            bottom: calc(100% + 8px);
            left: 0;
            width: 280px;
            max-width: calc(100vw - 32px);
            background: var(--container);
            border-radius: var(--radius-lg);
            box-shadow: 0 -8px 32px rgba(0,0,0,0.12);
            padding: 16px;
            z-index: 260;
            opacity: 0;
            transform: translateY(20px);
            pointer-events: none;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .chat-plus-menu.show {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }
        .chat-plus-menu-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }
        .chat-plus-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 12px;
            border-radius: var(--radius);
            cursor: pointer;
            transition: background 0.2s, transform 0.2s;
        }
        .chat-plus-item:hover {
            background: var(--bg-canvas);
            transform: translateY(-2px);
        }
        .chat-plus-item:active {
            transform: translateY(0);
        }
        .chat-plus-item-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--bg-canvas);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-card);
        }
        .chat-plus-item-icon svg {
            width: 28px;
            height: 28px;
            stroke: var(--text-title);
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        .chat-plus-item-label {
            font-size: 12px;
            color: var(--text-body);
            text-align: center;
        }

        /* ========== 设置 Tab ========== */
        .save-slots { display: flex; flex-direction: column; gap: 16px; }
        .save-card {
            padding: 20px;
            background: var(--container);
            border-radius: var(--radius);
            box-shadow: var(--shadow-card);
            border: 2px dashed var(--text-muted);
            opacity: 0.8;
        }
        .save-card.filled { border-style: solid; border-color: #fff; opacity: 1; }
        .save-card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }
        .save-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--accent-money);
        }
        .save-meta { flex: 1; }
        .save-age { font-size: 14px; font-weight: 600; color: var(--text-title); }
        .save-detail { font-size: 12px; color: var(--text-muted); }
        .save-actions { display: flex; gap: 8px; margin-top: 12px; }
        .save-actions button {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            font-family: inherit;
        }
        .save-load { background: #fff; color: var(--text-title); box-shadow: var(--shadow-card); }
        .save-del { background: var(--bg-canvas); color: var(--text-muted); }
        .api-section { margin-top: 24px; }
        .api-toggle-wrap {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: var(--container);
            border-radius: var(--radius);
            margin-bottom: 12px;
            box-shadow: var(--shadow-card);
        }
        .toggle-switch {
            width: 48px;
            height: 26px;
            background: var(--text-muted);
            border-radius: 13px;
            position: relative;
            cursor: pointer;
        }
        .toggle-switch.on { background: #fff; border: 1px solid #eee; }
        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.2s;
        }
        .toggle-switch.on::after { transform: translateX(22px); }
        .api-input { width: 100%; padding: 12px; border: 1px solid #eee; border-radius: 8px; margin-top: 8px; font-family: inherit; }
        .api-field { margin-bottom: 16px; }
        .api-field label { display: block; font-size: 13px; color: var(--text-muted); margin-bottom: 4px; }
        .model-row { display: flex; gap: 8px; align-items: center; margin-top: 8px; }
        .model-row .api-input { margin-top: 0; }
        .api-fetch-btn { padding: 10px 16px; background: #fff; color: var(--text-title); border: none; border-radius: 8px; font-size: 14px; cursor: pointer; font-family: inherit; white-space: nowrap; box-shadow: var(--shadow-card); }
        .api-fetch-btn:hover { opacity: 0.9; }
        .model-list { margin-top: 8px; max-height: 160px; overflow-y: auto; background: var(--bg-canvas); border-radius: 8px; padding: 8px; display: none; }
        .model-list.show { display: block; }
        .model-item { padding: 8px 12px; font-size: 13px; color: var(--text-body); cursor: pointer; border-radius: 6px; }
        .model-item:hover { background: #fff; color: var(--text-title); }
        .reincarnate-btn {
            width: 100%;
            padding: 16px;
            margin-top: 24px;
            background: linear-gradient(135deg, var(--text-title), #34495e);
            border: none;
            border-radius: var(--radius);
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            font-family: inherit;
        }

        /* 底部 Dock */
        .dock {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            max-width: 480px;
            width: 100%;
            padding: 12px 16px;
            padding-bottom: calc(12px + var(--safe-bottom));
            background: rgba(255,255,255,0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            box-shadow: 0 -4px 24px rgba(0,0,0,0.06);
            display: flex;
            justify-content: space-around;
            z-index: 200;
        }
        .dock-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 16px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-family: inherit;
            font-size: 12px;
            color: var(--text-muted);
            transition: all 0.2s;
            border-radius: 12px;
        }
        .dock-item:hover, .dock-item.active { color: var(--text-title); }
        .dock-item.active { font-weight: 600; }
        .dock-icon { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; }
        .dock-icon svg { width: 22px; height: 22px; stroke-linecap:round; stroke-linejoin:round; }

        /* 交互卡片 L2 */
        .interact-modal {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            max-width: 480px;
            margin: 0 auto;
            background: var(--container);
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            box-shadow: 0 -8px 32px rgba(0,0,0,0.1);
            padding: 24px;
            z-index: 300;
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }
        .interact-modal.show { transform: translateY(0); }
        .interact-modal .close-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 32px;
            height: 32px;
            border: none;
            background: var(--bg-canvas);
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
        }
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.3);
            z-index: 299;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        .modal-overlay.show { opacity: 1; pointer-events: auto; }
        #profileOverlay, #reincarnateOverlay { z-index: 308; }

        /* 个人档案弹窗 */
        .profile-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.95);
            width: calc(100% - 32px);
            max-width: 400px;
            background: var(--container);
            border-radius: var(--radius-lg);
            box-shadow: 0 24px 48px rgba(0,0,0,0.12);
            z-index: 310;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.25s, transform 0.25s;
        }
        .profile-modal.show { opacity: 1; pointer-events: auto; transform: translate(-50%, -50%) scale(1); }
        .profile-modal-header {
            padding: 24px 24px 0;
            text-align: center;
        }
        .profile-modal-title { font-size: 20px; font-weight: 700; color: var(--text-title); margin-bottom: 20px; }
        .profile-avatar-wrap {
            width: 100px;
            height: 100px;
            margin: 0 auto 16px;
            border-radius: 50%;
            overflow: hidden;
            background: #fff;
            position: relative;
            cursor: pointer;
            border: 4px solid rgba(255,255,255,0.9);
            box-shadow: 0 8px 24px rgba(0,0,0,0.08);
        }
        .profile-avatar-wrap:hover::after {
            content: '更换';
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.5);
            color: white;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .profile-avatar-wrap img { width: 100%; height: 100%; object-fit: cover; }
        .profile-avatar-wrap .avatar-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            color: var(--text-title);
        }
        .profile-modal-body { padding: 0 24px 24px; }
        .profile-field {
            margin-bottom: 16px;
        }
        .profile-field-label { font-size: 13px; color: var(--text-muted); margin-bottom: 6px; display: block; }
        .profile-info-row {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
        }
        .profile-info-item {
            flex: 1;
            padding: 12px 16px;
            background: var(--bg-canvas);
            border-radius: var(--radius);
            font-size: 14px;
        }
        .profile-info-item .val { font-weight: 600; color: var(--text-title); }
        .profile-bg-input {
            width: 100%;
            min-height: 80px;
            padding: 12px 16px;
            border: 1px solid #eee;
            border-radius: var(--radius);
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            background: var(--bg-canvas);
        }
        .profile-bg-input:focus { outline: none; border-color: #ddd; }
        .profile-modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }
        .profile-modal-actions button {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: var(--radius);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            font-family: inherit;
        }
        .profile-save-btn { background: #fff; color: var(--text-title); box-shadow: var(--shadow-card); }
        .profile-cancel-btn { background: var(--bg-canvas); color: var(--text-muted); }
        input[type="file"]#profileAvatarInput { display: none; }
        input[type="file"]#relationAvatarInput { display: none; }

        /* 聊天设置全屏页样式 */
        #chatSettingsOverlay {
            background: transparent;
        }
        #chatSettingsModal {
            top: 0;
            left: 50%;
            transform: translate(-50%, 0);
            width: 100%;
            max-width: 480px;
            height: 100%;
            border-radius: 0;
            box-shadow: none;
        }
        .chat-settings-header-row {
            display: flex;
            align-items: center;
            padding: 12px 12px;
            padding-top: calc(12px + env(safe-area-inset-top, 0px));
            border-bottom: 1px solid rgba(0,0,0,0.03);
        }
        .chat-settings-back {
            width: 32px;
            height: 32px;
            border-radius: 16px;
            border: none;
            background: rgba(255,255,255,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-right: 8px;
            box-shadow: var(--shadow-card);
        }
        .chat-settings-title-text {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-title);
        }
        .chat-switch {
            position: relative;
            width: 40px;
            height: 22px;
            border-radius: 11px;
            background: #d0d7de;
            cursor: pointer;
            flex-shrink: 0;
            transition: background 0.18s;
        }
        .chat-switch.on {
            background: #27ae60;
        }
        .chat-switch-thumb {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #fff;
            transition: transform 0.18s;
        }

        /* 重开人生弹窗 */
        .reincarnate-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.95);
            width: calc(100% - 32px);
            max-width: 380px;
            background: var(--container);
            border-radius: var(--radius-lg);
            box-shadow: 0 24px 48px rgba(0,0,0,0.12);
            z-index: 310;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.25s, transform 0.25s;
        }
        .reincarnate-modal.show { opacity: 1; pointer-events: auto; transform: translate(-50%, -50%) scale(1); }
        .reincarnate-header { padding: 24px 24px 16px; text-align: center; }
        .reincarnate-title { font-size: 20px; font-weight: 700; color: var(--text-title); }
        .reincarnate-desc { font-size: 13px; color: var(--text-muted); margin-top: 8px; }
        .reincarnate-options { padding: 0 24px 24px; display: flex; flex-direction: column; gap: 12px; }
        .reincarnate-opt {
            padding: 16px 20px;
            border-radius: var(--radius);
            border: 2px solid #eee;
            background: var(--bg-canvas);
            font-size: 15px;
            font-weight: 500;
            color: var(--text-title);
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        .reincarnate-opt:hover:not(.disabled) { border-color: var(--accent-intel); background: rgba(180,248,200,0.2); }
        .reincarnate-opt.disabled { opacity: 0.5; cursor: not-allowed; color: var(--text-muted); }
        .reincarnate-opt-sub { font-size: 12px; color: var(--text-muted); margin-top: 4px; font-weight: 400; }

        /* 表情包弹窗 */
        .sticker-picker-modal { position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%); width: calc(100% - 32px); max-width: 400px; max-height: 80vh; background: var(--container); border-radius: var(--radius-lg); box-shadow: 0 24px 48px rgba(0,0,0,0.12); z-index: 320; opacity: 0; pointer-events: none; transition: opacity 0.25s; display: flex; flex-direction: column; }
        .sticker-picker-modal.show { opacity: 1; pointer-events: auto; }
        .sticker-picker-header { padding: 16px 20px; border-bottom: 1px solid rgba(0,0,0,0.06); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .sticker-picker-title { font-size: 18px; font-weight: 700; color: var(--text-title); }
        .sticker-picker-close { width: 32px; height: 32px; border: none; background: var(--bg-canvas); border-radius: 50%; font-size: 18px; color: var(--text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .sticker-picker-body { padding: 16px 20px; overflow-y: auto; flex: 1; }
        .sticker-section-title { font-size: 14px; font-weight: 600; color: var(--text-title); margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between; }
        .sticker-section-add { width: 28px; height: 28px; border-radius: 50%; border: none; background: var(--accent-mood); color: #fff; font-size: 18px; line-height: 1; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .sticker-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; }
        .sticker-item { aspect-ratio: 1; border-radius: var(--radius); overflow: hidden; background: var(--bg-canvas); cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 2px solid transparent; transition: border-color 0.2s; }
        .sticker-item { position: relative; }
        .sticker-item:hover { border-color: var(--accent-mood); }
        .sticker-item img { width: 100%; height: 100%; object-fit: cover; }
        .sticker-item-desc { font-size: 10px; color: var(--text-muted); padding: 2px 4px; text-align: center; max-height: 24px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; width: 100%; }
        .sticker-item-add { font-size: 24px; color: var(--text-muted); }
        .sticker-item-edit { position: absolute; top: 4px; right: 4px; width: 24px; height: 24px; border: none; border-radius: 50%; background: rgba(0,0,0,0.5); color: #fff; font-size: 11px; cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 0; line-height: 1; z-index: 2; }
        .sticker-item-edit:hover { background: rgba(0,0,0,0.7); }

        /* 个人相册（添加表情包）弹窗 */
        .album-modal { position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%); width: calc(100% - 32px); max-width: 360px; background: var(--container); border-radius: var(--radius-lg); box-shadow: 0 24px 48px rgba(0,0,0,0.12); z-index: 330; opacity: 0; pointer-events: none; transition: opacity 0.25s; }
        .album-modal.show { opacity: 1; pointer-events: auto; }
        .album-modal-header { padding: 16px 20px; border-bottom: 1px solid rgba(0,0,0,0.06); font-size: 18px; font-weight: 700; color: var(--text-title); }
        .album-modal-body { padding: 20px; }
        .album-pick-wrap { margin-bottom: 16px; }
        .album-pick-btn { width: 100%; padding: 12px; border: 2px dashed #ddd; border-radius: var(--radius); background: var(--bg-canvas); color: var(--text-muted); font-size: 14px; cursor: pointer; text-align: center; }
        .album-pick-btn:hover { border-color: var(--accent-mood); color: var(--accent-mood); }
        .album-preview { width: 100%; max-height: 160px; object-fit: contain; border-radius: var(--radius); margin-top: 10px; display: none; }
        .album-preview.show { display: block; }
        .album-desc-label { font-size: 13px; color: var(--text-muted); margin-bottom: 6px; display: block; }
        .album-desc-input { width: 100%; padding: 10px 14px; border: 1px solid #eee; border-radius: var(--radius); font-size: 14px; font-family: inherit; background: var(--bg-canvas); outline: none; box-sizing: border-box; }
        .album-actions { margin-top: 20px; display: flex; gap: 12px; }
        .album-actions button { flex: 1; padding: 12px; border: none; border-radius: var(--radius); font-size: 14px; font-weight: 600; cursor: pointer; font-family: inherit; }
        .album-confirm { background: var(--accent-mood); color: #fff; }
        .album-cancel { background: var(--bg-canvas); color: var(--text-muted); }
        #stickerAlbumFileInput { display: none; }

        /* 发送图片弹窗 */
        .image-send-modal { position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%); width: calc(100% - 32px); max-width: 360px; background: var(--container); border-radius: var(--radius-lg); box-shadow: 0 24px 48px rgba(0,0,0,0.12); z-index: 325; opacity: 0; pointer-events: none; transition: opacity 0.25s; }
        .image-send-modal.show { opacity: 1; pointer-events: auto; }
        .image-send-header { padding: 16px 20px; border-bottom: 1px solid rgba(0,0,0,0.06); font-size: 18px; font-weight: 700; color: var(--text-title); }
        .image-send-body { padding: 20px; }
        .image-send-pick { margin-bottom: 16px; }
        .image-send-preview { width: 100%; max-height: 180px; object-fit: contain; border-radius: var(--radius); margin-top: 10px; display: none; }
        .image-send-preview.show { display: block; }
        .image-send-desc-hint { font-size: 12px; color: var(--text-muted); margin-bottom: 6px; }

        /* 发送位置弹窗 */
        .location-modal { position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%); width: calc(100% - 32px); max-width: 380px; background: linear-gradient(145deg, rgba(255,255,255,0.98), rgba(245,247,250,0.98)); border-radius: var(--radius-lg); box-shadow: 0 24px 48px rgba(15,23,42,0.18); z-index: 326; opacity: 0; pointer-events: none; transition: opacity 0.25s, transform 0.25s; }
        .location-modal.show { opacity: 1; pointer-events: auto; transform: translate(-50%, -50%) translateY(0); }
        .location-header { padding: 16px 20px 12px; border-bottom: 1px solid rgba(0,0,0,0.04); display: flex; align-items: center; gap: 12px; }
        .location-header-icon { width: 32px; height: 32px; border-radius: 999px; background: radial-gradient(circle at 30% 20%, rgba(255,255,255,0.9), rgba(160,228,255,0.9)); display: flex; align-items: center; justify-content: center; box-shadow: 0 6px 16px rgba(52,152,219,0.4); color: #1f78d1; }
        .location-header-text { display: flex; flex-direction: column; gap: 2px; }
        .location-header-title { font-size: 17px; font-weight: 700; color: var(--text-title); }
        .location-header-sub { font-size: 12px; color: var(--text-muted); }
        .location-body { padding: 12px 20px 18px; }
        .location-status { font-size: 12px; color: var(--text-muted); margin-bottom: 10px; }
        .location-fields-row { display: flex; gap: 8px; margin-bottom: 10px; }
        .location-field { flex: 1; }
        .location-field label { display: block; font-size: 12px; color: var(--text-muted); margin-bottom: 4px; }
        .location-field input { width: 100%; padding: 8px 10px; border-radius: 8px; border: 1px solid #eee; font-size: 13px; font-family: inherit; background: var(--bg-canvas); outline: none; }
        .location-field input:focus { border-color: #ddd; }
        .location-map-wrap { margin: 10px 0 14px; border-radius: var(--radius); overflow: hidden; background: var(--bg-canvas); box-shadow: inset 0 0 0 1px rgba(255,255,255,0.6), 0 10px 24px rgba(15,23,42,0.18); position: relative; }
        .location-map-label { position: absolute; left: 10px; top: 10px; padding: 4px 10px; border-radius: 999px; background: rgba(15,23,42,0.72); color: #f9fafb; font-size: 11px; letter-spacing: 0.02em; z-index: 1; }
        .location-map-canvas { width: 100%; height: 200px; display: block; background: radial-gradient(circle at 30% 20%, #ffffff, #eef2f7); }
        .location-actions { display: flex; gap: 10px; margin-top: 10px; }
        .location-actions button { flex: 1; border-radius: 999px; border: none; padding: 10px 0; font-size: 14px; font-weight: 600; font-family: inherit; cursor: pointer; transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.15s ease, color 0.15s ease; }
        .location-primary { background: linear-gradient(135deg, var(--accent-intel), var(--accent-intel-alt)); color: #fff; box-shadow: 0 10px 22px rgba(46, 204, 113, 0.4); }
        .location-secondary { background: rgba(255,255,255,0.9); color: var(--text-title); box-shadow: 0 6px 16px rgba(15,23,42,0.08); }
        .location-actions button:active { transform: translateY(1px) scale(0.99); box-shadow: 0 3px 10px rgba(15,23,42,0.18); }

        /* 聊天内位置卡片 */
        .chat-msg-location-card {
            padding: 10px 12px;
            background: linear-gradient(145deg, rgba(255,255,255,0.96), rgba(240,244,250,0.96));
            border-radius: 14px;
            box-shadow:
                0 10px 24px rgba(15,23,42,0.18),
                inset 0 0 0 1px rgba(255,255,255,0.8);
            font-size: 13px;
            max-width: 260px;
            position: relative;
            overflow: hidden;
        }
        .chat-msg-location-pill {
            position: absolute;
            right: 10px;
            top: 10px;
            padding: 2px 8px;
            border-radius: 999px;
            background: rgba(15,23,42,0.75);
            color: #e5e7eb;
            font-size: 10px;
            letter-spacing: 0.04em;
        }
        .chat-msg-location-head {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }
        .chat-msg-location-icon {
            width: 22px;
            height: 22px;
            border-radius: 999px;
            background: radial-gradient(circle at 30% 20%, #ffffff, #bee3f8);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #2563eb;
            flex-shrink: 0;
            box-shadow: 0 4px 10px rgba(37,99,235,0.35);
        }
        .chat-msg-location-title {
            font-weight: 600;
            color: var(--text-title);
            font-size: 13px;
        }
        .chat-msg-location-sub {
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }
        .chat-msg-location-mini-map {
            height: 46px;
            border-radius: 10px;
            background: radial-gradient(circle at 25% 20%, #ffffff, #d1ddf4);
            position: relative;
            overflow: hidden;
            margin-bottom: 6px;
        }
        .chat-msg-location-mini-map-grid {
            position: absolute;
            inset: 0;
            background-image:
                linear-gradient(to right, rgba(255,255,255,0.6) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(255,255,255,0.6) 1px, transparent 1px);
            background-size: 18px 18px;
            opacity: 0.5;
        }
        .chat-msg-location-mini-dot {
            position: absolute;
            width: 12px;
            height: 12px;
            border-radius: 999px;
            background: #0ea5e9;
            box-shadow:
                0 0 0 4px rgba(56,189,248,0.45),
                0 6px 12px rgba(15,23,42,0.35);
        }
        .chat-msg-voicecall-card {
            padding: 10px 12px;
            background: linear-gradient(145deg, rgba(255,255,255,0.96), rgba(237,242,255,0.96));
            border-radius: 14px;
            box-shadow:
                0 10px 22px rgba(15,23,42,0.18),
                inset 0 0 0 1px rgba(255,255,255,0.9);
            font-size: 12px;
            max-width: 260px;
        }
        .chat-msg-voicecall-head {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
            color: var(--text-title);
            font-weight: 600;
        }
        .chat-msg-voicecall-icon {
            width: 22px;
            height: 22px;
            border-radius: 999px;
            background: radial-gradient(circle at 30% 20%, #ffffff, #fee2e2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ef4444;
            box-shadow: 0 6px 14px rgba(239,68,68,0.4);
            flex-shrink: 0;
        }
        .chat-msg-voicecall-meta {
            font-size: 11px;
            color: var(--text-muted);
        }
        .image-send-desc-input { width: 100%; padding: 10px 14px; border: 1px solid #eee; border-radius: var(--radius); font-size: 14px; font-family: inherit; background: var(--bg-canvas); outline: none; box-sizing: border-box; }
        #imageSendFileInput { display: none; }

        /* 礼物界面 */
        .gift-panel {
            position: fixed;
            inset: 0;
            max-width: 480px;
            margin: 0 auto;
            background: var(--bg-canvas);
            z-index: 260;
            display: none;
            flex-direction: column;
        }
        .gift-panel.show { display: flex; }

        /* 音乐界面 */
        .music-panel {
            position: fixed;
            inset: 0;
            max-width: 480px;
            margin: 0 auto;
            background: var(--bg-canvas);
            z-index: 255;
            display: none;
            flex-direction: column;
        }
        .music-panel.show { display: flex; }
        .music-header {
            flex-shrink: 0;
            display: flex;
            align-items: center;
            padding: 12px 16px;
            padding-top: calc(12px + env(safe-area-inset-top, 0px));
            background: var(--container);
            box-shadow: var(--shadow-card);
        }
        .music-back {
            width: 36px;
            height: 36px;
            border: none;
            background: var(--bg-canvas);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            box-shadow: var(--shadow-card);
        }
        .music-search-wrap {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--bg-canvas);
            border-radius: 20px;
            padding: 6px 10px;
        }
        .music-search-input {
            flex: 1;
            border: none;
            background: transparent;
            font-size: 14px;
            font-family: inherit;
            outline: none;
        }
        .music-search-btn {
            border: none;
            background: rgba(255,255,255,0.9);
            border-radius: 999px;
            padding: 4px 10px;
            font-size: 12px;
            cursor: pointer;
        }
        .music-body {
            flex: 1;
            overflow-y: auto;
            padding: 12px 16px 16px;
        }
        .music-empty-hint {
            text-align: center;
            color: var(--text-muted);
            font-size: 13px;
            margin-top: 32px;
        }
        .music-loading-hint {
            text-align: center;
            color: var(--text-muted);
            font-size: 13px;
            margin-top: 12px;
        }
        .music-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .music-item {
            display: flex;
            flex-wrap: wrap;
            align-items: flex-start;
            gap: 10px;
            padding: 12px 12px;
            border-radius: 12px;
            background: var(--container);
            box-shadow: var(--shadow-card);
        }
        .music-item-top {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
        }
        .music-cover {
            width: 48px;
            height: 48px;
            border-radius: 10px;
            overflow: hidden;
            flex-shrink: 0;
        }
        .music-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .music-main {
            flex: 1;
            min-width: 0;
        }
        .music-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-title);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .music-artist {
            font-size: 13px;
            color: var(--text-muted);
            margin-top: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .music-actions {
            display: flex;
            gap: 6px;
            flex-shrink: 0;
        }
        .music-play-btn,
        .music-share-btn {
            border: none;
            border-radius: 999px;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
        }
        .music-play-btn {
            background: rgba(52,152,219,0.15);
            color: #2980b9;
        }
        .music-share-btn {
            background: rgba(46,204,113,0.15);
            color: #16a34a;
        }
        .music-progress-wrap {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .music-progress-time {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: var(--text-muted);
        }
        .music-progress {
            width: 100%;
        }
        .music-progress input[type="range"] {
            width: 100%;
            height: 6px;
            -webkit-appearance: none;
            appearance: none;
            background: rgba(0,0,0,0.08);
            border-radius: 3px;
            cursor: pointer;
        }
        .music-progress input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--primary, #3498db);
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            transition: transform 0.15s;
        }
        .music-progress input[type="range"]::-webkit-slider-runnable-track { height: 6px; border-radius: 3px; }
        .music-progress input[type="range"]::-moz-range-thumb {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--primary, #3498db);
            cursor: pointer;
            border: none;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .music-progress input[type="range"]::-moz-range-track {
            height: 6px;
            background: rgba(0,0,0,0.08);
            border-radius: 3px;
        }

        /* 聊天内音乐卡片 */
        .chat-msg-music-card {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 10px;
            padding: 8px 10px;
            border-radius: 12px;
            background: rgba(255,255,255,0.9);
            box-shadow: 0 2px 10px rgba(0,0,0,0.06);
            max-width: 300px;
        }
        .chat-msg-music-card > .chat-msg-music-progress-wrap {
            width: 100%;
            flex-basis: 100%;
        }
        .chat-msg-music-cover {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            overflow: hidden;
            flex-shrink: 0;
        }
        .chat-msg-music-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .chat-msg-music-info {
            flex: 1;
            min-width: 0;
        }
        .chat-msg-music-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-title);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .chat-msg-music-artist {
            font-size: 11px;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .chat-msg-music-play {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: none;
            background: #1f2937;
            color: #f9fafb;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        .chat-msg-music-progress-wrap {
            width: 100%;
            margin-top: 8px;
        }
        .chat-msg-music-progress-time {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: var(--text-muted);
            margin-bottom: 2px;
        }
        .chat-msg-music-progress {
            width: 100%;
        }
        .chat-msg-music-progress input[type="range"] {
            width: 100%;
            height: 5px;
            -webkit-appearance: none;
            appearance: none;
            background: rgba(0,0,0,0.08);
            border-radius: 3px;
            cursor: pointer;
        }
        .chat-msg-music-progress input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #1f2937;
            cursor: pointer;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        .chat-msg-music-progress input[type="range"]::-moz-range-thumb {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #1f2937;
            cursor: pointer;
            border: none;
        }
        .gift-header {
            flex-shrink: 0;
            display: flex;
            align-items: center;
            padding: 12px 16px;
            padding-top: calc(12px + env(safe-area-inset-top, 0px));
            background: var(--container);
            box-shadow: var(--shadow-card);
        }
        .gift-back {
            width: 36px;
            height: 36px;
            border: none;
            background: var(--bg-canvas);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            box-shadow: var(--shadow-card);
        }
        .gift-search-wrap {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--bg-canvas);
            border-radius: 20px;
            padding: 8px 12px 8px 16px;
            border: 1px solid rgba(0,0,0,0.06);
        }
        .gift-search-input {
            flex: 1;
            border: none;
            background: transparent;
            font-size: 14px;
            color: var(--text-title);
            outline: none;
        }
        .gift-search-input::placeholder { color: var(--text-muted); }
        .gift-search-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            flex-shrink: 0;
        }
        .gift-search-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .gift-grid-wrap {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }
        .gift-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        .gift-cell {
            background: var(--container);
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow-card);
            display: flex;
            flex-direction: column;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .gift-cell:hover { transform: translateY(-2px); box-shadow: 0 4px 16px rgba(0,0,0,0.08); }
        .gift-cell-pic {
            width: 100%;
            aspect-ratio: 1;
            background: var(--bg-canvas);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            font-size: 32px;
        }
        .gift-cell-pic img { width: 100%; height: 100%; object-fit: cover; }
        .gift-cell-info { padding: 10px; }
        .gift-cell-name { font-size: 14px; font-weight: 600; color: var(--text-title); margin-bottom: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .gift-cell-desc { font-size: 12px; color: var(--text-muted); margin-bottom: 4px; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; line-clamp: 2; -webkit-box-orient: vertical; }
        .gift-cell-price { font-size: 14px; font-weight: 700; color: var(--accent-mood); }
        .gift-empty { text-align: center; color: var(--text-muted); padding: 40px 20px; font-size: 14px; }
        .gift-loading { text-align: center; color: var(--text-muted); padding: 24px; font-size: 14px; }

        /* 礼物详情弹窗 */
        .gift-detail-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 270; display: none; align-items: center; justify-content: center; padding: 20px; }
        .gift-detail-overlay.show { display: flex; }
        .gift-detail-modal { background: var(--container); border-radius: var(--radius-lg); max-width: 360px; width: 100%; overflow: hidden; box-shadow: 0 24px 48px rgba(0,0,0,0.2); }
        .gift-detail-pic { width: 100%; aspect-ratio: 1; background: var(--bg-canvas); object-fit: cover; }
        .gift-detail-body { padding: 16px 20px; }
        .gift-detail-name { font-size: 18px; font-weight: 700; color: var(--text-title); margin-bottom: 8px; }
        .gift-detail-price { font-size: 16px; font-weight: 700; color: var(--accent-mood); margin-bottom: 8px; }
        .gift-detail-desc { font-size: 14px; color: var(--text-body); line-height: 1.5; margin-bottom: 20px; }
        .gift-detail-actions { display: flex; gap: 12px; }
        .gift-detail-actions button { flex: 1; padding: 12px; border: none; border-radius: var(--radius); font-size: 14px; font-weight: 600; cursor: pointer; font-family: inherit; }
        .gift-detail-send { background: var(--accent-mood); color: #fff; }
        .gift-detail-cancel { background: var(--bg-canvas); color: var(--text-muted); }

        .pay-modal { position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%); width: calc(100% - 32px); max-width: 340px; background: var(--container); border-radius: var(--radius-lg); box-shadow: 0 24px 48px rgba(0,0,0,0.12); z-index: 325; opacity: 0; pointer-events: none; transition: opacity 0.25s; }
        .pay-modal.show { opacity: 1; pointer-events: auto; }
        .pay-modal-title { padding: 16px 20px; border-bottom: 1px solid rgba(0,0,0,0.06); font-size: 18px; font-weight: 700; color: var(--text-title); display: flex; align-items: center; justify-content: space-between; }
        .pay-modal-style-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text-muted);
            transition: background 0.2s;
        }
        .pay-modal-style-btn:hover { background: var(--bg-canvas); color: var(--text-title); }
        .pay-modal-style-btn svg { width: 18px; height: 18px; }

        /* 样式库弹窗 */
        .style-library-modal { position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%); width: calc(100% - 32px); max-width: 400px; max-height: 80vh; background: var(--container); border-radius: var(--radius-lg); box-shadow: 0 24px 48px rgba(0,0,0,0.12); z-index: 340; opacity: 0; pointer-events: none; transition: opacity 0.25s; display: flex; flex-direction: column; }
        .style-library-modal.show { opacity: 1; pointer-events: auto; }
        .style-library-header { padding: 16px 20px; border-bottom: 1px solid rgba(0,0,0,0.06); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .style-library-title { font-size: 18px; font-weight: 700; color: var(--text-title); }
        .style-library-header-right { display: flex; align-items: center; gap: 8px; }
        .style-library-add-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: var(--accent-mood);
            border-radius: 50%;
            color: #fff;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .style-library-close-btn { width: 32px; height: 32px; border: none; background: var(--bg-canvas); border-radius: 50%; font-size: 18px; color: var(--text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .style-library-body { padding: 16px 20px; overflow-y: auto; flex: 1; }
        .style-library-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .style-library-item {
            aspect-ratio: 1.2;
            border-radius: var(--radius);
            overflow: hidden;
            cursor: pointer;
            border: 2px solid transparent;
            transition: border-color 0.2s, transform 0.2s;
            position: relative;
            box-shadow: var(--shadow-card);
        }
        .style-library-item:hover { border-color: var(--accent-mood); transform: translateY(-2px); }
        .style-library-item.active { border-color: var(--accent-mood); border-width: 3px; }
        .style-library-item-preview {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        .style-library-item-name {
            padding: 8px;
            font-size: 12px;
            font-weight: 600;
            color: #fff;
            background: rgba(0,0,0,0.3);
            text-align: center;
        }

        /* 自定义样式弹窗 */
        .style-custom-modal { position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%); width: calc(100% - 32px); max-width: 600px; max-height: 90vh; background: var(--container); border-radius: var(--radius-lg); box-shadow: 0 24px 48px rgba(0,0,0,0.12); z-index: 350; opacity: 0; pointer-events: none; transition: opacity 0.25s; display: flex; flex-direction: column; }
        .style-custom-modal.show { opacity: 1; pointer-events: auto; }
        .style-custom-header { padding: 16px 20px; border-bottom: 1px solid rgba(0,0,0,0.06); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .style-custom-title { font-size: 18px; font-weight: 700; color: var(--text-title); }
        .style-custom-close-btn { width: 32px; height: 32px; border: none; background: var(--bg-canvas); border-radius: 50%; font-size: 18px; color: var(--text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .style-custom-body { padding: 0; overflow-y: auto; flex: 1; }
        .style-custom-tabs { display: flex; border-bottom: 1px solid rgba(0,0,0,0.06); background: var(--bg-canvas); }
        .style-custom-tab {
            flex: 1;
            padding: 12px 16px;
            border: none;
            background: transparent;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-muted);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: color 0.2s, border-color 0.2s;
        }
        .style-custom-tab.active { color: var(--accent-mood); border-bottom-color: var(--accent-mood); }
        .style-custom-tab-content { display: none; padding: 20px; }
        .style-custom-tab-content.active { display: block; }
        .style-custom-field { margin-bottom: 18px; }
        .style-custom-label { display: block; font-size: 13px; color: var(--text-muted); margin-bottom: 8px; font-weight: 500; }
        .style-custom-input { width: 100%; padding: 10px 14px; border: 1px solid #eee; border-radius: var(--radius); font-size: 14px; box-sizing: border-box; }
        .style-custom-color-row { display: flex; gap: 10px; align-items: center; }
        .style-custom-color-input { width: 60px; height: 40px; border: 1px solid #eee; border-radius: var(--radius); cursor: pointer; flex-shrink: 0; }
        .style-custom-row { display: flex; gap: 12px; }
        .style-custom-row .style-custom-field { flex: 1; margin-bottom: 0; }
        .style-custom-select { width: 100%; padding: 10px 14px; border: 1px solid #eee; border-radius: var(--radius); font-size: 14px; box-sizing: border-box; background: #fff; cursor: pointer; }
        .style-custom-preview {
            margin-top: 20px;
            padding: 20px;
            background: var(--bg-canvas);
            border-radius: var(--radius);
            min-height: 180px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .style-custom-actions { margin: 20px; padding-top: 20px; border-top: 1px solid rgba(0,0,0,0.06); display: flex; gap: 12px; flex-shrink: 0; }
        .style-custom-actions button { flex: 1; padding: 12px; border: none; border-radius: var(--radius); font-size: 14px; font-weight: 600; cursor: pointer; font-family: inherit; }
        .style-custom-save { background: var(--accent-mood); color: #fff; }
        .style-custom-cancel { background: var(--bg-canvas); color: var(--text-muted); }
        .style-custom-section-title { font-size: 15px; font-weight: 600; color: var(--text-title); margin: 20px 0 12px 0; padding-bottom: 8px; border-bottom: 1px solid rgba(0,0,0,0.06); }
        .style-custom-section-title:first-child { margin-top: 0; }
        .pay-modal-body { padding: 20px; }
        .pay-field { margin-bottom: 16px; }
        .pay-field label { display: block; font-size: 13px; color: var(--text-muted); margin-bottom: 6px; }
        .pay-field input { width: 100%; padding: 12px 14px; border: 1px solid #eee; border-radius: var(--radius); font-size: 15px; box-sizing: border-box; }
        .pay-actions { display: flex; gap: 12px; margin-top: 20px; }
        .pay-actions button { flex: 1; padding: 12px; border: none; border-radius: var(--radius); font-size: 14px; font-weight: 600; cursor: pointer; font-family: inherit; }
        .pay-confirm { background: var(--accent-mood); color: #fff; }
        .pay-cancel { background: var(--bg-canvas); color: var(--text-muted); }
        /* 转账卡片 - 微信风格 */
        .chat-msg-transfer-card {
            width: 240px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            background: #ffffff;
            border: 1px solid rgba(0,0,0,0.08);
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .chat-msg-transfer-card:hover { opacity: 0.9; }
        .chat-msg-transfer-card.accepted { opacity: 0.6; cursor: default; }
        .chat-msg-transfer-accepted-hint {
            margin-top: 8px;
            padding: 8px 12px;
            background: rgba(0,0,0,0.05);
            border-radius: 4px;
            font-size: 12px;
            color: #999;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        .chat-msg-transfer-accepted-hint svg {
            width: 14px;
            height: 14px;
            color: #07c160;
        }
        /* 对方发出的"转账已接收"卡片 */
        .chat-msg-transfer-accepted-card {
            width: 240px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            background: #ffffff;
            border: 1px solid rgba(0,0,0,0.08);
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .chat-msg-transfer-accepted-card-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e8f8f0;
            color: #07c160;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .chat-msg-transfer-accepted-card-icon svg { width: 22px; height: 22px; }
        .chat-msg-transfer-accepted-card-info { flex: 1; }
        .chat-msg-transfer-accepted-card-title { font-size: 15px; font-weight: 600; color: #333; }
        .chat-msg-transfer-accepted-card-amount { font-size: 13px; color: #999; margin-top: 4px; }
        .chat-msg-transfer-head {
            padding: 12px 16px;
            background: #ffffff;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .chat-msg-transfer-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #07c160;
        }
        .chat-msg-transfer-icon svg { width: 20px; height: 20px; }
        .chat-msg-transfer-title { font-size: 14px; font-weight: 500; color: #333; }
        .chat-msg-transfer-body { padding: 20px 16px; text-align: center; }
        .chat-msg-transfer-amount { font-size: 36px; font-weight: 500; color: #333; line-height: 1; }
        .chat-msg-transfer-amount .unit { font-size: 20px; font-weight: 500; margin-right: 2px; }
        .chat-msg-transfer-note {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #f0f0f0;
            font-size: 13px; color: #888; line-height: 1.4;
            text-align: left;
        }

        /* 红包卡片 - 微信风格 */
        .chat-msg-redpack-card {
            width: 240px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            background: linear-gradient(180deg, #ff5442 0%, #e53e3e 100%);
            position: relative;
            cursor: pointer;
        }
        .chat-msg-redpack-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 3px;
            background: linear-gradient(90deg, #ff8c42, #ff5442);
        }
        .chat-msg-redpack-head {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #fff;
        }
        .chat-msg-redpack-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
        }
        .chat-msg-redpack-icon svg { width: 20px; height: 20px; }
        .chat-msg-redpack-body {
            padding: 24px 16px;
            text-align: center;
            background: #fff;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .chat-msg-redpack-open-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ffd700 0%, #ffb347 100%);
            border: 3px solid #fff;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: 700;
            color: #c0392b;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            user-select: none;
        }
        .chat-msg-redpack-open-btn:hover { transform: scale(1.05); }
        .chat-msg-redpack-open-btn:active { transform: scale(0.95); }
        .chat-msg-redpack-blessing {
            margin-top: 8px;
            font-size: 12px;
            color: #999;
            line-height: 1.4;
        }
        .chat-msg-redpack-amount {
            font-size: 36px;
            font-weight: 500;
            color: #ff5442;
            line-height: 1;
            display: none;
        }
        .chat-msg-redpack-amount.opened { display: block; }
        .chat-msg-redpack-amount .unit { font-size: 20px; font-weight: 500; margin-right: 2px; }
        .chat-msg-redpack-open-btn.opened { display: none; }
    </style>
</head>
<body>
    <div class="app-wrap">
        <header class="status-bar">
            <div class="status-bar-row">
                <span class="title">纯白人生</span>
                <span class="age-badge" id="ageBadge">0 岁</span>
            </div>
            <div class="date-bar" id="dateBar">2024年 1月 1日</div>
        </header>

        <!-- Tab: 地图 -->
        <div id="tabMap" class="tab-content active">
            <div class="map-viewport">
                <div class="map-layer active" data-map="crib" id="mapCrib"></div>
                <div class="map-layer" data-map="childhood" id="mapChildhood"></div>
                <div class="map-layer" data-map="teen" id="mapTeen"></div>
                <div class="map-layer" data-map="adult" id="mapAdult"></div>
                <div class="map-layer" data-map="midlife" id="mapMidlife"></div>
                <div class="map-layer" data-map="elder" id="mapElder"></div>
            </div>
            <div class="current-loc-bar" id="currentLoc">当前位置：摇篮</div>
            <div class="year-btn-wrap" style="margin-top:12px">
                <button class="year-btn" id="monthBtn">下一月</button>
            </div>
        </div>

        <!-- Tab: 功能 -->
        <div id="tabLife" class="tab-content">
            <div class="life-panel">
                <div class="card">
                    <div class="card-title">人物属性</div>
                    <div class="stats-radar-wrap">
                        <div class="stat-item"><span class="stat-dot health"></span><div><div class="stat-label">体魄</div><div class="stat-value" id="statHealth">100</div></div></div>
                        <div class="stat-item"><span class="stat-dot mood"></span><div><div class="stat-label">心情</div><div class="stat-value" id="statHappiness">100</div></div></div>
                        <div class="stat-item"><span class="stat-dot intel"></span><div><div class="stat-label">智力</div><div class="stat-value" id="statIntel">10</div></div></div>
                        <div class="stat-item"><span class="stat-dot eq"></span><div><div class="stat-label">情商</div><div class="stat-value" id="statEq">10</div></div></div>
                        <div class="stat-item"><span class="stat-dot charm"></span><div><div class="stat-label">魅力</div><div class="stat-value" id="statCharm">50</div></div></div>
                        <div class="stat-item"><span class="stat-dot appearance"></span><div><div class="stat-label">颜值</div><div class="stat-value" id="statAppearance">50</div></div></div>
                        <div class="stat-item" style="grid-column:1/-1"><span class="stat-dot money"></span><div style="flex:1"><div class="stat-label">金钱</div><div class="stat-value" id="statMoney">0</div></div></div>
                    </div>
                    <div class="pressure-bar-wrap">
                        <div class="stat-label">压力</div>
                        <div class="pressure-bar"><div class="pressure-fill" id="pressureFill" style="width:0%"></div></div>
                    </div>
                    <div class="age-specific-wrap" id="ageSpecificWrap"></div>
                </div>
                <div class="card">
                    <div class="card-title timeline-toggle" id="timelineToggle">
                        <span>人生日志</span>
                        <span class="toggle-arrow" id="timelineArrow">▶</span>
                    </div>
                    <div class="timeline-wrap collapsed" id="timelineWrap">
                        <div class="timeline-line"></div>
                        <div id="timelineList"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: 关系 -->
        <div id="tabSocial" class="tab-content">
            <div class="filter-tabs">
                <button class="filter-tab active" data-filter="all" id="relationFilterAll">全部</button>
            </div>
            <div class="relation-list" id="relationList"></div>
        </div>

        <!-- 聊天界面 (点击关系列表某人后进入) -->
        <div class="chat-panel" id="chatPanel">
            <div class="chat-header">
                <button type="button" class="chat-back" id="chatBack" aria-label="返回">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="18" height="18">
                        <path d="M14.5 6L9 12l5.5 6" stroke="#7F8C8D" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                    </svg>
                </button>
                <span class="chat-title" id="chatTitle">聊天</span>
                <button type="button" class="chat-more" id="chatMoreBtn" aria-label="更多">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <rect x="6" y="7" width="12" height="2" rx="1" fill="#95A5A6"/>
                        <rect x="6" y="11" width="12" height="2" rx="1" fill="#95A5A6"/>
                        <rect x="6" y="15" width="12" height="2" rx="1" fill="#95A5A6"/>
                    </svg>
                </button>
            </div>
            <div class="chat-location-share-bar" id="chatLocationShareBar">
                <div class="chat-location-share-info">
                    <div class="chat-location-share-dot"></div>
                    <div>
                        <div class="chat-location-share-text-main" id="chatLocationShareMain">位置共享中</div>
                        <div class="chat-location-share-text-sub" id="chatLocationShareSub">与 Ta 实时共享当前位置</div>
                    </div>
                </div>
                <div class="chat-location-share-action" id="chatLocationShareToggle">结束</div>
            </div>
            <div class="chat-messages" id="chatMessages"></div>
            <input type="file" accept="image/*" id="chatBgFileInput" style="display:none">
            <div class="chat-input-row">
                <button type="button" class="chat-plus-btn" id="chatPlusBtn" aria-label="更多">+</button>
                <div class="chat-plus-menu" id="chatPlusMenu">
                    <div class="chat-plus-menu-grid">
                        <div class="chat-plus-item" data-action="edit-relation">
                            <div class="chat-plus-item-icon">
                                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <rect x="3" y="4" width="18" height="16" rx="3" stroke="currentColor" fill="none"/>
                                    <path d="M8 10h8M8 14h4" stroke="currentColor" stroke-linecap="round"/>
                                </svg>
                            </div>
                            <div class="chat-plus-item-label">编辑角色</div>
                        </div>
                        <div class="chat-plus-item" data-action="emoji">
                            <div class="chat-plus-item-icon">
                                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <circle cx="12" cy="12" r="9" stroke="currentColor" fill="none"/>
                                    <circle cx="9.5" cy="10" r="1.2" fill="currentColor"/>
                                    <circle cx="14.5" cy="10" r="1.2" fill="currentColor"/>
                                    <path d="M9 15.5c1 1.5 2.5 2 3.5 2s2.5-0.5 3.5-2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </div>
                            <div class="chat-plus-item-label">表情包</div>
                        </div>
                        <div class="chat-plus-item" data-action="image">
                            <div class="chat-plus-item-icon">
                                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <rect x="3" y="5" width="18" height="14" rx="2" stroke="currentColor"/>
                                    <path d="M3 15l5-5 4 4 5-5 4 4" stroke="currentColor" fill="none"/>
                                    <circle cx="8" cy="8" r="1.5" fill="currentColor"/>
                                </svg>
                            </div>
                            <div class="chat-plus-item-label">图片</div>
                        </div>
                        <div class="chat-plus-item" data-action="gift">
                            <div class="chat-plus-item-icon">
                                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <rect x="4" y="7" width="16" height="12" rx="1" stroke="currentColor"/>
                                    <path d="M12 7v12M4 11h16" stroke="currentColor"/>
                                    <path d="M9 7V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v3" stroke="currentColor"/>
                                </svg>
                            </div>
                            <div class="chat-plus-item-label">礼物</div>
                        </div>
                        <div class="chat-plus-item" data-action="transfer">
                            <div class="chat-plus-item-icon">
                                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <circle cx="12" cy="12" r="9" stroke="currentColor"/>
                                    <path d="M8 12h8M12 8l4 4-4 4" stroke="currentColor" fill="none"/>
                                </svg>
                            </div>
                            <div class="chat-plus-item-label">转账</div>
                        </div>
                        <div class="chat-plus-item" data-action="redpack">
                            <div class="chat-plus-item-icon">
                                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <rect x="4" y="6" width="16" height="12" rx="1" stroke="currentColor"/>
                                    <path d="M4 10h16M12 6v12" stroke="currentColor"/>
                                    <path d="M8 14h8" stroke="currentColor"/>
                                </svg>
                            </div>
                            <div class="chat-plus-item-label">红包</div>
                        </div>
                        <div class="chat-plus-item" data-action="send-location">
                            <div class="chat-plus-item-icon">
                                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12 3.5c-3 0-5.5 2.4-5.5 5.5 0 4.1 4.6 8.6 5.1 9.1.2.2.6.2.8 0 .5-.5 5.1-5 5.1-9.1 0-3.1-2.5-5.5-5.5-5.5z" stroke="currentColor" fill="none"/>
                                    <circle cx="12" cy="9" r="2" stroke="currentColor" fill="none"/>
                                </svg>
                            </div>
                            <div class="chat-plus-item-label">发送位置</div>
                        </div>
                        <div class="chat-plus-item" data-action="share-location">
                            <div class="chat-plus-item-icon">
                                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <circle cx="8" cy="12" r="3" stroke="currentColor" fill="none"/>
                                    <circle cx="16" cy="12" r="3" stroke="currentColor" fill="none"/>
                                    <path d="M11 12h2" stroke="currentColor"/>
                                </svg>
                            </div>
                            <div class="chat-plus-item-label">位置共享</div>
                        </div>
                        <div class="chat-plus-item" data-action="voice-call">
                            <div class="chat-plus-item-icon">
                                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M7 5l3-2h4l3 2v6c0 3.3-2.7 6-6 6s-6-2.7-6-6V5z" stroke="currentColor" fill="none"/>
                                    <path d="M10 9v2M14 9v2" stroke="currentColor"/>
                                </svg>
                            </div>
                            <div class="chat-plus-item-label">语音通话</div>
                        </div>
                        <div class="chat-plus-item" data-action="video-call">
                            <div class="chat-plus-item-icon">
                                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <rect x="4" y="6" width="11" height="12" rx="2" stroke="currentColor" fill="none"/>
                                    <path d="M15 10l4-2v8l-4-2z" stroke="currentColor" fill="none"/>
                                </svg>
                            </div>
                            <div class="chat-plus-item-label">视频通话</div>
                        </div>
                        <div class="chat-plus-item" data-action="share-contact">
                            <div class="chat-plus-item-icon">
                                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <rect x="4" y="4" width="16" height="16" rx="2" stroke="currentColor" fill="none"/>
                                    <circle cx="12" cy="10" r="2" stroke="currentColor" fill="none"/>
                                    <path d="M8 16c.7-1.3 2-2 4-2s3.3.7 4 2" stroke="currentColor" fill="none"/>
                                </svg>
                            </div>
                            <div class="chat-plus-item-label">分享好友名片</div>
                        </div>
                        <div class="chat-plus-item" data-action="share-music">
                            <div class="chat-plus-item-icon">
                                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M10 5v10a2 2 0 11-2-2" stroke="currentColor" fill="none"/>
                                    <path d="M10 5l7-2v10a2 2 0 11-2-2" stroke="currentColor" fill="none"/>
                                </svg>
                            </div>
                            <div class="chat-plus-item-label">分享音乐</div>
                        </div>
                        <div class="chat-plus-item" data-action="listen-together">
                            <div class="chat-plus-item-icon">
                                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <circle cx="8" cy="14" r="2" stroke="currentColor" fill="none"/>
                                    <circle cx="16" cy="14" r="2" stroke="currentColor" fill="none"/>
                                    <path d="M8 12V7l8-3v8" stroke="currentColor" fill="none"/>
                                </svg>
                            </div>
                            <div class="chat-plus-item-label">一起听</div>
                        </div>
                    </div>
                </div>
                <input type="text" class="chat-input" id="chatInput" placeholder="输入消息..." maxlength="500" autocomplete="off">
                <div class="chat-send-wrap">
                    <button type="button" class="chat-send" id="chatSend">发送</button>
                    <span class="chat-send-icon" aria-hidden="true">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 20.5c-.3 0-.6-.1-.8-.3C9.5 18.2 3 13 3 8c0-3.3 2.7-6 6-6 1.6 0 3.1.6 4.2 1.8L12 6.5l1.8-2.7C14.9 2.6 16.4 2 18 2c3.3 0 6 2.7 6 6 0 5-6.5 10.2-8.2 12.2-.2.2-.5.3-.8.3z" fill="none"/>
                        </svg>
                    </span>
                </div>
            </div>
        </div>

        <!-- 语音通话界面（P1） -->
        <div class="voice-call-panel" id="voiceCallPanel" aria-hidden="true">
            <div class="voice-call-top">
                <button type="button" class="voice-call-tag" id="voiceCallTagBtn">语音通话</button>
                <div class="voice-call-timer" id="voiceCallTimerText">00:00</div>
            </div>
            <div class="voice-call-middle">
                <div class="voice-call-avatar-wrap" id="voiceCallAvatarWrap">
                    <img id="voiceCallAvatarImg" src="" alt="" style="display:none">
                    <div class="voice-call-avatar-fallback" id="voiceCallAvatarFallback">Ta</div>
                </div>
                <div class="voice-call-name" id="voiceCallName">好友</div>
                <div class="voice-call-status" id="voiceCallStatus">正在为你呼叫中…</div>
                <div class="voice-call-transcript" id="voiceCallTranscript"></div>
                <div class="voice-call-input-row">
                    <input type="text" id="voiceCallInput" class="voice-call-input" placeholder="在语音中说点什么..." maxlength="200">
                    <button type="button" class="voice-call-send-btn" id="voiceCallSendBtn">发送</button>
                    <button type="button" class="voice-call-doodle-btn" id="voiceCallDoodleBtn" aria-label="语音小表情">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="12" cy="12" r="9" fill="none" stroke="currentColor" stroke-width="1.5"/>
                            <path d="M8.5 15.5c1.3-1 2.7-1.4 3.8-1.3 1.1.1 2.2.7 3.2 1.8" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                            <path d="M9 10.2c.3-.4.7-.6 1.1-.6.4 0 .8.2 1.1.6" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                            <path d="M12.8 9.8c.3-.4.7-.6 1.1-.6.4 0 .8.2 1.1.6" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="voice-call-bottom">
                <button type="button" class="voice-call-btn hangup" id="voiceCallHangupBtn" aria-label="挂断">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M4 15c1.8-1.9 4.9-3 8-3s6.2 1.1 8 3" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        <path d="M7 16.5L4 19M17 16.5L20 19" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- 语音通话样式弹窗 -->
        <div class="modal-overlay" id="voiceCallStyleOverlay"></div>
        <div class="pay-modal" id="voiceCallStyleModal">
            <div class="pay-modal-title">
                <span>语音通话样式</span>
            </div>
            <div class="pay-modal-body">
                <div class="pay-field">
                    <label>通话背景</label>
                    <button type="button" class="album-pick-btn" id="voiceCallBgPickBtn">从相册选择背景</button>
                </div>
                <div class="pay-field">
                    <label>聊天框背景颜色</label>
                    <input type="color" id="voiceCallTranscriptBgInput" value="#111827">
                </div>
                <div class="pay-field">
                    <label>聊天框文字颜色</label>
                    <input type="color" id="voiceCallTranscriptColorInput" value="#e5e7eb">
                </div>
                <div class="pay-field">
                    <label>输入框背景颜色</label>
                    <input type="color" id="voiceCallInputBgInput" value="#020617">
                </div>
                <div class="pay-field">
                    <label>输入框文字颜色</label>
                    <input type="color" id="voiceCallInputColorInput" value="#e5e7eb">
                </div>
                <div class="pay-actions">
                    <button type="button" class="pay-cancel" id="voiceCallStyleCancelBtn">取消</button>
                    <button type="button" class="pay-confirm" id="voiceCallStyleConfirmBtn">保存</button>
                </div>
            </div>
        </div>

        <input type="file" id="voiceCallBgFileInput" accept="image/*" style="display:none">

        <!-- 音乐界面 -->
        <div class="music-panel" id="musicPanel">
            <div class="music-header">
                <button type="button" class="music-back" id="musicBackBtn" aria-label="返回">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="18" height="18">
                        <path d="M14.5 6L9 12l5.5 6" stroke="#7F8C8D" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                    </svg>
                </button>
                <div class="music-search-wrap">
                    <input type="text" class="music-search-input" id="musicSearchInput" placeholder="搜索歌曲 / 歌手..." autocomplete="off">
                    <button type="button" class="music-search-btn" id="musicSearchBtn">搜索</button>
                </div>
            </div>
            <div class="music-body">
                <div class="music-empty-hint" id="musicEmptyHint">输入关键词搜索你想分享的音乐</div>
                <div class="music-loading-hint" id="musicLoadingHint" style="display:none">正在搜索音乐...</div>
                <div class="music-list" id="musicList"></div>
            </div>
        </div>

        <audio id="musicPreviewAudio"></audio>

        <!-- 礼物界面 -->
        <div class="gift-panel" id="giftPanel">
            <div class="gift-header">
                <button type="button" class="gift-back" id="giftBackBtn" aria-label="返回">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="18" height="18">
                        <path d="M14.5 6L9 12l5.5 6" stroke="#7F8C8D" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                    </svg>
                </button>
                <div class="gift-search-wrap">
                    <input type="text" class="gift-search-input" id="giftSearchInput" placeholder="搜索礼物..." autocomplete="off">
                    <button type="button" class="gift-search-btn" id="giftSearchBtn" aria-label="搜索" title="搜索">
                        <svg class="gift-search-svg" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="22" height="22" style="stroke:var(--text-muted);stroke-width:1.8;fill:none;stroke-linecap:round;stroke-linejoin:round">
                            <circle cx="11" cy="11" r="7"/>
                            <path d="M16 16l4 4"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="gift-grid-wrap">
                <div class="gift-grid" id="giftGrid"></div>
                <div class="gift-empty" id="giftEmptyHint">输入关键词后点击右侧搜索，获取礼物推荐</div>
                <div class="gift-loading" id="giftLoadingHint" style="display:none;">正在搜索...</div>
            </div>
        </div>

        <!-- 礼物详情弹窗 -->
        <div class="gift-detail-overlay" id="giftDetailOverlay">
            <div class="gift-detail-modal" id="giftDetailModal">
                <img class="gift-detail-pic" id="giftDetailPic" src="" alt="">
                <div class="gift-detail-body">
                    <div class="gift-detail-name" id="giftDetailName"></div>
                    <div class="gift-detail-price" id="giftDetailPrice"></div>
                    <div class="gift-detail-desc" id="giftDetailDesc"></div>
                    <div class="gift-detail-actions">
                        <button type="button" class="gift-detail-cancel" id="giftDetailCancelBtn">取消</button>
                        <button type="button" class="gift-detail-send" id="giftDetailSendBtn">购买送给该好友</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: 朋友圈 -->
        <div id="tabMoments" class="tab-content">
            <div class="moments-feed" id="momentsFeed">
                <div class="moments-empty">暂无动态，生活点滴将在此记录</div>
            </div>
        </div>

        <!-- Tab: 设置 -->
        <div id="tabSettings" class="tab-content">
            <div class="card-title" style="margin-bottom:16px">存档管理</div>
            <div class="save-slots" id="saveSlots"></div>
            <div class="api-section">
                <div class="card-title" style="margin-bottom:12px">API 配置</div>
                <div class="card" id="apiConfigPanel">
                    <div class="api-field">
                        <label>API Host</label>
                        <input type="text" class="api-input" id="apiHost" placeholder="https://api.openai.com/v1/chat/completions">
                    </div>
                    <div class="api-field">
                        <label>API Key</label>
                        <input type="password" class="api-input" id="apiKey" placeholder="sk-...">
                    </div>
                    <div class="api-field">
                        <label>Model</label>
                        <div class="model-row">
                            <input type="text" class="api-input" id="apiModel" placeholder="gpt-3.5-turbo" style="flex:1">
                            <button type="button" class="api-fetch-btn" id="apiFetchModels">获取</button>
                        </div>
                        <div class="model-list" id="modelList"></div>
                    </div>
                    <div class="api-field">
                        <label>Pexels API Key（选填，用于礼物图片）</label>
                        <input type="password" class="api-input" id="pexelsKey" placeholder="在 pexels.com/api 免费获取">
                    </div>
                </div>
            </div>
            <button class="reincarnate-btn" id="reincarnateBtn">重开人生</button>
        </div>
    </div>

    <!-- 重开人生弹窗 -->
    <div class="modal-overlay" id="reincarnateOverlay"></div>
    <div class="reincarnate-modal" id="reincarnateModal">
        <div class="reincarnate-header">
            <div class="reincarnate-title">重开人生</div>
            <div class="reincarnate-desc">选择你的重生方式</div>
        </div>
        <div class="reincarnate-options">
            <div class="reincarnate-opt disabled" id="reincOptDescendant">
                <div>继承自己的后代</div>
                <div class="reincarnate-opt-sub" id="reincDescHint">暂无后代可继承</div>
            </div>
            <div class="reincarnate-opt" id="reincOptFresh">
                <div>全新人生</div>
                <div class="reincarnate-opt-sub">从零开始，性别随机</div>
            </div>
            <div class="reincarnate-opt" id="reincOptInherit">
                <div>继承属性重生</div>
                <div class="reincarnate-opt-sub">保留本世属性，开启新人生</div>
            </div>
        </div>
    </div>

    <!-- 底部 Dock 手绘风格 -->
    <nav class="dock">
        <button class="dock-item active" data-tab="map"><span class="dock-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M5 10L12 4l7 6v10H5z"/><path d="M9 14l3-3 3 3"/><path d="M12 11v6"/></svg></span>地图</button>
        <button class="dock-item" data-tab="life"><span class="dock-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M6 4h12v16H6z"/><path d="M9 8h6M9 12h6M9 16h4"/></svg></span>功能</button>
        <button class="dock-item" data-tab="social"><span class="dock-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M8 14c-2 1-4 2-6 2"/><path d="M16 14c2 1 4 2 6 2"/><circle cx="9" cy="8" r="3"/><circle cx="15" cy="8" r="3"/><path d="M9 11c1 2 3 3 6 3s5-1 6-3"/></svg></span>关系</button>
        <button class="dock-item" data-tab="moments"><span class="dock-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 4h16v16H4z"/><path d="M4 8h16M4 12h12M4 16h8"/></svg></span>朋友圈</button>
        <button class="dock-item" data-tab="settings"><span class="dock-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 15a3 3 0 100-6 3 3 0 000 6z"/><path d="M19 12h1.5M3.5 12H5M19 4l-1 1M6 19l-1 1M19 19l-1-1M6 5L5 6"/></svg></span>设置</button>
    </nav>

    <!-- 交互卡片模态 -->
    <div class="modal-overlay" id="modalOverlay"></div>
    <div class="interact-modal" id="interactModal">
        <button class="close-btn" id="closeModal">×</button>
        <div id="interactContent"></div>
    </div>

    <!-- 个人档案弹窗 -->
    <div class="modal-overlay" id="profileOverlay"></div>
    <div class="profile-modal" id="profileModal">
        <div class="profile-modal-header">
            <div class="profile-modal-title">我的档案</div>
            <div class="profile-avatar-wrap" id="profileAvatarWrap">
                <img id="profileAvatarImg" src="" alt="" style="display:none">
                <div class="avatar-placeholder" id="profileAvatarPlaceholder" aria-hidden="true">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="26" height="26">
                        <circle cx="12" cy="8" r="3.2" fill="none" stroke="currentColor" stroke-width="1.8"/>
                        <path d="M5.5 20c1.4-3.3 4-5 6.5-5s5.1 1.7 6.5 5" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
                    </svg>
                </div>
            </div>
            <input type="file" id="profileAvatarInput" accept="image/*">
        </div>
        <div class="profile-modal-body">
            <div class="profile-info-row">
                <div class="profile-info-item"><div class="profile-field-label">年龄</div><div class="val" id="profileAgeVal">0 岁</div></div>
                <div class="profile-info-item"><div class="profile-field-label">性别</div><div class="val" id="profileGenderVal">女</div></div>
            </div>
            <div class="profile-field">
                <label class="profile-field-label">背景 · 人设</label>
                <textarea class="profile-bg-input" id="profileBgInput" placeholder="写下你的出身、性格、理想..."></textarea>
            </div>
            <div class="profile-modal-actions">
                <button class="profile-cancel-btn" id="profileCancelBtn">取消</button>
                <button class="profile-save-btn" id="profileSaveBtn">保存</button>
            </div>
        </div>
    </div>

    <!-- 关系编辑弹窗 -->
    <div class="modal-overlay" id="relationOverlay"></div>
    <div class="profile-modal" id="relationModal">
        <div class="profile-modal-header">
            <div class="profile-modal-title">关系编辑</div>
            <div class="profile-avatar-wrap" id="relationAvatarWrap">
                <img id="relationAvatarImg" src="" alt="" style="display:none">
                <div class="avatar-placeholder" id="relationAvatarPlaceholder" aria-hidden="true">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="26" height="26">
                        <circle cx="9" cy="9" r="2.6" fill="none" stroke="currentColor" stroke-width="1.8"/>
                        <circle cx="16" cy="10" r="2.2" fill="none" stroke="currentColor" stroke-width="1.8"/>
                        <path d="M3.8 20c1.2-3 3.3-4.6 5.6-4.6s4.4 1.6 5.6 4.6" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
                        <path d="M13.2 20c.7-1.9 2-3 3.7-3 1.8 0 3.2 1.2 3.7 3" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
                    </svg>
                </div>
            </div>
            <input type="file" id="relationAvatarInput" accept="image/*">
        </div>
        <div class="profile-modal-body">
            <div class="profile-field">
                <label class="profile-field-label">名字</label>
                <input type="text" id="relationNameInput" placeholder="原始名字" style="width:100%;padding:10px 14px;border:1px solid #eee;border-radius:var(--radius);font-size:14px;font-family:inherit;background:var(--bg-canvas);outline:none">
            </div>
            <div class="profile-field">
                <label class="profile-field-label">备注名（优先显示）</label>
                <input type="text" id="relationRemarkInput" placeholder="可为空" style="width:100%;padding:10px 14px;border:1px solid #eee;border-radius:var(--radius);font-size:14px;font-family:inherit;background:var(--bg-canvas);outline:none">
            </div>
            <div class="profile-info-row">
                <div class="profile-info-item">
                    <div class="profile-field-label">年龄</div>
                    <div class="val">
                        <input type="number" id="relationAgeInput" min="0" max="120" style="width:100%;border:none;background:transparent;font-size:14px;color:var(--text-title);outline:none;text-align:center">
                    </div>
                </div>
                <div class="profile-info-item">
                    <div class="profile-field-label">好感度</div>
                    <div class="val">
                        <input type="number" id="relationAffinityInput" min="0" max="100" style="width:100%;border:none;background:transparent;font-size:14px;color:var(--text-title);outline:none;text-align:center">
                    </div>
                </div>
            </div>
            <div class="profile-field">
                <label class="profile-field-label">ID 号</label>
                <input type="text" id="relationDisplayIdInput" placeholder="留空将自动生成 1~10 位数字" style="width:100%;padding:10px 14px;border:1px solid #eee;border-radius:var(--radius);font-size:14px;font-family:inherit;background:var(--bg-canvas);outline:none">
            </div>
            <div class="profile-field">
                <label class="profile-field-label">相遇时间</label>
                <input type="text" id="relationMeetTimeInput" placeholder="例如：2024-06-01 晚上" style="width:100%;padding:10px 14px;border:1px solid #eee;border-radius:var(--radius);font-size:14px;font-family:inherit;background:var(--bg-canvas);outline:none">
            </div>
            <div class="profile-field">
                <label class="profile-field-label">性格标签</label>
                <input type="text" id="relationPersonalityInput" placeholder="如：温柔内向、乐观话痨..." style="width:100%;padding:10px 14px;border:1px solid #eee;border-radius:var(--radius);font-size:14px;font-family:inherit;background:var(--bg-canvas);outline:none">
            </div>
            <div class="profile-field">
                <label class="profile-field-label">背景 · 故事</label>
                <textarea class="profile-bg-input" id="relationBgInput" placeholder="写下你们的相处故事、关系设定…"></textarea>
            </div>
            <div class="profile-modal-actions">
                <button class="profile-cancel-btn" id="relationCancelBtn">取消</button>
                <button class="profile-save-btn" id="relationSaveBtn">保存</button>
            </div>
        </div>
    </div>

    <!-- 聊天设置弹窗 -->
    <div class="modal-overlay" id="chatSettingsOverlay"></div>
    <div class="profile-modal" id="chatSettingsModal">
        <div class="profile-modal-header">
            <div class="chat-settings-header-row">
                <button type="button" class="chat-settings-back" id="chatSettingsBackBtn" aria-label="返回">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="18" height="18">
                        <path d="M14.5 6L9 12l5.5 6" stroke="#7F8C8D" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                    </svg>
                </button>
                <div class="chat-settings-title-text">聊天设置</div>
            </div>
        </div>
        <div class="profile-modal-body">
            <div class="profile-info-row" style="margin-bottom:20px;align-items:center;cursor:pointer;">
                <div class="profile-info-item" style="display:flex;align-items:center;gap:12px;background:transparent;padding:0;">
                    <div class="relation-avatar" style="width:44px;height:44px;box-shadow:var(--shadow-card);flex-shrink:0;">
                        <img id="chatSettingsAvatarImg" src="" alt="" style="width:100%;height:100%;border-radius:50%;object-fit:cover;display:none;">
                        <div id="chatSettingsAvatarPlaceholder" style="width:100%;height:100%;border-radius:50%;display:flex;align-items:center;justify-content:center;background:#fff;color:var(--text-title);font-weight:700;">?</div>
                    </div>
                    <div>
                        <div id="chatSettingsName" style="font-size:15px;color:var(--text-title);font-weight:600;">昵称</div>
                        <div id="chatSettingsSub" style="font-size:12px;color:var(--text-muted);margin-top:2px;">聊天信息</div>
                    </div>
                </div>
            </div>
            <div class="profile-field" style="margin-bottom:18px;margin-top:4px;">
                <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 0 12px 0;border-bottom:1px solid rgba(0,0,0,0.03);border-top:1px solid rgba(0,0,0,0.03);cursor:pointer;">
                    <span style="font-size:14px;color:var(--text-title);">查找聊天记录</span>
                    <span style="font-size:12px;color:var(--text-muted);">图片、视频、文件等</span>
                </div>
            </div>
            <div class="profile-field" style="margin-bottom:6px;">
                <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid rgba(0,0,0,0.03);">
                    <span style="font-size:14px;color:var(--text-title);">设为置顶</span>
                    <label class="chat-switch" id="chatSettingsPinSwitch">
                        <input type="checkbox" id="chatSettingsPinToggle" style="opacity:0;width:0;height:0;">
                        <span class="chat-switch-thumb" id="chatSettingsPinThumb"></span>
                    </label>
                </div>
            </div>
            <div class="profile-field" style="margin-bottom:6px;">
                <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid rgba(0,0,0,0.03);">
                    <span style="font-size:14px;color:var(--text-title);">设为特别关心</span>
                    <label class="chat-switch" id="chatSettingsStarSwitch">
                        <input type="checkbox" id="chatSettingsStarToggle" style="opacity:0;width:0;height:0;">
                        <span class="chat-switch-thumb" id="chatSettingsStarThumb"></span>
                    </label>
                </div>
            </div>
            <div class="profile-field" style="margin-bottom:6px;">
                <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid rgba(0,0,0,0.03);">
                    <span style="font-size:14px;color:var(--text-title);">消息免打扰</span>
                    <label class="chat-switch" id="chatSettingsMuteSwitch">
                        <input type="checkbox" id="chatSettingsMuteToggle" style="opacity:0;width:0;height:0;">
                        <span class="chat-switch-thumb" id="chatSettingsMuteThumb"></span>
                    </label>
                </div>
            </div>
            <div class="profile-field" style="margin-bottom:6px;">
                <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid rgba(0,0,0,0.03);cursor:pointer;">
                    <span style="font-size:14px;color:var(--text-title);">消息通知设置</span>
                    <span style="font-size:12px;color:var(--text-muted);">通知预览、提示音等</span>
                </div>
            </div>
            <div class="profile-field" style="margin-bottom:6px;">
                <div id="chatSettingsBgRow" style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid rgba(0,0,0,0.03);cursor:pointer;">
                    <span style="font-size:14px;color:var(--text-title);">设置当前聊天背景</span>
                    <span style="font-size:12px;color:var(--text-muted);">></span>
                </div>
            </div>
            <div class="profile-field" style="margin-top:12px;">
                <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-top:1px solid rgba(0,0,0,0.04);color:#e74c3c;cursor:pointer;">
                    <span style="font-size:14px;">删除聊天记录</span>
                </div>
            </div>
        </div>
    </div>

    <!-- 表情包弹窗 -->
    <div class="modal-overlay" id="stickerPickerOverlay"></div>
    <div class="sticker-picker-modal" id="stickerPickerModal">
        <div class="sticker-picker-header">
            <span class="sticker-picker-title">表情包</span>
            <button type="button" class="sticker-picker-close" id="stickerPickerClose">×</button>
        </div>
        <div class="sticker-picker-body">
            <div class="sticker-section-title">我的表情包 <button type="button" class="sticker-section-add" id="stickerAddSelf">+</button></div>
            <div class="sticker-grid" id="stickerGridSelf"></div>
            <div class="sticker-section-title" id="stickerSectionRelationTitle">TA的表情包 <button type="button" class="sticker-section-add" id="stickerAddRelation">+</button></div>
            <div class="sticker-grid" id="stickerGridRelation"></div>
        </div>
    </div>

    <!-- 个人相册（添加表情包） -->
    <div class="modal-overlay" id="albumOverlay"></div>
    <div class="album-modal" id="albumModal">
        <div class="album-modal-header">个人相册</div>
        <div class="album-modal-body">
            <div class="album-pick-wrap">
                <button type="button" class="album-pick-btn" id="albumPickBtn">从相册选择图片</button>
                <img class="album-preview" id="albumPreview" alt="">
            </div>
            <label class="album-desc-label">表情包描述（选填）</label>
            <input type="text" class="album-desc-input" id="albumDescInput" placeholder="自定义填写描述...">
            <div class="album-actions">
                <button type="button" class="album-cancel" id="albumCancelBtn">取消</button>
                <button type="button" class="album-confirm" id="albumConfirmBtn">确定添加</button>
            </div>
        </div>
        <input type="file" id="stickerAlbumFileInput" accept="image/*">
    </div>

    <!-- 发送图片弹窗 -->
    <div class="modal-overlay" id="imageSendOverlay"></div>
    <div class="image-send-modal" id="imageSendModal">
        <div class="image-send-header">发送图片</div>
        <div class="image-send-body">
            <div class="image-send-pick">
                <button type="button" class="album-pick-btn" id="imageSendPickBtn">导入本地相册</button>
                <img class="image-send-preview" id="imageSendPreview" alt="">
            </div>
            <div class="image-send-desc-hint">相册描述（选填）。可以不填写描述，但部分模型可能无法识别图片内容。</div>
            <input type="text" class="image-send-desc-input" id="imageSendDescInput" placeholder="填写描述有助于模型理解图片...">
            <div class="album-actions" style="margin-top:20px;">
                <button type="button" class="album-cancel" id="imageSendCancelBtn">取消</button>
                <button type="button" class="album-confirm" id="imageSendConfirmBtn">发送</button>
            </div>
        </div>
        <input type="file" id="imageSendFileInput" accept="image/*">
    </div>

    <!-- 转账弹窗 -->
    <div class="modal-overlay" id="transferOverlay"></div>
    <div class="pay-modal" id="transferModal">
        <div class="pay-modal-title">
            <span>转账</span>
            <button type="button" class="pay-modal-style-btn" id="transferStyleBtn" title="样式库">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                    <path d="M2 17l10 5 10-5M2 12l10 5 10-5"/>
                </svg>
            </button>
        </div>
        <div class="pay-modal-body">
            <div class="pay-field">
                <label>金额（元）</label>
                <input type="number" id="transferAmountInput" placeholder="0.00" min="0" step="0.01">
            </div>
            <div class="pay-field">
                <label>备注（选填）</label>
                <input type="text" id="transferNoteInput" placeholder="转账说明">
            </div>
            <div class="pay-actions">
                <button type="button" class="pay-cancel" id="transferCancelBtn">取消</button>
                <button type="button" class="pay-confirm" id="transferConfirmBtn">确认转账</button>
            </div>
        </div>
    </div>

    <!-- 红包弹窗 -->
    <div class="modal-overlay" id="redpackOverlay"></div>
    <div class="pay-modal" id="redpackModal">
        <div class="pay-modal-title">
            <span>发红包</span>
            <button type="button" class="pay-modal-style-btn" id="redpackStyleBtn" title="样式库">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                    <path d="M2 17l10 5 10-5M2 12l10 5 10-5"/>
                </svg>
            </button>
        </div>
        <div class="pay-modal-body">
            <div class="pay-field">
                <label>金额（元）</label>
                <input type="number" id="redpackAmountInput" placeholder="0.00" min="0" step="0.01">
            </div>
            <div class="pay-field">
                <label>祝福语（选填）</label>
                <input type="text" id="redpackBlessingInput" placeholder="恭喜发财，大吉大利">
            </div>
            <div class="pay-actions">
                <button type="button" class="pay-cancel" id="redpackCancelBtn">取消</button>
                <button type="button" class="pay-confirm" id="redpackConfirmBtn">塞进红包</button>
            </div>
        </div>
    </div>

    <!-- 发送位置弹窗 -->
    <div class="modal-overlay" id="locationOverlay"></div>
    <div class="location-modal" id="locationModal">
        <div class="location-header">
            <div class="location-header-icon" aria-hidden="true">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="18" height="18">
                    <path d="M12 3.5c-3 0-5.5 2.4-5.5 5.5 0 4.1 4.6 8.6 5.1 9.1.2.2.6.2.8 0 .5-.5 5.1-5 5.1-9.1 0-3.1-2.5-5.5-5.5-5.5z" fill="none" stroke="currentColor" stroke-width="1.6"/>
                    <circle cx="12" cy="9" r="2.1" fill="none" stroke="currentColor" stroke-width="1.6"/>
                </svg>
            </div>
            <div class="location-header-text">
                <div class="location-header-title">发送位置</div>
                <div class="location-header-sub">实时获取当前位置，也可以手动微调坐标</div>
            </div>
        </div>
        <div class="location-body">
            <div class="location-status" id="locationStatus">点击“获取当前位置”以使用真实地理位置。</div>
            <div class="location-fields-row">
                <div class="location-field">
                    <label for="locationLatInput">纬度</label>
                    <input type="number" id="locationLatInput" step="0.000001" placeholder="例如 39.904211">
                </div>
                <div class="location-field">
                    <label for="locationLngInput">经度</label>
                    <input type="number" id="locationLngInput" step="0.000001" placeholder="例如 116.407395">
                </div>
            </div>
            <div class="location-field" style="margin-bottom:10px;">
                <label for="locationLabelInput">位置名称（可选）</label>
                <input type="text" id="locationLabelInput" placeholder="例如：家、公司、某个商场">
            </div>
            <div class="location-map-wrap">
                <div class="location-map-label">位置预览 · 实时地图</div>
                <canvas id="locationMapCanvas" class="location-map-canvas" title="位置预览"></canvas>
            </div>
            <div class="location-actions">
                <button type="button" class="location-secondary" id="locationCancelBtn">取消</button>
                <button type="button" class="location-secondary" id="locationRefreshBtn">获取当前位置</button>
                <button type="button" class="location-primary" id="locationSendBtn">发送位置</button>
            </div>
        </div>
    </div>

    <!-- 转账样式库 -->
    <div class="modal-overlay" id="transferStyleOverlay"></div>
    <div class="style-library-modal" id="transferStyleModal">
        <div class="style-library-header">
            <span class="style-library-title">转账样式库</span>
            <div class="style-library-header-right">
                <button type="button" class="style-library-add-btn" id="transferStyleAddBtn">+</button>
                <button type="button" class="style-library-close-btn" id="transferStyleCloseBtn">×</button>
            </div>
        </div>
        <div class="style-library-body">
            <div class="style-library-grid" id="transferStyleGrid"></div>
        </div>
    </div>

    <!-- 红包样式库 -->
    <div class="modal-overlay" id="redpackStyleOverlay"></div>
    <div class="style-library-modal" id="redpackStyleModal">
        <div class="style-library-header">
            <span class="style-library-title">红包样式库</span>
            <div class="style-library-header-right">
                <button type="button" class="style-library-add-btn" id="redpackStyleAddBtn">+</button>
                <button type="button" class="style-library-close-btn" id="redpackStyleCloseBtn">×</button>
            </div>
        </div>
        <div class="style-library-body">
            <div class="style-library-grid" id="redpackStyleGrid"></div>
        </div>
    </div>

    <!-- 自定义样式弹窗 -->
    <div class="modal-overlay" id="styleCustomOverlay"></div>
    <div class="style-custom-modal" id="styleCustomModal">
        <div class="style-custom-header">
            <span class="style-custom-title" id="styleCustomTitle">自定义样式</span>
            <button type="button" class="style-custom-close-btn" id="styleCustomCloseBtn">×</button>
        </div>
        <div class="style-custom-body">
            <div class="style-custom-tabs">
                <button type="button" class="style-custom-tab active" data-tab="basic">基础样式</button>
                <button type="button" class="style-custom-tab" data-tab="text">文字样式</button>
                <button type="button" class="style-custom-tab" data-tab="border">边框阴影</button>
                <button type="button" class="style-custom-tab" data-tab="advanced">高级设置</button>
            </div>
            
            <!-- 基础样式标签页 -->
            <div class="style-custom-tab-content active" id="styleTabBasic">
                <div class="style-custom-field">
                    <label class="style-custom-label">样式名称</label>
                    <input type="text" class="style-custom-input" id="styleCustomNameInput" placeholder="输入样式名称">
                </div>
                <div class="style-custom-section-title">背景设置</div>
                <div class="style-custom-field">
                    <label class="style-custom-label">背景颜色（起始）</label>
                    <div class="style-custom-color-row">
                        <input type="color" class="style-custom-color-input" id="styleCustomColor1Input" value="#ff5442">
                        <input type="text" class="style-custom-input" id="styleCustomColor1Text" placeholder="#ff5442" style="flex:1">
                    </div>
                </div>
                <div class="style-custom-field">
                    <label class="style-custom-label">背景颜色（结束，渐变）</label>
                    <div class="style-custom-color-row">
                        <input type="color" class="style-custom-color-input" id="styleCustomColor2Input" value="#e53e3e">
                        <input type="text" class="style-custom-input" id="styleCustomColor2Text" placeholder="#e53e3e" style="flex:1">
                    </div>
                </div>
                <div class="style-custom-field">
                    <label class="style-custom-label">渐变方向</label>
                    <select class="style-custom-select" id="styleCustomGradientDir">
                        <option value="180deg">从上到下</option>
                        <option value="90deg">从左到右</option>
                        <option value="45deg">左上到右下</option>
                        <option value="135deg">右上到左下</option>
                        <option value="0deg">从下到上</option>
                        <option value="270deg">从右到左</option>
                    </select>
                </div>
                <div class="style-custom-section-title">尺寸设置</div>
                <div class="style-custom-row">
                    <div class="style-custom-field">
                        <label class="style-custom-label">卡片宽度（px）</label>
                        <input type="number" class="style-custom-input" id="styleCustomWidthInput" placeholder="240" min="180" max="320" value="240">
                    </div>
                    <div class="style-custom-field">
                        <label class="style-custom-label">圆角大小（px）</label>
                        <input type="number" class="style-custom-input" id="styleCustomRadiusInput" placeholder="8" min="0" max="30" value="8">
                    </div>
                </div>
            </div>
            
            <!-- 文字样式标签页 -->
            <div class="style-custom-tab-content" id="styleTabText">
                <div class="style-custom-section-title">金额文字</div>
                <div class="style-custom-field">
                    <label class="style-custom-label">金额颜色</label>
                    <div class="style-custom-color-row">
                        <input type="color" class="style-custom-color-input" id="styleCustomAmountColorInput" value="#ff5442">
                        <input type="text" class="style-custom-input" id="styleCustomAmountColorText" placeholder="#ff5442" style="flex:1">
                    </div>
                </div>
                <div class="style-custom-row">
                    <div class="style-custom-field">
                        <label class="style-custom-label">金额字体大小（px）</label>
                        <input type="number" class="style-custom-input" id="styleCustomAmountSizeInput" placeholder="36" min="20" max="60" value="36">
                    </div>
                    <div class="style-custom-field">
                        <label class="style-custom-label">金额单位大小（px）</label>
                        <input type="number" class="style-custom-input" id="styleCustomUnitSizeInput" placeholder="20" min="12" max="30" value="20">
                    </div>
                </div>
                <div class="style-custom-section-title" id="styleCustomTitleSection" style="display:none;">标题文字</div>
                <div class="style-custom-field" id="styleCustomTitleColorField" style="display:none;">
                    <label class="style-custom-label">标题颜色</label>
                    <div class="style-custom-color-row">
                        <input type="color" class="style-custom-color-input" id="styleCustomTitleColorInput" value="#333">
                        <input type="text" class="style-custom-input" id="styleCustomTitleColorText" placeholder="#333" style="flex:1">
                    </div>
                </div>
                <div class="style-custom-field" id="styleCustomTitleSizeField" style="display:none;">
                    <label class="style-custom-label">标题字体大小（px）</label>
                    <input type="number" class="style-custom-input" id="styleCustomTitleSizeInput" placeholder="14" min="10" max="20" value="14">
                </div>
                <div class="style-custom-section-title" id="styleCustomNoteSectionTitle">备注/祝福语文字</div>
                <div class="style-custom-field">
                    <label class="style-custom-label" id="styleCustomNoteLabel">备注颜色</label>
                    <div class="style-custom-color-row">
                        <input type="color" class="style-custom-color-input" id="styleCustomNoteColorInput" value="#888">
                        <input type="text" class="style-custom-input" id="styleCustomNoteColorText" placeholder="#888" style="flex:1">
                    </div>
                </div>
                <div class="style-custom-field">
                    <label class="style-custom-label" id="styleCustomNoteSizeLabel">备注字体大小（px）</label>
                    <input type="number" class="style-custom-input" id="styleCustomNoteSizeInput" placeholder="13" min="10" max="18" value="13">
                </div>
                <div class="style-custom-section-title">图标颜色</div>
                <div class="style-custom-field">
                    <label class="style-custom-label">图标颜色</label>
                    <div class="style-custom-color-row">
                        <input type="color" class="style-custom-color-input" id="styleCustomIconColorInput" value="#07c160">
                        <input type="text" class="style-custom-input" id="styleCustomIconColorText" placeholder="#07c160" style="flex:1">
                    </div>
                </div>
            </div>
            
            <!-- 边框阴影标签页 -->
            <div class="style-custom-tab-content" id="styleTabBorder">
                <div class="style-custom-section-title">边框设置</div>
                <div class="style-custom-row">
                    <div class="style-custom-field">
                        <label class="style-custom-label">边框宽度（px）</label>
                        <input type="number" class="style-custom-input" id="styleCustomBorderWidthInput" placeholder="1" min="0" max="5" value="1">
                    </div>
                    <div class="style-custom-field">
                        <label class="style-custom-label">边框颜色</label>
                        <div class="style-custom-color-row">
                            <input type="color" class="style-custom-color-input" id="styleCustomBorderColorInput" value="#000000">
                            <input type="text" class="style-custom-input" id="styleCustomBorderColorText" placeholder="#000000" style="flex:1">
                        </div>
                    </div>
                </div>
                <div class="style-custom-field">
                    <label class="style-custom-label">边框透明度（0-1）</label>
                    <input type="number" class="style-custom-input" id="styleCustomBorderOpacityInput" placeholder="0.08" min="0" max="1" step="0.01" value="0.08">
                </div>
                <div class="style-custom-section-title">阴影设置</div>
                <div class="style-custom-row">
                    <div class="style-custom-field">
                        <label class="style-custom-label">阴影X偏移（px）</label>
                        <input type="number" class="style-custom-input" id="styleCustomShadowXInput" placeholder="0" min="-20" max="20" value="0">
                    </div>
                    <div class="style-custom-field">
                        <label class="style-custom-label">阴影Y偏移（px）</label>
                        <input type="number" class="style-custom-input" id="styleCustomShadowYInput" placeholder="2" min="-20" max="20" value="2">
                    </div>
                </div>
                <div class="style-custom-row">
                    <div class="style-custom-field">
                        <label class="style-custom-label">阴影模糊（px）</label>
                        <input type="number" class="style-custom-input" id="styleCustomShadowBlurInput" placeholder="8" min="0" max="30" value="8">
                    </div>
                    <div class="style-custom-field">
                        <label class="style-custom-label">阴影扩散（px）</label>
                        <input type="number" class="style-custom-input" id="styleCustomShadowSpreadInput" placeholder="0" min="-10" max="10" value="0">
                    </div>
                </div>
                <div class="style-custom-field">
                    <label class="style-custom-label">阴影颜色</label>
                    <div class="style-custom-color-row">
                        <input type="color" class="style-custom-color-input" id="styleCustomShadowColorInput" value="#000000">
                        <input type="text" class="style-custom-input" id="styleCustomShadowColorText" placeholder="#000000" style="flex:1">
                    </div>
                </div>
                <div class="style-custom-field">
                    <label class="style-custom-label">阴影透明度（0-1）</label>
                    <input type="number" class="style-custom-input" id="styleCustomShadowOpacityInput" placeholder="0.1" min="0" max="1" step="0.01" value="0.1">
                </div>
            </div>
            
            <!-- 高级设置标签页 -->
            <div class="style-custom-tab-content" id="styleTabAdvanced">
                <div class="style-custom-section-title">内边距设置</div>
                <div class="style-custom-row">
                    <div class="style-custom-field">
                        <label class="style-custom-label">头部内边距（px）</label>
                        <input type="number" class="style-custom-input" id="styleCustomHeadPaddingInput" placeholder="12" min="0" max="30" value="12">
                    </div>
                    <div class="style-custom-field">
                        <label class="style-custom-label">身体内边距（px）</label>
                        <input type="number" class="style-custom-input" id="styleCustomBodyPaddingInput" placeholder="20" min="0" max="40" value="20">
                    </div>
                </div>
                <div class="style-custom-section-title">头部设置</div>
                <div class="style-custom-field">
                    <label class="style-custom-label">头部背景色</label>
                    <div class="style-custom-color-row">
                        <input type="color" class="style-custom-color-input" id="styleCustomHeadBgInput" value="#ffffff">
                        <input type="text" class="style-custom-input" id="styleCustomHeadBgText" placeholder="#ffffff" style="flex:1">
                    </div>
                </div>
                <div class="style-custom-field">
                    <label class="style-custom-label">头部边框颜色</label>
                    <div class="style-custom-color-row">
                        <input type="color" class="style-custom-color-input" id="styleCustomHeadBorderInput" value="#f0f0f0">
                        <input type="text" class="style-custom-input" id="styleCustomHeadBorderText" placeholder="#f0f0f0" style="flex:1">
                    </div>
                </div>
                <div class="style-custom-section-title">身体设置</div>
                <div class="style-custom-field">
                    <label class="style-custom-label">身体背景色（红包专用）</label>
                    <div class="style-custom-color-row">
                        <input type="color" class="style-custom-color-input" id="styleCustomBodyBgInput" value="#ffffff">
                        <input type="text" class="style-custom-input" id="styleCustomBodyBgText" placeholder="#ffffff" style="flex:1">
                    </div>
                </div>
                <div class="style-custom-section-title">其他设置</div>
                <div class="style-custom-field">
                    <label class="style-custom-label">图标大小（px）</label>
                    <input type="number" class="style-custom-input" id="styleCustomIconSizeInput" placeholder="24" min="16" max="40" value="24">
                </div>
            </div>
            
            <div class="style-custom-preview" id="styleCustomPreview"></div>
            <div class="style-custom-actions">
                <button type="button" class="style-custom-cancel" id="styleCustomCancelBtn">取消</button>
                <button type="button" class="style-custom-save" id="styleCustomSaveBtn">保存</button>
            </div>
        </div>
    </div>

    <script>
        const MAP_AGE_MAP = { 0: 'crib', 4: 'childhood', 13: 'teen', 19: 'adult', 36: 'midlife', 60: 'elder' };
        const MAP_NAMES = { crib: '摇篮', childhood: '幸福小区', teen: '中学街区', adult: 'CBD商圈', midlife: '都市', elder: '宁静社区' };
        const EVENTS_POOL = [
            '你出生在一个普通的家庭。', '你学会了翻身。', '你开始咿呀学语。', '你迈出了人生的第一步。',
            '你进入了幼儿园。', '你交到了第一个朋友。', '你在绘画比赛中获得了鼓励奖。',
            '你考进了重点小学。', '你和同桌因为一块橡皮吵了一架。', '你在少年宫学会了弹钢琴。',
            '你进入了中学。', '你收到了第一封情书。', '你在期末考试中名列前茅。',
            '你考上了大学。', '你开始了第一份实习。', '你拿到了Offer。',
            '你升职了。', '你在工作中遇到了贵人。', '你买下了人生的第一套房。',
            '你的孩子出生了。', '你参加了孩子的家长会。', '你在股市小赚了一笔。',
            '你退休了。', '你在广场学会了太极。', '你和老友在公园下棋。'
        ];

        const MAP_CELLS = {
            crib: [{n:'摇篮',a:'sleep'},{n:'父母',a:'parent'},{n:'地板',a:'crawl'},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{}],
            childhood: [{n:'家',a:'home'},{n:'小学',a:'school'},{n:'少年宫',a:'palace'},{n:'公园',a:'park'},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{}],
            teen: [{n:'中学',a:'middle'},{n:'网吧',a:'netbar'},{n:'便利店',a:'store'},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{}],
            adult: [{n:'写字楼',a:'cbd'},{n:'4S店',a:'car'},{n:'酒吧',a:'bar'},{n:'医院',a:'hospital'},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{}],
            midlife: [{n:'家长会',a:'meeting'},{n:'投资',a:'invest'},{n:'健身房',a:'gym'},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{}],
            elder: [{n:'广场',a:'square'},{n:'医院',a:'clinic'},{n:'墓园',a:'cemetery'},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{}]
        };
        const MAP_STAGE_NAMES = { crib: '摇篮期', childhood: '童年期', teen: '青春期', adult: '成年都市', midlife: '中年', elder: '暮年' };

        const AGE_SPECIFIC_ATTRS = {
            crib: [{k:'cognition',n:'认知能力'},{k:'language',n:'语言萌芽'},{k:'motor',n:'大运动'},{k:'fineMotor',n:'精细动作'},{k:'security',n:'安全感'}],
            preschool: [{k:'lang',n:'语言表达'},{k:'mathSense',n:'数感'},{k:'social',n:'社交能力'},{k:'art',n:'艺术兴趣'},{k:'physical',n:'体能'}],
            primary: [{k:'chinese',n:'语文'},{k:'math',n:'数学'},{k:'english',n:'英语'},{k:'moral',n:'品德'},{k:'science',n:'科学'},{k:'pe',n:'体育'},{k:'art',n:'艺术'}],
            junior: [{k:'chinese',n:'语文'},{k:'math',n:'数学'},{k:'english',n:'英语'},{k:'physics',n:'物理'},{k:'chemistry',n:'化学'},{k:'bio',n:'生物'},{k:'politics',n:'政治'},{k:'history',n:'历史'},{k:'geo',n:'地理'},{k:'pe',n:'体育'}],
            senior: [{k:'chinese',n:'语文'},{k:'math',n:'数学'},{k:'english',n:'英语'},{k:'physics',n:'物理'},{k:'chemistry',n:'化学'},{k:'bio',n:'生物'},{k:'politics',n:'政治'},{k:'history',n:'历史'},{k:'geo',n:'地理'},{k:'pe',n:'体育'}],
            university: [{k:'major',n:'专业成绩'},{k:'credit',n:'学分'},{k:'club',n:'社团参与'},{k:'intern',n:'实习经验'},{k:'thesis',n:'论文'}],
            career: [{k:'exp',n:'工作经验'},{k:'skill',n:'专业技能'},{k:'network',n:'人脉'},{k:'performance',n:'业绩'},{k:'position',n:'职位等级'}],
            midlife: [{k:'family',n:'家庭责任'},{k:'career',n:'职业成就'},{k:'healthMgmt',n:'健康管理'},{k:'investment',n:'投资理财'},{k:'childEdu',n:'子女教育'}],
            elder: [{k:'health',n:'健康状况'},{k:'quality',n:'生活质量'},{k:'childRel',n:'子女关系'},{k:'socialJoin',n:'社会参与'}]
        };
        function getAgeStage(age) {
            if (age <= 3) return 'crib';
            if (age <= 6) return 'preschool';
            if (age <= 12) return 'primary';
            if (age <= 15) return 'junior';
            if (age <= 18) return 'senior';
            if (age <= 22) return 'university';
            if (age <= 35) return 'career';
            if (age <= 60) return 'midlife';
            return 'elder';
        }

        let gameState = {
            meta: { currentAge: 0, currentYear: 2024, currentMonth: 1, currentDay: 1, isAlive: true, causeOfDeath: null },
            profile: { avatar: '', gender: 'female', background: '' },
            stats: { health: 100, happiness: 100, money: 0, intelligence: 10, eq: 10, charm: 50, appearance: 50, pressure: 0, ageSpecific: {} },
            activeMapId: 'map_crib',
            descendants: [],
            relations: [
                { id: 'npc_001', role: 'father', name: '父亲', age: 28, affinity: 50, category: 'family' },
                { id: 'npc_002', role: 'mother', name: '母亲', age: 26, affinity: 50, category: 'family' }
            ],
            relationGroups: ['family','lover','work','enemy'],
            chatLogs: {},
            inventory: { items: [], properties: [], jobs: [] },
            historyLog: [{ age: 0, month: 1, text: '你出生了。人生如白纸，等待被描绘。', source: 'local' }]
        };

        let userSettings = {
            api: { endpoint: 'https://api.openai.com/v1/chat/completions', key: '', model: 'gpt-3.5-turbo' },
            pexelsKey: ''
        };

        function getMapId(age) {
            let id = 'crib';
            for (const [a, m] of Object.entries(MAP_AGE_MAP)) {
                if (age >= parseInt(a)) id = m;
            }
            return id;
        }

        function renderMapGrids() {
            ['crib','childhood','teen','adult','midlife','elder'].forEach(mapId => {
                const el = document.getElementById('map' + mapId.charAt(0).toUpperCase() + mapId.slice(1));
                if (!el) return;
                const cells = MAP_CELLS[mapId] || [];
                let html = '<div class="map-grid">';
                for (let i = 0; i < 20; i++) {
                    const c = cells[i] || {};
                    if (c.n) {
                        html += `<div class="map-cell" data-act="${c.a}"><span class="map-cell-icon">▦</span><span class="map-cell-name">${c.n}</span></div>`;
                    } else {
                        html += `<div class="map-cell map-cell-empty"></div>`;
                    }
                }
                html += '</div><div class="map-stage-title">' + (MAP_STAGE_NAMES[mapId] || '') + '</div>';
                el.innerHTML = html;
            });
            document.querySelectorAll('.map-cell[data-act]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const act = btn.dataset.act;
                    const names = {sleep:'摇篮',parent:'父母',crawl:'地板',home:'家',school:'小学',palace:'少年宫',park:'公园',middle:'中学',netbar:'网吧',store:'便利店',cbd:'写字楼',car:'4S店',bar:'酒吧',hospital:'医院',meeting:'家长会',invest:'投资',gym:'健身房',square:'广场',clinic:'医院',cemetery:'墓园'};
                    document.getElementById('interactContent').innerHTML = `<p>你来到了「${names[act]||act}」。</p>`;
                    document.getElementById('interactModal').classList.add('show');
                    document.getElementById('modalOverlay').classList.add('show');
                });
            });
        }

        function updateMap(age) {
            const newMapId = getMapId(age);
            const oldActive = document.querySelector('.map-layer.active');
            if (oldActive && oldActive.dataset.map !== newMapId) {
                oldActive.classList.add('exit');
                setTimeout(() => {
                    oldActive.classList.remove('active', 'exit');
                    const next = document.querySelector(`.map-layer[data-map="${newMapId}"]`);
                    if (next) next.classList.add('active');
                    gameState.activeMapId = 'map_' + newMapId;
                    document.getElementById('currentLoc').textContent = '当前位置：' + (MAP_NAMES[newMapId] || newMapId);
                }, 500);
            } else if (oldActive) {
                document.getElementById('currentLoc').textContent = '当前位置：' + (MAP_NAMES[newMapId] || newMapId);
            } else {
                const next = document.querySelector(`.map-layer[data-map="${newMapId}"]`);
                if (next) next.classList.add('active');
                document.getElementById('currentLoc').textContent = '当前位置：' + (MAP_NAMES[newMapId] || newMapId);
            }
        }

        function updateDateDisplay() {
            const m = gameState.meta;
            document.getElementById('dateBar').textContent = `${m.currentYear}年 ${m.currentMonth}月 ${m.currentDay}日`;
        }

        let profileEditCache = { avatar: '', gender: '', background: '' };
        function openProfileModal() {
            const p = gameState.profile = gameState.profile || { avatar: '', gender: '', background: '' };
            profileEditCache = { avatar: p.avatar || '', background: p.background || '' };
            document.getElementById('profileAgeVal').textContent = gameState.meta.currentAge + ' 岁';
            const genderLabels = { male: '男', female: '女', other: '其他' };
            document.getElementById('profileGenderVal').textContent = genderLabels[p.gender] || '女';
            document.getElementById('profileBgInput').value = profileEditCache.background;
            const img = document.getElementById('profileAvatarImg');
            const ph = document.getElementById('profileAvatarPlaceholder');
            if (profileEditCache.avatar) {
                img.src = profileEditCache.avatar;
                img.style.display = 'block';
                ph.style.display = 'none';
            } else {
                img.src = '';
                img.style.display = 'none';
                ph.style.display = 'flex';
            }
            document.getElementById('profileModal').classList.add('show');
            document.getElementById('profileOverlay').classList.add('show');
        }
        function closeProfileModal() {
            document.getElementById('profileModal').classList.remove('show');
            document.getElementById('profileOverlay').classList.remove('show');
        }
        document.getElementById('profileOverlay').addEventListener('click', closeProfileModal);
        document.getElementById('profileAvatarWrap').addEventListener('click', () => document.getElementById('profileAvatarInput').click());
        document.getElementById('profileAvatarInput').addEventListener('change', e => {
            const f = e.target.files[0];
            if (!f || !f.type.startsWith('image/')) return;
            compressImageFile(f, 320, (dataUrl) => {
                profileEditCache.avatar = dataUrl;
                const img = document.getElementById('profileAvatarImg');
                const ph = document.getElementById('profileAvatarPlaceholder');
                img.src = dataUrl;
                img.style.display = 'block';
                ph.style.display = 'none';
            });
            e.target.value = '';
        });
        document.getElementById('profileSaveBtn').addEventListener('click', () => {
            gameState.profile = gameState.profile || {};
            gameState.profile.avatar = profileEditCache.avatar;
            gameState.profile.background = document.getElementById('profileBgInput').value.trim();
            saveGame();
            closeProfileModal();
        });
        document.getElementById('profileCancelBtn').addEventListener('click', closeProfileModal);

        function compressImageFile(file, maxSize, cb) {
            const reader = new FileReader();
            reader.onload = e => {
                const img = new Image();
                img.onload = () => {
                    const maxSide = Math.max(img.width, img.height);
                    const scale = maxSide > maxSize ? maxSize / maxSide : 1;
                    const canvas = document.createElement('canvas');
                    canvas.width = Math.round(img.width * scale);
                    canvas.height = Math.round(img.height * scale);
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.85);
                    cb(dataUrl);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function addLog(text) {
            const m = gameState.meta;
            gameState.historyLog.unshift({ age: m.currentAge, month: m.currentMonth, text, source: 'local' });
            if (gameState.historyLog.length > 50) gameState.historyLog.pop();
            renderTimeline();
        }

        function renderTimeline() {
            const list = document.getElementById('timelineList');
            list.innerHTML = gameState.historyLog.slice(0, 15).map(h =>
                `<div class="timeline-item"><div class="timeline-bubble"></div><div class="timeline-age">${h.age}岁${h.month||1}月</div><div class="timeline-text">${h.text}</div></div>`
            ).join('');
        }

        function advanceMonth() {
            const m = gameState.meta;
            if (!m.isAlive) return;
            m.currentMonth++;
            if (m.currentMonth > 12) {
                m.currentMonth = 1;
                m.currentYear++;
                m.currentAge++;
                gameState.relations.forEach(r => r.age++);
            }
            m.currentDay = 1 + Math.floor(Math.random() * 28);
            const evt = EVENTS_POOL[Math.floor(Math.random() * EVENTS_POOL.length)];
            addLog(evt);
            if (evt.indexOf('孩子出生') >= 0) {
                gameState.descendants = gameState.descendants || [];
                gameState.descendants.push({ age: m.currentAge, stats: JSON.parse(JSON.stringify(gameState.stats)), money: Math.floor(gameState.stats.money * 0.1) });
            }
            updateMap(m.currentAge);
            document.getElementById('ageBadge').textContent = m.currentAge + ' 岁';
            updateDateDisplay();
            renderStats();
            renderAgeSpecific();
            saveGame();
        }

        function ensureAgeSpecificDefaults() {
            const stage = getAgeStage(gameState.meta.currentAge);
            const attrs = AGE_SPECIFIC_ATTRS[stage] || [];
            const as = gameState.stats.ageSpecific = gameState.stats.ageSpecific || {};
            attrs.forEach(a => {
                if (as[a.k] === undefined) as[a.k] = stage === 'crib' ? 20 : (stage === 'elder' ? 70 : 50);
            });
        }

        function renderAgeSpecific() {
            ensureAgeSpecificDefaults();
            const stage = getAgeStage(gameState.meta.currentAge);
            const attrs = AGE_SPECIFIC_ATTRS[stage] || [];
            const as = gameState.stats.ageSpecific || {};
            const stageNames = { crib:'摇篮期', preschool:'幼儿期', primary:'小学', junior:'初中', senior:'高中', university:'大学', career:'职场', midlife:'中年', elder:'暮年' };
            const wrap = document.getElementById('ageSpecificWrap');
            if (attrs.length === 0) { wrap.innerHTML = ''; return; }
            wrap.innerHTML = `<div class="age-specific-title">${stageNames[stage]} · 专属属性</div><div class="age-specific-grid">` +
                attrs.map(a => `<div class="age-stat"><span class="age-stat-name">${a.n}</span><span class="age-stat-val" id="as_${a.k}">${as[a.k] ?? 50}</span></div>`).join('') + '</div>';
        }

        function renderStats() {
            const s = gameState.stats;
            const set = (id, v) => { const el = document.getElementById(id); if (el) el.textContent = v ?? 0; };
            set('statHealth', s.health);
            set('statMoney', s.money);
            set('statHappiness', s.happiness);
            set('statIntel', s.intelligence);
            set('statEq', s.eq);
            set('statCharm', s.charm);
            set('statAppearance', s.appearance);
            document.getElementById('pressureFill').style.width = (s.pressure || 0) + '%';
            renderAgeSpecific();
        }

        const RELATION_GROUP_LABELS = {
            family: '家人',
            lover: '爱人',
            work: '职场',
            enemy: '仇人'
        };

        function getRelationDisplayName(r) {
            return (r.remarkName && r.remarkName.trim()) || r.name || '';
        }

        let currentRelationFilter = 'all';

        function renderRelations(filter) {
            const list = document.getElementById('relationList');
            const rels = filter === 'all' ? gameState.relations : gameState.relations.filter(r => r.category === filter);
            const roleLabel = { father: '父亲', mother: '母亲' };
            list.innerHTML = rels.map(r =>
                `<div class="relation-card" data-relation-id="${r.id}">
                    <div class="relation-avatar">
                        ${r.avatar ? `<img src="${r.avatar}" alt="${getRelationDisplayName(r) || r.name}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">` : (getRelationDisplayName(r) || r.name || '?')[0]}
                    </div>
                    <div class="relation-info">
                        <div class="relation-name">${getRelationDisplayName(r) || r.name}</div>
                        <div class="relation-role">
                            ${(roleLabel[r.role] || r.role) || ''} · ${r.age}岁
                            ${r.displayId ? ` · ID:${r.displayId}` : ''}
                        </div>
                    </div>
                    <div class="relation-affinity">好感 ${r.affinity}</div>
                </div>`
            ).join('') || '<div style="text-align:center;color:var(--text-muted);padding:24px">暂无联系人</div>';
            list.querySelectorAll('.relation-card[data-relation-id]').forEach(card => {
                card.addEventListener('click', () => openChat(card.dataset.relationId));
            });
        }

        function openRelationGroupSettings() {
            const groups = gameState.relationGroups || ['family','lover','work','enemy'];
            const content = document.getElementById('interactContent');
            content.innerHTML = `
                <div class="card">
                    <div class="card-title">分组管理</div>
                    <div style="font-size:13px;color:var(--text-muted);margin-bottom:8px">双击 / 右键“全部”可再次打开本面板</div>
                    <div style="margin-bottom:12px;font-size:14px;color:var(--text-title)">当前分组</div>
                    <div id="relationGroupList" style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px"></div>
                    <div style="border-top:1px solid rgba(0,0,0,0.06);padding-top:12px;margin-top:4px">
                        <div style="font-size:14px;color:var(--text-title);margin-bottom:8px">增加分组</div>
                        <div style="display:flex;gap:8px">
                            <input type="text" id="newRelationGroupName" placeholder="请输入新分组名称" style="flex:1;padding:8px 10px;border:1px solid #eee;border-radius:8px;font-size:14px;font-family:inherit">
                            <button type="button" id="addRelationGroupBtn" style="padding:8px 12px;border:none;border-radius:8px;background:#fff;color:var(--text-title);font-size:14px;font-family:inherit;box-shadow:var(--shadow-card);cursor:pointer">添加</button>
                        </div>
                        <div style="font-size:12px;color:var(--text-muted);margin-top:6px">默认分组为家人、爱人、职场、仇人，你也可以添加自己的分组。</div>
                    </div>
                </div>
            `;

            const listEl = document.getElementById('relationGroupList');
            function refreshGroupList() {
                const gs = gameState.relationGroups || [];
                if (!gs.length) {
                    listEl.innerHTML = '<div style="font-size:13px;color:var(--text-muted)">暂无分组</div>';
                    return;
                }
                listEl.innerHTML = gs.map(key => {
                    const label = RELATION_GROUP_LABELS[key] || key;
                    return `<div data-key="${key}" style="display:inline-flex;align-items:center;gap:4px;padding:6px 10px;border-radius:999px;background:var(--bg-canvas);font-size:13px;">
                                <span>${label}</span>
                                <button type="button" data-role="remove" style="border:none;background:transparent;color:var(--text-muted);cursor:pointer;font-size:14px;line-height:1">×</button>
                            </div>`;
                }).join('');
                listEl.querySelectorAll('button[data-role="remove"]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const key = btn.parentElement.getAttribute('data-key');
                        const idx = gameState.relationGroups.indexOf(key);
                        if (idx >= 0) {
                            gameState.relationGroups.splice(idx, 1);
                            saveGame();
                            refreshGroupList();
                            renderRelationFilterTabs();
                        }
                    });
                });
            }
            refreshGroupList();

            document.getElementById('addRelationGroupBtn').addEventListener('click', () => {
                const input = document.getElementById('newRelationGroupName');
                const name = (input.value || '').trim();
                if (!name) return;
                let key = name.replace(/\s+/g, '_').toLowerCase();
                if (!key) return;
                if (!gameState.relationGroups) gameState.relationGroups = [];
                if (gameState.relationGroups.includes(key)) { input.value = ''; return; }
                RELATION_GROUP_LABELS[key] = name;
                gameState.relationGroups.push(key);
                saveGame();
                input.value = '';
                refreshGroupList();
                renderRelationFilterTabs();
            });

            document.getElementById('interactModal').classList.add('show');
            document.getElementById('modalOverlay').classList.add('show');
        }

        function renderRelationFilterTabs() {
            const container = document.querySelector('.filter-tabs');
            if (!container) return;
            if (!gameState.relationGroups) gameState.relationGroups = ['family','lover','work','enemy'];
            const groups = gameState.relationGroups;
            let html = `<button class="filter-tab ${currentRelationFilter === 'all' ? 'active' : ''}" data-filter="all" id="relationFilterAll">全部</button>`;
            html += groups.map(key => {
                const label = RELATION_GROUP_LABELS[key] || key;
                const activeClass = currentRelationFilter === key ? 'active' : '';
                return `<button class="filter-tab ${activeClass}" data-filter="${key}">${label}</button>`;
            }).join('');
            container.innerHTML = html;

            container.querySelectorAll('.filter-tab').forEach(t => {
                t.addEventListener('click', () => {
                    const filter = t.dataset.filter || 'all';
                    currentRelationFilter = filter;
                    container.querySelectorAll('.filter-tab').forEach(x => x.classList.remove('active'));
                    t.classList.add('active');
                    renderRelations(filter);
                });
            });

            const allBtn = document.getElementById('relationFilterAll');
            if (allBtn) {
                allBtn.addEventListener('dblclick', (e) => {
                    e.stopPropagation();
                    openRelationGroupSettings();
                });
                allBtn.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    openRelationGroupSettings();
                });
            }
        }

        let currentChatRelationId = null;
        let relationEditCache = { id: null, avatar: '', age: 0, affinity: 0, personality: '', background: '', name: '', remarkName: '', displayId: '', meetTime: '' };
        const REPLY_POOL = ['嗯，知道了。', '好的。', '有空再聊～', '哈哈，有意思。', '这样啊。', '……'];
        let voiceCallActive = false;
        let voiceCallTimer = null;
        let voiceCallStartAt = null;
        let voiceCallTimerInterval = null;
        let musicPreviewAudio = null;
        let currentMusicPlayingId = null;
        let pendingMusicShare = null; // { title, artist, cover, preview } 分享弹窗用

        // 转账和红包样式系统
        const TRANSFER_STYLES_PRESET = [
            { id: 'default', name: '默认', bg1: '#ffffff', bg2: '#f7f9fc', gradientDir: '180deg', width: 240, radius: 8, amountColor: '#333', amountSize: 36, unitSize: 20, titleColor: '#333', titleSize: 14, noteColor: '#888', noteSize: 13, iconColor: '#07c160', iconSize: 24, borderWidth: 1, borderColor: '#000000', borderOpacity: 0.08, shadowX: 0, shadowY: 2, shadowBlur: 8, shadowSpread: 0, shadowColor: '#000000', shadowOpacity: 0.1, headPadding: 12, bodyPadding: 20, headBg: '#ffffff', headBorder: '#f0f0f0', bodyBg: '#ffffff' },
            { id: 'blue', name: '蓝色', bg1: '#5c6bc0', bg2: '#7986cb', gradientDir: '180deg', width: 240, radius: 8, amountColor: '#333', amountSize: 36, unitSize: 20, titleColor: '#333', titleSize: 14, noteColor: '#888', noteSize: 13, iconColor: '#5c6bc0', iconSize: 24, borderWidth: 1, borderColor: '#000000', borderOpacity: 0.08, shadowX: 0, shadowY: 2, shadowBlur: 8, shadowSpread: 0, shadowColor: '#000000', shadowOpacity: 0.1, headPadding: 12, bodyPadding: 20, headBg: '#ffffff', headBorder: '#f0f0f0', bodyBg: '#ffffff' },
            { id: 'green', name: '绿色', bg1: '#07c160', bg2: '#06ad56', gradientDir: '180deg', width: 240, radius: 8, amountColor: '#fff', amountSize: 36, unitSize: 20, titleColor: '#fff', titleSize: 14, noteColor: 'rgba(255,255,255,0.9)', noteSize: 13, iconColor: '#fff', iconSize: 24, borderWidth: 1, borderColor: '#000000', borderOpacity: 0.08, shadowX: 0, shadowY: 2, shadowBlur: 8, shadowSpread: 0, shadowColor: '#000000', shadowOpacity: 0.1, headPadding: 12, bodyPadding: 20, headBg: '#07c160', headBorder: 'rgba(255,255,255,0.2)', bodyBg: '#ffffff' },
            { id: 'purple', name: '紫色', bg1: '#9c27b0', bg2: '#ab47bc', gradientDir: '180deg', width: 240, radius: 8, amountColor: '#fff', amountSize: 36, unitSize: 20, titleColor: '#fff', titleSize: 14, noteColor: 'rgba(255,255,255,0.9)', noteSize: 13, iconColor: '#fff', iconSize: 24, borderWidth: 1, borderColor: '#000000', borderOpacity: 0.08, shadowX: 0, shadowY: 2, shadowBlur: 8, shadowSpread: 0, shadowColor: '#000000', shadowOpacity: 0.1, headPadding: 12, bodyPadding: 20, headBg: '#9c27b0', headBorder: 'rgba(255,255,255,0.2)', bodyBg: '#ffffff' }
        ];
        const REDPACK_STYLES_PRESET = [
            { id: 'default', name: '默认', bg1: '#ff5442', bg2: '#e53e3e', gradientDir: '180deg', width: 240, radius: 8, amountColor: '#ff5442', amountSize: 36, unitSize: 20, titleColor: '#fff', titleSize: 14, noteColor: '#999', noteSize: 12, iconColor: '#fff', iconSize: 24, borderWidth: 0, borderColor: '#000000', borderOpacity: 0, shadowX: 0, shadowY: 2, shadowBlur: 8, shadowSpread: 0, shadowColor: '#000000', shadowOpacity: 0.1, headPadding: 12, bodyPadding: 24, headBg: 'transparent', headBorder: 'transparent', bodyBg: '#ffffff' },
            { id: 'gold', name: '金色', bg1: '#ffd700', bg2: '#ffb347', gradientDir: '180deg', width: 240, radius: 8, amountColor: '#c0392b', amountSize: 36, unitSize: 20, titleColor: '#fff', titleSize: 14, noteColor: '#999', noteSize: 12, iconColor: '#fff', iconSize: 24, borderWidth: 0, borderColor: '#000000', borderOpacity: 0, shadowX: 0, shadowY: 2, shadowBlur: 8, shadowSpread: 0, shadowColor: '#000000', shadowOpacity: 0.1, headPadding: 12, bodyPadding: 24, headBg: 'transparent', headBorder: 'transparent', bodyBg: '#ffffff' },
            { id: 'pink', name: '粉色', bg1: '#ff6b9d', bg2: '#ff4757', gradientDir: '180deg', width: 240, radius: 8, amountColor: '#fff', amountSize: 36, unitSize: 20, titleColor: '#fff', titleSize: 14, noteColor: '#999', noteSize: 12, iconColor: '#fff', iconSize: 24, borderWidth: 0, borderColor: '#000000', borderOpacity: 0, shadowX: 0, shadowY: 2, shadowBlur: 8, shadowSpread: 0, shadowColor: '#000000', shadowOpacity: 0.1, headPadding: 12, bodyPadding: 24, headBg: 'transparent', headBorder: 'transparent', bodyBg: '#ffffff' },
            { id: 'orange', name: '橙色', bg1: '#ff8c42', bg2: '#ff6b35', gradientDir: '180deg', width: 240, radius: 8, amountColor: '#fff', amountSize: 36, unitSize: 20, titleColor: '#fff', titleSize: 14, noteColor: '#999', noteSize: 12, iconColor: '#fff', iconSize: 24, borderWidth: 0, borderColor: '#000000', borderOpacity: 0, shadowX: 0, shadowY: 2, shadowBlur: 8, shadowSpread: 0, shadowColor: '#000000', shadowOpacity: 0.1, headPadding: 12, bodyPadding: 24, headBg: 'transparent', headBorder: 'transparent', bodyBg: '#ffffff' }
        ];
        if (!userSettings.transferStyles) userSettings.transferStyles = [];
        if (!userSettings.redpackStyles) userSettings.redpackStyles = [];
        if (!userSettings.currentTransferStyle) userSettings.currentTransferStyle = 'default';
        if (!userSettings.currentRedpackStyle) userSettings.currentRedpackStyle = 'default';
        let currentStyleType = 'transfer'; // 'transfer' or 'redpack'
        let currentEditingStyle = null;

        function openChat(relationId) {
            const r = gameState.relations.find(x => x.id === relationId);
            if (!r) return;
            if (!gameState.chatLogs) gameState.chatLogs = {};
            if (!gameState.chatLogs[relationId]) gameState.chatLogs[relationId] = [];
            currentChatRelationId = relationId;
            document.getElementById('chatTitle').textContent = getRelationDisplayName(r) || r.name;
            document.getElementById('chatPanel').classList.add('show');
            closeChatPlusMenu();
            renderChatMessages();
            applyChatBackground();
            document.getElementById('chatInput').focus();
            updateChatLocationShareBar();
        }

        function closeChat() {
            document.getElementById('chatPanel').classList.remove('show');
            currentChatRelationId = null;
            closeChatPlusMenu();
            saveGame();
        }

        function applyChatBackground() {
            const el = document.getElementById('chatMessages');
            if (!el) return;
            if (!currentChatRelationId) {
                el.style.backgroundImage = '';
                el.style.backgroundSize = '';
                el.style.backgroundPosition = '';
                return;
            }
            const r = gameState.relations.find(x => x.id === currentChatRelationId);
            const bg = (r && r.chatBg) ? r.chatBg : '';
            if (bg) {
                el.style.backgroundImage = 'url(' + bg + ')';
                el.style.backgroundSize = 'cover';
                el.style.backgroundPosition = 'center';
            } else {
                el.style.backgroundImage = '';
                el.style.backgroundSize = '';
                el.style.backgroundPosition = '';
            }
        }

        function applyVoiceCallBackgroundForRelation(r) {
            const panel = document.getElementById('voiceCallPanel');
            if (!panel) return;
            const bg = r && r.voiceCallBg ? r.voiceCallBg : '';
            if (bg) {
                panel.style.backgroundImage = 'url(' + bg + ')';
                panel.style.backgroundSize = 'cover';
                panel.style.backgroundPosition = 'center';
            } else {
                panel.style.backgroundImage = '';
            }
            const style = r && r.voiceCallStyle ? r.voiceCallStyle : {};
            panel.style.setProperty('--voice-call-transcript-bg', style.transcriptBg || '');
            panel.style.setProperty('--voice-call-transcript-color', style.transcriptColor || '');
            panel.style.setProperty('--voice-call-input-bg', style.inputBg || '');
            panel.style.setProperty('--voice-call-input-color', style.inputColor || '');
        }

        function openMusicPanel() {
            const panel = document.getElementById('musicPanel');
            if (!panel) return;
            document.getElementById('musicEmptyHint').style.display = 'block';
            document.getElementById('musicLoadingHint').style.display = 'none';
            document.getElementById('musicList').innerHTML = '';
            panel.classList.add('show');
        }

        function closeMusicPanel() {
            const panel = document.getElementById('musicPanel');
            if (!panel) return;
            panel.classList.remove('show');
        }

        function confirmMusicShare() {
            if (!pendingMusicShare || !currentChatRelationId) return;
            const music = {
                title: pendingMusicShare.title,
                artist: pendingMusicShare.artist,
                cover: pendingMusicShare.cover,
                preview: pendingMusicShare.preview
            };
            if (!gameState.chatLogs[currentChatRelationId]) gameState.chatLogs[currentChatRelationId] = [];
            gameState.chatLogs[currentChatRelationId].push({ from: 'me', music });
            renderChatMessages();
            saveGame();
            closeMusicPanel();
        }

        function confirmMusicShare() {
            if (!pendingMusicShare || !currentChatRelationId) return;
            const music = {
                title: pendingMusicShare.title,
                artist: pendingMusicShare.artist,
                cover: pendingMusicShare.cover,
                preview: pendingMusicShare.preview
            };
            if (!gameState.chatLogs[currentChatRelationId]) gameState.chatLogs[currentChatRelationId] = [];
            gameState.chatLogs[currentChatRelationId].push({ from: 'me', music });
            renderChatMessages();
            saveGame();
            closeMusicShareModal();
            closeMusicPanel();
        }

        async function searchMusic(term) {
            const emptyHint = document.getElementById('musicEmptyHint');
            const loadingHint = document.getElementById('musicLoadingHint');
            const list = document.getElementById('musicList');
            // 停止正在播放的音乐并重置状态
            if (musicPreviewAudio) {
                musicPreviewAudio.pause();
                musicPreviewAudio.src = '';
            }
            currentMusicPlayingId = null;
            if (!term) {
                emptyHint.style.display = 'block';
                emptyHint.textContent = '请输入关键词再搜索';
                loadingHint.style.display = 'none';
                list.innerHTML = '';
                return;
            }
            emptyHint.style.display = 'none';
            loadingHint.style.display = 'block';
            list.innerHTML = '';
            try {
                // 使用Deezer API搜索完整版音乐
                const deezerUrl = `https://api.deezer.com/search?q=${encodeURIComponent(term)}&limit=20`;
                const res = await fetch(deezerUrl);
                if (!res.ok) throw new Error('搜索失败');
                const data = await res.json();
                const results = Array.isArray(data.data) ? data.data : [];
                if (!results.length) {
                    emptyHint.style.display = 'block';
                    emptyHint.textContent = '没有找到相关音乐';
                    loadingHint.style.display = 'none';
                    return;
                }
                emptyHint.style.display = 'none';
                // 使用Jamendo API获取免费完整版音乐
                const jamendoUrl = `https://api.jamendo.com/v3.0/tracks/?client_id=YOUR_CLIENT_ID&format=json&limit=20&search=${encodeURIComponent(term)}`;
                // 由于Jamendo需要API密钥，改用Deezer + 尝试获取完整版
                // 对于完整版，使用Deezer的preview（30秒）作为临时方案
                // 实际完整版需要用户提供或使用付费API
                list.innerHTML = results.map((item, idx) => {
                    const title = (item.title || '').toString();
                    const artist = (item.artist ? item.artist.name : '').toString();
                    const cover = (item.album ? item.album.cover_medium || item.album.cover : '').toString();
                    // Deezer的preview是30秒，完整版需要特殊处理
                    // 使用preview URL，但标记为完整版（实际播放时会尝试获取完整版）
                    const preview = (item.preview || '').toString();
                    // 使用Deezer track的stream URL（可能需要认证，但先尝试）
                    const fullAudioUrl = preview; // 暂时使用preview，完整版需要API认证
                    
                    return `<div class="music-item" data-music-idx="${idx}" data-preview="${escapeHtml(fullAudioUrl)}" data-title="${escapeHtml(title)}" data-artist="${escapeHtml(artist)}" data-cover="${escapeHtml(cover)}" data-duration="${item.duration || 0}">
                        <div class="music-item-top">
                            <div class="music-cover">${cover ? `<img src="${escapeHtml(cover)}" alt="">` : ''}</div>
                            <div class="music-main">
                                <div class="music-title">${escapeHtml(title)}</div>
                                <div class="music-artist">${escapeHtml(artist)}</div>
                            </div>
                            <div class="music-actions">
                                <button type="button" class="music-play-btn">播放</button>
                                <button type="button" class="music-share-btn">分享</button>
                            </div>
                        </div>
                        <div class="music-progress-wrap">
                            <div class="music-progress-time">
                                <span class="music-time-current">0:00</span>
                                <span class="music-time-total">--:--</span>
                            </div>
                            <div class="music-progress">
                                <input type="range" min="0" max="100" value="0" step="1">
                            </div>
                        </div>
                    </div>`;
                }).join('');
                loadingHint.style.display = 'none';

                // 重置所有按钮和进度条状态
                list.querySelectorAll('.music-play-btn').forEach(btn => {
                    btn.textContent = '播放';
                });
                list.querySelectorAll('.music-progress input[type="range"]').forEach(range => {
                    range.value = '0';
                });
                list.querySelectorAll('.music-time-current').forEach(span => {
                    span.textContent = '0:00';
                });
                list.querySelectorAll('.music-time-total').forEach(span => {
                    span.textContent = '--:--';
                });

                if (!musicPreviewAudio) {
                    musicPreviewAudio = document.getElementById('musicPreviewAudio');
                }
                const progressMap = new Map();
                list.querySelectorAll('.music-item').forEach((item) => {
                    const idx = item.getAttribute('data-music-idx') || '';
                    const range = item.querySelector('.music-progress input[type="range"]');
                    if (range) progressMap.set(idx, range);
                });
                if (musicPreviewAudio) {
                    musicPreviewAudio.ontimeupdate = () => {
                        if (!currentMusicPlayingId) return;
                        const itemEl = list.querySelector(`.music-item[data-music-idx="${currentMusicPlayingId}"]`);
                        if (!itemEl) return;
                        const r = progressMap.get(currentMusicPlayingId);
                        const curSpan = itemEl.querySelector('.music-time-current');
                        const totalSpan = itemEl.querySelector('.music-time-total');
                        const dur = musicPreviewAudio.duration;
                        const cur = musicPreviewAudio.currentTime;
                        const fmt = (s) => {
                            if (!s || isNaN(s)) return '--:--';
                            const m = Math.floor(s / 60);
                            const sec = Math.floor(s % 60);
                            return m + ':' + (sec < 10 ? '0' : '') + sec;
                        };
                        if (r && dur && !isNaN(dur)) {
                            r.value = String(Math.floor((cur / dur) * 100));
                        }
                        if (curSpan) curSpan.textContent = fmt(cur);
                        if (totalSpan) {
                            if (dur && !isNaN(dur)) {
                                totalSpan.textContent = fmt(dur);
                            } else {
                                // 尝试从data-duration获取
                                const itemDuration = itemEl.getAttribute('data-duration');
                                if (itemDuration) {
                                    totalSpan.textContent = fmt(parseInt(itemDuration, 10));
                                }
                            }
                        }
                    };
                }
                list.querySelectorAll('.music-play-btn').forEach((btn) => {
                    btn.addEventListener('click', () => {
                        const item = btn.closest('.music-item');
                        if (!item) return;
                        const preview = item.getAttribute('data-preview') || '';
                        const idx = item.getAttribute('data-music-idx') || '';
                        if (!preview || !musicPreviewAudio) return;
                        const range = progressMap.get(idx);
                        if (currentMusicPlayingId === idx && !musicPreviewAudio.paused) {
                            musicPreviewAudio.pause();
                            currentMusicPlayingId = null;
                            btn.textContent = '播放';
                        } else {
                            musicPreviewAudio.src = preview;
                            musicPreviewAudio.play().catch(() => {});
                            currentMusicPlayingId = idx;
                            list.querySelectorAll('.music-play-btn').forEach(b => { if (b !== btn) b.textContent = '播放'; });
                            btn.textContent = '暂停';
                            if (range) range.value = '0';
                            const itemEl = btn.closest('.music-item');
                            if (itemEl) {
                                const curSpan = itemEl.querySelector('.music-time-current');
                                if (curSpan) curSpan.textContent = '0:00';
                            }
                        }
                    });
                });
                list.querySelectorAll('.music-progress input[type="range"]').forEach((range) => {
                    range.addEventListener('input', () => {
                        const item = range.closest('.music-item');
                        if (!item || !musicPreviewAudio) return;
                        const idx = item.getAttribute('data-music-idx') || '';
                        if (currentMusicPlayingId !== idx) return;
                        if (!musicPreviewAudio.duration || isNaN(musicPreviewAudio.duration)) return;
                        const ratio = parseInt(range.value || '0', 10) / 100;
                        musicPreviewAudio.currentTime = musicPreviewAudio.duration * ratio;
                    });
                });
                list.querySelectorAll('.music-share-btn').forEach((btn) => {
                    btn.addEventListener('click', () => {
                        if (!currentChatRelationId) return;
                        const item = btn.closest('.music-item');
                        if (!item) return;
                        pendingMusicShare = {
                            title: item.getAttribute('data-title') || '',
                            artist: item.getAttribute('data-artist') || '',
                            cover: item.getAttribute('data-cover') || '',
                            preview: item.getAttribute('data-preview') || ''
                        };
                        confirmMusicShare();
                    });
                });
            } catch (e) {
                console.error('搜索音乐失败', e);
                emptyHint.style.display = 'block';
                emptyHint.textContent = '搜索失败，请稍后重试';
                loadingHint.style.display = 'none';
            }
        }

        function openVoiceCallPanel() {
            if (!currentChatRelationId) return;
            const panel = document.getElementById('voiceCallPanel');
            if (!panel) return;
            const r = gameState.relations.find(x => x.id === currentChatRelationId);
            const name = r ? (getRelationDisplayName(r) || r.name || '好友') : '好友';
            const avatar = r && r.avatar ? r.avatar : '';
            const nameEl = document.getElementById('voiceCallName');
            const statusEl = document.getElementById('voiceCallStatus');
            const imgEl = document.getElementById('voiceCallAvatarImg');
            const fallbackEl = document.getElementById('voiceCallAvatarFallback');
            const transcriptEl = document.getElementById('voiceCallTranscript');
            voiceCallActive = false;
            if (voiceCallTimer) {
                clearTimeout(voiceCallTimer);
                voiceCallTimer = null;
            }
            voiceCallStartAt = null;
            if (voiceCallTimerInterval) {
                clearInterval(voiceCallTimerInterval);
                voiceCallTimerInterval = null;
            }
            if (nameEl) nameEl.textContent = name;
            if (statusEl) statusEl.textContent = '正在为你呼叫中…';
            if (transcriptEl) transcriptEl.innerHTML = '';
            applyVoiceCallBackgroundForRelation(r);
            if (imgEl && fallbackEl) {
                if (avatar) {
                    imgEl.src = avatar;
                    imgEl.style.display = 'block';
                    fallbackEl.style.display = 'none';
                } else {
                    imgEl.src = '';
                    imgEl.style.display = 'none';
                    fallbackEl.style.display = 'block';
                    fallbackEl.textContent = name ? name[0] : 'Ta';
                }
            }
            panel.classList.add('show');
            panel.setAttribute('aria-hidden', 'false');
            panel.classList.remove('in-call');
            const timerText = document.getElementById('voiceCallTimerText');
            if (timerText) timerText.textContent = '00:00';
            voiceCallTimer = setTimeout(simulateVoiceCallDecision, 1200 + Math.random() * 800);
        }

        function closeVoiceCallPanel() {
            const panel = document.getElementById('voiceCallPanel');
            if (!panel) return;
            if (voiceCallActive) {
                // 用户主动挂断时记录一次通话总结
                logVoiceCallSummary('ended');
            }
            panel.classList.remove('show');
            panel.setAttribute('aria-hidden', 'true');
            voiceCallActive = false;
            panel.classList.remove('in-call');
            if (voiceCallTimer) {
                clearTimeout(voiceCallTimer);
                voiceCallTimer = null;
            }
            if (voiceCallTimerInterval) {
                clearInterval(voiceCallTimerInterval);
                voiceCallTimerInterval = null;
            }
            if (voiceCallTimer) {
                clearTimeout(voiceCallTimer);
                voiceCallTimer = null;
            }
        }

        function appendVoiceCallTranscriptLine(from, text) {
            const transcriptEl = document.getElementById('voiceCallTranscript');
            if (!transcriptEl || !text) return;
            const div = document.createElement('div');
            div.className = 'voice-call-transcript-line ' + (from === 'me' ? 'me' : 'other');
            div.textContent = text;
            transcriptEl.appendChild(div);
            transcriptEl.scrollTop = transcriptEl.scrollHeight;
        }

        function updateVoiceCallTimerDisplay() {
            const timerText = document.getElementById('voiceCallTimerText');
            if (!timerText || !voiceCallStartAt) return;
            const secs = Math.max(0, Math.floor((Date.now() - voiceCallStartAt) / 1000));
            const mm = String(Math.floor(secs / 60)).padStart(2, '0');
            const ss = String(secs % 60).padStart(2, '0');
            timerText.textContent = `${mm}:${ss}`;
        }

        function startVoiceCallTimer() {
            if (voiceCallTimerInterval) {
                clearInterval(voiceCallTimerInterval);
                voiceCallTimerInterval = null;
            }
            updateVoiceCallTimerDisplay();
            voiceCallTimerInterval = setInterval(updateVoiceCallTimerDisplay, 1000);
        }

        function logVoiceCallSummary(status) {
            if (!currentChatRelationId) return;
            if (!gameState.chatLogs[currentChatRelationId]) gameState.chatLogs[currentChatRelationId] = [];
            const logs = gameState.chatLogs[currentChatRelationId];
            const secs = voiceCallStartAt ? Math.max(0, Math.floor((Date.now() - voiceCallStartAt) / 1000)) : 0;
            logs.push({
                from: 'me',
                voiceCallSummary: {
                    duration: secs,
                    status
                }
            });
            renderChatMessages();
            saveGame();
            voiceCallStartAt = null;
        }

        function sendVoiceCallText() {
            const input = document.getElementById('voiceCallInput');
            if (!input || !currentChatRelationId) return;
            const text = (input.value || '').trim();
            if (!text) return;
            input.value = '';
            appendVoiceCallTranscriptLine('me', text);
        }

        function simulateVoiceCallDecision() {
            if (!currentChatRelationId) return;
            const statusEl = document.getElementById('voiceCallStatus');
            const panel = document.getElementById('voiceCallPanel');
            const r = gameState.relations.find(x => x.id === currentChatRelationId);
            const affinity = r && typeof r.affinity === 'number' ? r.affinity : 50;
            const baseProb = 0.35 + affinity / 200; // 0.35~0.85
            const accepted = Math.random() < Math.min(0.88, Math.max(0.25, baseProb));
            if (accepted) {
                voiceCallActive = true;
                if (statusEl) statusEl.textContent = '正在语音通话中...';
                if (panel) panel.classList.add('in-call');
                voiceCallStartAt = Date.now();
                startVoiceCallTimer();
            } else {
                voiceCallActive = false;
                if (statusEl) statusEl.textContent = '对方暂时无法接听。';
                const rejectText = '这会儿不太方便语音，我们先打字聊聊，好吗？';
                appendVoiceCallTranscriptLine('other', rejectText);
                logVoiceCallSummary('rejected');
                setTimeout(closeVoiceCallPanel, 1200);
            }
        }

        let albumAddTarget = 'self';
        let albumEditIdx = -1;
        let albumPending = { src: '', desc: '' };

        function openStickerPickerModal() {
            if (!gameState.profile) gameState.profile = {};
            if (!Array.isArray(gameState.profile.stickers)) gameState.profile.stickers = [];
            const r = currentChatRelationId ? gameState.relations.find(x => x.id === currentChatRelationId) : null;
            if (r && !Array.isArray(r.stickers)) r.stickers = [];
            const name = r ? (getRelationDisplayName(r) || r.name || 'TA') : 'TA';
            document.getElementById('stickerSectionRelationTitle').innerHTML = name + '的表情包 <button type="button" class="sticker-section-add" id="stickerAddRelation">+</button>';
            renderStickerPickerGrids();
            document.getElementById('stickerPickerModal').classList.add('show');
            document.getElementById('stickerPickerOverlay').classList.add('show');
        }

        function closeStickerPickerModal() {
            document.getElementById('stickerPickerModal').classList.remove('show');
            document.getElementById('stickerPickerOverlay').classList.remove('show');
        }

        function renderStickerPickerGrids() {
            const selfList = (gameState.profile && gameState.profile.stickers) || [];
            const r = currentChatRelationId ? gameState.relations.find(x => x.id === currentChatRelationId) : null;
            const relationList = (r && r.stickers) || [];
            const renderGrid = (list, gridId, isSelf) => {
                const grid = document.getElementById(gridId);
                const which = isSelf ? 'self' : 'relation';
                grid.innerHTML = list.map((s, i) =>
                    '<div class="sticker-item" data-which="' + which + '" data-idx="' + i + '"><img src="' + s.src.replace(/"/g, '&quot;') + '" alt=""><div class="sticker-item-desc">' + escapeHtml((s.desc || '').slice(0, 20)) + '</div><button type="button" class="sticker-item-edit" data-which="' + which + '" data-idx="' + i + '" title="编辑" aria-label="编辑"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="16" height="16" style="display:block"><path d="M4 20h4l11-11a2 2 0 00-4-4L4 16v4z" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"/><path d="M13 6l5 5" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/></svg></button></div>'
                ).join('');
                grid.querySelectorAll('.sticker-item').forEach(el => {
                    const which = el.dataset.which;
                    const idx = parseInt(el.dataset.idx, 10);
                    const arr = which === 'self' ? selfList : relationList;
                    const s = arr[idx];
                    if (!s) return;
                    const editBtn = el.querySelector('.sticker-item-edit');
                    if (editBtn) editBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        closeStickerPickerModal();
                        openAlbumModal(which, idx);
                    });
                    el.addEventListener('click', (e) => {
                        if (e.target.closest('.sticker-item-edit')) return;
                        sendStickerMessage(s.src, s.desc);
                    });
                });
            };
            renderGrid(selfList, 'stickerGridSelf', true);
            renderGrid(relationList, 'stickerGridRelation', false);
            document.getElementById('stickerAddSelf').onclick = () => { closeStickerPickerModal(); openAlbumModal('self'); };
            const relAdd = document.getElementById('stickerAddRelation');
            if (relAdd) relAdd.onclick = () => { closeStickerPickerModal(); openAlbumModal('relation'); };
        }

        function sendStickerMessage(src, desc) {
            if (!currentChatRelationId || !src) return;
            if (!gameState.chatLogs[currentChatRelationId]) gameState.chatLogs[currentChatRelationId] = [];
            gameState.chatLogs[currentChatRelationId].push({ from: 'me', stickerSrc: src, stickerDesc: desc || '' });
            renderChatMessages();
            closeStickerPickerModal();
            saveGame();
        }

        function openAlbumModal(target, editIdx) {
            albumAddTarget = target;
            albumEditIdx = editIdx === undefined || editIdx === null ? -1 : parseInt(editIdx, 10);
            albumPending = { src: '', desc: '' };
            const preview = document.getElementById('albumPreview');
            const descInput = document.getElementById('albumDescInput');
            const header = document.querySelector('.album-modal-header');
            const confirmBtn = document.getElementById('albumConfirmBtn');
            if (albumEditIdx >= 0) {
                const arr = albumAddTarget === 'self'
                    ? (gameState.profile && gameState.profile.stickers) || []
                    : (currentChatRelationId && gameState.relations.find(x => x.id === currentChatRelationId) && gameState.relations.find(x => x.id === currentChatRelationId).stickers) || [];
                const s = arr[albumEditIdx];
                if (s) {
                    albumPending = { src: s.src, desc: s.desc || '' };
                    preview.src = s.src;
                    preview.classList.add('show');
                    descInput.value = s.desc || '';
                }
                if (header) header.textContent = '编辑表情包';
                if (confirmBtn) confirmBtn.textContent = '保存';
            } else {
                preview.src = '';
                preview.classList.remove('show');
                descInput.value = '';
                if (header) header.textContent = '个人相册';
                if (confirmBtn) confirmBtn.textContent = '确定添加';
            }
            document.getElementById('albumModal').classList.add('show');
            document.getElementById('albumOverlay').classList.add('show');
        }

        function closeAlbumModal() {
            document.getElementById('albumModal').classList.remove('show');
            document.getElementById('albumOverlay').classList.remove('show');
            openStickerPickerModal();
        }

        function closeAlbumModalOnly() {
            document.getElementById('albumModal').classList.remove('show');
            document.getElementById('albumOverlay').classList.remove('show');
        }

        let imageSendPending = { src: '', desc: '' };

        function openImageSendModal() {
            imageSendPending = { src: '', desc: '' };
            document.getElementById('imageSendPreview').classList.remove('show');
            document.getElementById('imageSendPreview').src = '';
            document.getElementById('imageSendDescInput').value = '';
            document.getElementById('imageSendModal').classList.add('show');
            document.getElementById('imageSendOverlay').classList.add('show');
        }

        function closeImageSendModal() {
            document.getElementById('imageSendModal').classList.remove('show');
            document.getElementById('imageSendOverlay').classList.remove('show');
        }

        function openTransferModal() {
            document.getElementById('transferAmountInput').value = '';
            document.getElementById('transferNoteInput').value = '';
            document.getElementById('transferModal').classList.add('show');
            document.getElementById('transferOverlay').classList.add('show');
        }
        function closeTransferModal() {
            document.getElementById('transferModal').classList.remove('show');
            document.getElementById('transferOverlay').classList.remove('show');
        }
        function openRedpackModal() {
            document.getElementById('redpackAmountInput').value = '';
            document.getElementById('redpackBlessingInput').value = '';
            document.getElementById('redpackModal').classList.add('show');
            document.getElementById('redpackOverlay').classList.add('show');
        }
        function closeRedpackModal() {
            document.getElementById('redpackModal').classList.remove('show');
            document.getElementById('redpackOverlay').classList.remove('show');
        }

        // 发送位置 / 位置共享
        let locationPending = { lat: null, lng: null, label: '', action: 'send-location' };
        if (!gameState.locationShare) gameState.locationShare = {};

        function getCurrentLocationShare() {
            if (!currentChatRelationId) return null;
            gameState.locationShare = gameState.locationShare || {};
            return gameState.locationShare[currentChatRelationId] || null;
        }

        function setCurrentLocationShare(state) {
            if (!currentChatRelationId) return;
            gameState.locationShare = gameState.locationShare || {};
            if (state) {
                gameState.locationShare[currentChatRelationId] = state;
            } else {
                delete gameState.locationShare[currentChatRelationId];
            }
            updateChatLocationShareBar();
            saveGame();
        }

        function updateChatLocationShareBar() {
            const bar = document.getElementById('chatLocationShareBar');
            const mainEl = document.getElementById('chatLocationShareMain');
            const subEl = document.getElementById('chatLocationShareSub');
            if (!bar || !mainEl || !subEl) return;
            const state = getCurrentLocationShare();
            if (!state || !state.active) {
                bar.classList.remove('show');
                return;
            }
            const r = currentChatRelationId && gameState.relations.find(x => x.id === currentChatRelationId);
            const name = r ? (getRelationDisplayName(r) || r.name || 'Ta') : 'Ta';
            const label = (state.label || '位置').toString();
            mainEl.textContent = `与 ${name} 正在位置共享`;
            if (typeof state.lat === 'number' && typeof state.lng === 'number') {
                const latStr = state.lat.toFixed(5);
                const lngStr = state.lng.toFixed(5);
                subEl.textContent = `${label} · 纬度 ${latStr} · 经度 ${lngStr}`;
            } else {
                subEl.textContent = `${label} · 实时位置共享中`;
            }
            bar.classList.add('show');
        }

        function openLocationModal(action) {
            if (!currentChatRelationId) return;
            locationPending = { lat: null, lng: null, label: '', action: action || 'send-location' };
            const isShare = action === 'share-location';
            const titleEl = document.querySelector('.location-header-title');
            const subEl = document.querySelector('.location-header-sub');
            const sendBtn = document.getElementById('locationSendBtn');
            document.getElementById('locationLatInput').value = '';
            document.getElementById('locationLngInput').value = '';
            document.getElementById('locationLabelInput').value = '';
            document.getElementById('locationStatus').textContent = isShare
                ? '这次选择的位置会作为“实时共享位置”展示在聊天顶部，你可以随时再次更改。'
                : '点击“获取当前位置”以使用真实地理位置，也可以手动修改经纬度。';
            if (titleEl) titleEl.textContent = isShare ? '位置共享' : '发送位置';
            if (subEl) subEl.textContent = isShare
                ? '定义当前会话的共享位置，对方将看到你最新的位置点'
                : '实时获取当前位置，也可以手动微调坐标';
            if (sendBtn) sendBtn.textContent = isShare ? '开始共享' : '发送位置';
            const canvas = document.getElementById('locationMapCanvas');
            if (canvas) {
                const ctx = canvas.getContext('2d');
                if (ctx) {
                    ctx.clearRect(0, 0, canvas.width || 0, canvas.height || 0);
                }
            }
            document.getElementById('locationModal').classList.add('show');
            document.getElementById('locationOverlay').classList.add('show');
        }

        function closeLocationModal() {
            document.getElementById('locationModal').classList.remove('show');
            document.getElementById('locationOverlay').classList.remove('show');
        }

        function updateLocationFromInputs() {
            const latVal = parseFloat(document.getElementById('locationLatInput').value);
            const lngVal = parseFloat(document.getElementById('locationLngInput').value);
            if (!isNaN(latVal) && !isNaN(lngVal)) {
                locationPending.lat = latVal;
                locationPending.lng = lngVal;
                updateLocationMapPreview();
                document.getElementById('locationStatus').textContent = '已更新位置，可以发送。';
            }
        }

        // 抽象位置预览（不依赖外部地图服务）
        function drawAbstractLocationPreview(lat, lng, label) {
            const canvas = document.getElementById('locationMapCanvas');
            if (!canvas) return;
            const rect = canvas.getBoundingClientRect();
            if (canvas.width !== rect.width || canvas.height !== rect.height) {
                canvas.width = rect.width;
                canvas.height = rect.height;
            }
            const ctx = canvas.getContext('2d');
            const w = canvas.width;
            const h = canvas.height;
            ctx.clearRect(0, 0, w, h);

            // 背景层：柔和渐变
            const bgGrad = ctx.createLinearGradient(0, 0, w, h);
            bgGrad.addColorStop(0, '#f3f6fb');
            bgGrad.addColorStop(1, '#dde4f1');
            ctx.fillStyle = bgGrad;
            ctx.fillRect(0, 0, w, h);

            // 画一个「世界圆盘」
            const radius = Math.min(w, h) * 0.4;
            const cx = w / 2;
            const cy = h / 2 + 6;
            const diskGrad = ctx.createRadialGradient(cx - radius * 0.3, cy - radius * 0.6, radius * 0.2, cx, cy, radius);
            diskGrad.addColorStop(0, '#ffffff');
            diskGrad.addColorStop(1, '#cbd5f0');
            ctx.beginPath();
            ctx.arc(cx, cy, radius, 0, Math.PI * 2);
            ctx.fillStyle = diskGrad;
            ctx.fill();

            // 纬线 / 经线（抽象网格）
            ctx.strokeStyle = 'rgba(255,255,255,0.7)';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.ellipse(cx, cy, radius * 0.95, radius * 0.95, 0, 0, Math.PI * 2);
            ctx.stroke();
            ctx.beginPath();
            ctx.ellipse(cx, cy, radius * 0.95, radius * 0.55, 0, 0, Math.PI * 2);
            ctx.stroke();
            ctx.beginPath();
            ctx.ellipse(cx, cy, radius * 0.95, radius * 0.55, Math.PI / 2, 0, Math.PI * 2);
            ctx.stroke();

            // 抽象经纬网（几条辅助线）
            ctx.strokeStyle = 'rgba(255,255,255,0.55)';
            const rings = [0.3, 0.6];
            rings.forEach(r => {
                ctx.beginPath();
                ctx.ellipse(cx, cy, radius * r, radius * r * 0.6, 0, 0, Math.PI * 2);
                ctx.stroke();
            });

            // 将真实经纬度映射到圆盘上的一个点（非真实投影，只做可视化）
            const latClamped = Math.max(-90, Math.min(90, lat));
            const lngWrapped = ((lng + 180) % 360 + 360) % 360 - 180;
            const normLat = 1 - (latClamped + 90) / 180; // 0~1
            const normLng = (lngWrapped + 180) / 360;    // 0~1
            const rPos = radius * 0.85 * (0.4 + 0.6 * normLat);
            const theta = (normLng - 0.5) * Math.PI * 2;
            const px = cx + rPos * Math.sin(theta);
            const py = cy + rPos * Math.cos(theta);

            // 位置高亮点
            const glowGrad = ctx.createRadialGradient(px, py, 0, px, py, 18);
            glowGrad.addColorStop(0, 'rgba(56,189,248,0.9)');
            glowGrad.addColorStop(1, 'rgba(56,189,248,0)');
            ctx.beginPath();
            ctx.arc(px, py, 18, 0, Math.PI * 2);
            ctx.fillStyle = glowGrad;
            ctx.fill();

            ctx.beginPath();
            ctx.arc(px, py, 5, 0, Math.PI * 2);
            ctx.fillStyle = '#0ea5e9';
            ctx.fill();
            ctx.strokeStyle = 'rgba(255,255,255,0.9)';
            ctx.lineWidth = 2;
            ctx.stroke();

            // 下方信息条（当前抽象坐标）
            const barH = 32;
            const barY = h - barH - 6;
            const barRadius = 14;
            ctx.beginPath();
            ctx.moveTo(12 + barRadius, barY);
            ctx.lineTo(w - 12 - barRadius, barY);
            ctx.quadraticCurveTo(w - 12, barY, w - 12, barY + barRadius);
            ctx.lineTo(w - 12, barY + barH - barRadius);
            ctx.quadraticCurveTo(w - 12, barY + barH, w - 12 - barRadius, barY + barH);
            ctx.lineTo(12 + barRadius, barY + barH);
            ctx.quadraticCurveTo(12, barY + barH, 12, barY + barH - barRadius);
            ctx.lineTo(12, barY + barRadius);
            ctx.quadraticCurveTo(12, barY, 12 + barRadius, barY);
            const barGrad = ctx.createLinearGradient(0, barY, 0, barY + barH);
            barGrad.addColorStop(0, 'rgba(15,23,42,0.86)');
            barGrad.addColorStop(1, 'rgba(15,23,42,0.72)');
            ctx.fillStyle = barGrad;
            ctx.fill();

            ctx.fillStyle = '#e5e7eb';
            ctx.font = '11px system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';
            ctx.textBaseline = 'middle';
            ctx.fillText('抽象坐标预览 · 非真实街道地图', 22, barY + barH / 2);

            ctx.fillStyle = '#f9fafb';
            const labelText = (label || '位置').toString().slice(0, 10);
            const labelWidth = ctx.measureText(labelText).width;
            ctx.fillText(labelText, w - 22 - labelWidth, barY + barH / 2);
        }

        function updateLocationMapPreview() {
            if (typeof locationPending.lat !== 'number' || typeof locationPending.lng !== 'number') return;
            const lat = locationPending.lat;
            const lng = locationPending.lng;
            const labelInput = (document.getElementById('locationLabelInput').value || '').trim();
            drawAbstractLocationPreview(lat, lng, labelInput);
        }

        function requestCurrentLocation() {
            const statusEl = document.getElementById('locationStatus');
            if (!navigator.geolocation) {
                statusEl.textContent = '当前浏览器不支持地理位置，请手动输入经纬度。';
                return;
            }
            statusEl.textContent = '正在获取当前位置…';
            navigator.geolocation.getCurrentPosition((pos) => {
                const lat = pos.coords.latitude;
                const lng = pos.coords.longitude;
                locationPending.lat = lat;
                locationPending.lng = lng;
                document.getElementById('locationLatInput').value = lat.toFixed(6);
                document.getElementById('locationLngInput').value = lng.toFixed(6);
                updateLocationMapPreview();
                statusEl.textContent = '已获取当前位置，可以微调后发送。';
            }, (err) => {
                statusEl.textContent = '获取位置失败：' + (err && err.message ? err.message : '请检查浏览器权限或手动输入。');
            }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 });
        }

        function sendLocationMessage() {
            if (!currentChatRelationId) return;
            if (typeof locationPending.lat !== 'number' || typeof locationPending.lng !== 'number') return;
            if (!gameState.chatLogs[currentChatRelationId]) gameState.chatLogs[currentChatRelationId] = [];
            const labelInput = (document.getElementById('locationLabelInput').value || '').trim();
            const actionType = locationPending.action || 'send-location';
            const msg = {
                from: 'me',
                location: {
                    lat: locationPending.lat,
                    lng: locationPending.lng,
                    label: labelInput,
                    type: actionType
                }
            };
            gameState.chatLogs[currentChatRelationId].push(msg);
            // share-location 模式下，记录共享状态并更新状态栏，可多次更新位置
            if (actionType === 'share-location') {
                setCurrentLocationShare({
                    active: true,
                    lat: locationPending.lat,
                    lng: locationPending.lng,
                    label: labelInput,
                    startedAt: Date.now()
                });
            }
            renderChatMessages();
            closeLocationModal();
            saveGame();
        }

        function openTransferStyleLibrary() {
            currentStyleType = 'transfer';
            renderStyleLibrary('transfer');
            document.getElementById('transferStyleModal').classList.add('show');
            document.getElementById('transferStyleOverlay').classList.add('show');
        }
        function closeTransferStyleLibrary() {
            document.getElementById('transferStyleModal').classList.remove('show');
            document.getElementById('transferStyleOverlay').classList.remove('show');
        }
        function openRedpackStyleLibrary() {
            currentStyleType = 'redpack';
            renderStyleLibrary('redpack');
            document.getElementById('redpackStyleModal').classList.add('show');
            document.getElementById('redpackStyleOverlay').classList.add('show');
        }
        function closeRedpackStyleLibrary() {
            document.getElementById('redpackStyleModal').classList.remove('show');
            document.getElementById('redpackStyleOverlay').classList.remove('show');
        }
        function renderStyleLibrary(type) {
            const preset = type === 'transfer' ? TRANSFER_STYLES_PRESET : REDPACK_STYLES_PRESET;
            const custom = type === 'transfer' ? (userSettings.transferStyles || []) : (userSettings.redpackStyles || []);
            const currentId = type === 'transfer' ? userSettings.currentTransferStyle : userSettings.currentRedpackStyle;
            const gridId = type === 'transfer' ? 'transferStyleGrid' : 'redpackStyleGrid';
            const grid = document.getElementById(gridId);
            const allStyles = [...preset, ...custom];
            grid.innerHTML = allStyles.map(s => {
                const isActive = s.id === currentId;
                const gradientDir = s.gradientDir || '180deg';
                const radius = s.radius || 8;
                const amountSize = s.amountSize || 36;
                const amountColor = s.amountColor || '#333';
                return `<div class="style-library-item ${isActive ? 'active' : ''}" data-style-id="${s.id}" data-style-type="${type}">
                    <div class="style-library-item-preview" style="background: linear-gradient(${gradientDir}, ${s.bg1}, ${s.bg2}); border-radius: ${radius}px;">
                        <div style="flex:1;display:flex;align-items:center;justify-content:center;">
                            <div style="font-size:${amountSize}px;font-weight:500;color:${amountColor};">¥0.00</div>
                        </div>
                        <div class="style-library-item-name">${escapeHtml(s.name)}</div>
                    </div>
                </div>`;
            }).join('');
            grid.querySelectorAll('.style-library-item').forEach(item => {
                item.addEventListener('click', () => {
                    const styleId = item.dataset.styleId;
                    const styleType = item.dataset.styleType;
                    if (styleType === 'transfer') {
                        userSettings.currentTransferStyle = styleId;
                    } else {
                        userSettings.currentRedpackStyle = styleId;
                    }
                    saveApiSettings();
                    renderStyleLibrary(styleType);
                });
            });
        }
        function getCurrentStyle(type) {
            const preset = type === 'transfer' ? TRANSFER_STYLES_PRESET : REDPACK_STYLES_PRESET;
            const custom = type === 'transfer' ? (userSettings.transferStyles || []) : (userSettings.redpackStyles || []);
            const currentId = type === 'transfer' ? userSettings.currentTransferStyle : userSettings.currentRedpackStyle;
            return [...preset, ...custom].find(s => s.id === currentId) || preset[0];
        }
        function openStyleCustomModal() {
            currentEditingStyle = null;
            const isTransfer = currentStyleType === 'transfer';
            const defaultStyle = isTransfer ? TRANSFER_STYLES_PRESET[0] : REDPACK_STYLES_PRESET[0];
            
            // 更新标题
            document.getElementById('styleCustomTitle').textContent = isTransfer ? '自定义转账样式' : '自定义红包样式';
            
            // 显示/隐藏标题相关字段（转账显示，红包隐藏）
            const titleSection = document.getElementById('styleCustomTitleSection');
            const titleColorField = document.getElementById('styleCustomTitleColorField');
            const titleSizeField = document.getElementById('styleCustomTitleSizeField');
            if (isTransfer) {
                titleSection.style.display = 'block';
                titleColorField.style.display = 'block';
                titleSizeField.style.display = 'block';
            } else {
                titleSection.style.display = 'none';
                titleColorField.style.display = 'none';
                titleSizeField.style.display = 'none';
            }
            
            // 更新备注/祝福语标签
            const noteSectionTitle = document.getElementById('styleCustomNoteSectionTitle');
            const noteLabel = document.getElementById('styleCustomNoteLabel');
            const noteSizeLabel = document.getElementById('styleCustomNoteSizeLabel');
            if (isTransfer) {
                noteSectionTitle.textContent = '备注文字';
                noteLabel.textContent = '备注颜色';
                noteSizeLabel.textContent = '备注字体大小（px）';
            } else {
                noteSectionTitle.textContent = '祝福语文字';
                noteLabel.textContent = '祝福语颜色';
                noteSizeLabel.textContent = '祝福语字体大小（px）';
            }
            
            document.getElementById('styleCustomNameInput').value = '';
            document.getElementById('styleCustomColor1Input').value = defaultStyle.bg1;
            document.getElementById('styleCustomColor1Text').value = defaultStyle.bg1;
            document.getElementById('styleCustomColor2Input').value = defaultStyle.bg2;
            document.getElementById('styleCustomColor2Text').value = defaultStyle.bg2;
            document.getElementById('styleCustomGradientDir').value = defaultStyle.gradientDir || '180deg';
            document.getElementById('styleCustomWidthInput').value = defaultStyle.width || 240;
            document.getElementById('styleCustomRadiusInput').value = defaultStyle.radius || 8;
            document.getElementById('styleCustomAmountColorInput').value = defaultStyle.amountColor;
            document.getElementById('styleCustomAmountColorText').value = defaultStyle.amountColor;
            document.getElementById('styleCustomAmountSizeInput').value = defaultStyle.amountSize || 36;
            document.getElementById('styleCustomUnitSizeInput').value = defaultStyle.unitSize || 20;
            document.getElementById('styleCustomTitleColorInput').value = defaultStyle.titleColor || '#333';
            document.getElementById('styleCustomTitleColorText').value = defaultStyle.titleColor || '#333';
            document.getElementById('styleCustomTitleSizeInput').value = defaultStyle.titleSize || 14;
            document.getElementById('styleCustomNoteColorInput').value = defaultStyle.noteColor || '#888';
            document.getElementById('styleCustomNoteColorText').value = defaultStyle.noteColor || '#888';
            document.getElementById('styleCustomNoteSizeInput').value = defaultStyle.noteSize || 13;
            document.getElementById('styleCustomIconColorInput').value = defaultStyle.iconColor || '#07c160';
            document.getElementById('styleCustomIconColorText').value = defaultStyle.iconColor || '#07c160';
            document.getElementById('styleCustomIconSizeInput').value = defaultStyle.iconSize || 24;
            document.getElementById('styleCustomBorderWidthInput').value = defaultStyle.borderWidth || 1;
            document.getElementById('styleCustomBorderColorInput').value = defaultStyle.borderColor || '#000000';
            document.getElementById('styleCustomBorderColorText').value = defaultStyle.borderColor || '#000000';
            document.getElementById('styleCustomBorderOpacityInput').value = defaultStyle.borderOpacity || 0.08;
            document.getElementById('styleCustomShadowXInput').value = defaultStyle.shadowX || 0;
            document.getElementById('styleCustomShadowYInput').value = defaultStyle.shadowY || 2;
            document.getElementById('styleCustomShadowBlurInput').value = defaultStyle.shadowBlur || 8;
            document.getElementById('styleCustomShadowSpreadInput').value = defaultStyle.shadowSpread || 0;
            document.getElementById('styleCustomShadowColorInput').value = defaultStyle.shadowColor || '#000000';
            document.getElementById('styleCustomShadowColorText').value = defaultStyle.shadowColor || '#000000';
            document.getElementById('styleCustomShadowOpacityInput').value = defaultStyle.shadowOpacity || 0.1;
            document.getElementById('styleCustomHeadPaddingInput').value = defaultStyle.headPadding || 12;
            document.getElementById('styleCustomBodyPaddingInput').value = defaultStyle.bodyPadding || 20;
            document.getElementById('styleCustomHeadBgInput').value = defaultStyle.headBg || '#ffffff';
            document.getElementById('styleCustomHeadBgText').value = defaultStyle.headBg || '#ffffff';
            document.getElementById('styleCustomHeadBorderInput').value = defaultStyle.headBorder || '#f0f0f0';
            document.getElementById('styleCustomHeadBorderText').value = defaultStyle.headBorder || '#f0f0f0';
            document.getElementById('styleCustomBodyBgInput').value = defaultStyle.bodyBg || '#ffffff';
            document.getElementById('styleCustomBodyBgText').value = defaultStyle.bodyBg || '#ffffff';
            document.querySelectorAll('.style-custom-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.style-custom-tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector('.style-custom-tab[data-tab="basic"]').classList.add('active');
            document.getElementById('styleTabBasic').classList.add('active');
            updateStylePreview();
            document.getElementById('styleCustomModal').classList.add('show');
            document.getElementById('styleCustomOverlay').classList.add('show');
        }
        function closeStyleCustomModal() {
            document.getElementById('styleCustomModal').classList.remove('show');
            document.getElementById('styleCustomOverlay').classList.remove('show');
        }
        function updateStylePreview() {
            const bg1 = document.getElementById('styleCustomColor1Text').value || '#ff5442';
            const bg2 = document.getElementById('styleCustomColor2Text').value || '#e53e3e';
            const gradientDir = document.getElementById('styleCustomGradientDir').value || '180deg';
            const width = parseInt(document.getElementById('styleCustomWidthInput').value || '240', 10);
            const radius = parseInt(document.getElementById('styleCustomRadiusInput').value || '8', 10);
            const amountColor = document.getElementById('styleCustomAmountColorText').value || '#ff5442';
            const amountSize = parseInt(document.getElementById('styleCustomAmountSizeInput').value || '36', 10);
            const unitSize = parseInt(document.getElementById('styleCustomUnitSizeInput').value || '20', 10);
            const titleColor = document.getElementById('styleCustomTitleColorText').value || '#333';
            const titleSize = parseInt(document.getElementById('styleCustomTitleSizeInput').value || '14', 10);
            const noteColor = document.getElementById('styleCustomNoteColorText').value || '#888';
            const noteSize = parseInt(document.getElementById('styleCustomNoteSizeInput').value || '13', 10);
            const iconColor = document.getElementById('styleCustomIconColorText').value || '#07c160';
            const iconSize = parseInt(document.getElementById('styleCustomIconSizeInput').value || '24', 10);
            const borderWidth = parseInt(document.getElementById('styleCustomBorderWidthInput').value || '1', 10);
            const borderColor = document.getElementById('styleCustomBorderColorText').value || '#000000';
            const borderOpacity = parseFloat(document.getElementById('styleCustomBorderOpacityInput').value || '0.08', 10);
            const shadowX = parseInt(document.getElementById('styleCustomShadowXInput').value || '0', 10);
            const shadowY = parseInt(document.getElementById('styleCustomShadowYInput').value || '2', 10);
            const shadowBlur = parseInt(document.getElementById('styleCustomShadowBlurInput').value || '8', 10);
            const shadowSpread = parseInt(document.getElementById('styleCustomShadowSpreadInput').value || '0', 10);
            const shadowColor = document.getElementById('styleCustomShadowColorText').value || '#000000';
            const shadowOpacity = parseFloat(document.getElementById('styleCustomShadowOpacityInput').value || '0.1', 10);
            const headBg = document.getElementById('styleCustomHeadBgText').value || '#ffffff';
            const bodyBg = document.getElementById('styleCustomBodyBgText').value || '#ffffff';
            const headPadding = parseInt(document.getElementById('styleCustomHeadPaddingInput').value || '12', 10);
            const bodyPadding = parseInt(document.getElementById('styleCustomBodyPaddingInput').value || '20', 10);
            const borderColorRgba = hexToRgba(borderColor, borderOpacity);
            const shadowColorRgba = hexToRgba(shadowColor, shadowOpacity);
            const shadow = `${shadowX}px ${shadowY}px ${shadowBlur}px ${shadowSpread}px ${shadowColorRgba}`;
            const preview = document.getElementById('styleCustomPreview');
            const isRedpack = currentStyleType === 'redpack';
            preview.innerHTML = `<div style="width:${Math.min(width, 200)}px;border-radius:${radius}px;background:linear-gradient(${gradientDir},${bg1},${bg2});border:${borderWidth}px solid ${borderColorRgba};box-shadow:${shadow};overflow:hidden;">
                <div style="padding:${headPadding}px;background:${headBg};display:flex;align-items:center;gap:8px;">
                    <div style="width:${iconSize}px;height:${iconSize}px;color:${iconColor};display:flex;align-items:center;justify-content:center;">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="width:100%;height:100%;display:block">
                            <circle cx="12" cy="12" r="8" fill="none" stroke="currentColor" stroke-width="1.8"/>
                            <path d="M10 9h3a2 2 0 010 4h-2a2 2 0 000 4h3" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M12 8v1M12 19v-1" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
                        </svg>
                    </div>
                    <span style="font-size:${titleSize}px;color:${titleColor};font-weight:500;">${isRedpack ? '红包' : '转账'}</span>
                </div>
                <div style="padding:${bodyPadding}px;background:${bodyBg};text-align:center;">
                    <div style="font-size:${amountSize}px;font-weight:500;color:${amountColor};line-height:1;">
                        <span style="font-size:${unitSize}px;">¥</span>0.00
                    </div>
                    ${isRedpack ? `<div style="margin-top:8px;font-size:${noteSize}px;color:${noteColor};">祝福语</div>` : `<div style="margin-top:16px;padding-top:16px;border-top:1px solid #f0f0f0;font-size:${noteSize}px;color:${noteColor};text-align:left;">备注</div>`}
                </div>
            </div>`;
        }
        function hexToRgba(hex, alpha) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }
        function saveCustomStyle() {
            const name = (document.getElementById('styleCustomNameInput').value || '').trim();
            if (!name) { alert('请输入样式名称'); return; }
            const style = {
                id: 'custom_' + Date.now(),
                name,
                bg1: document.getElementById('styleCustomColor1Text').value.trim() || '#ff5442',
                bg2: document.getElementById('styleCustomColor2Text').value.trim() || '#e53e3e',
                gradientDir: document.getElementById('styleCustomGradientDir').value || '180deg',
                width: parseInt(document.getElementById('styleCustomWidthInput').value || '240', 10),
                radius: parseInt(document.getElementById('styleCustomRadiusInput').value || '8', 10),
                amountColor: document.getElementById('styleCustomAmountColorText').value.trim() || '#ff5442',
                amountSize: parseInt(document.getElementById('styleCustomAmountSizeInput').value || '36', 10),
                unitSize: parseInt(document.getElementById('styleCustomUnitSizeInput').value || '20', 10),
                titleColor: document.getElementById('styleCustomTitleColorText').value.trim() || '#333',
                titleSize: parseInt(document.getElementById('styleCustomTitleSizeInput').value || '14', 10),
                noteColor: document.getElementById('styleCustomNoteColorText').value.trim() || '#888',
                noteSize: parseInt(document.getElementById('styleCustomNoteSizeInput').value || '13', 10),
                iconColor: document.getElementById('styleCustomIconColorText').value.trim() || '#07c160',
                iconSize: parseInt(document.getElementById('styleCustomIconSizeInput').value || '24', 10),
                borderWidth: parseInt(document.getElementById('styleCustomBorderWidthInput').value || '1', 10),
                borderColor: document.getElementById('styleCustomBorderColorText').value.trim() || '#000000',
                borderOpacity: parseFloat(document.getElementById('styleCustomBorderOpacityInput').value || '0.08', 10),
                shadowX: parseInt(document.getElementById('styleCustomShadowXInput').value || '0', 10),
                shadowY: parseInt(document.getElementById('styleCustomShadowYInput').value || '2', 10),
                shadowBlur: parseInt(document.getElementById('styleCustomShadowBlurInput').value || '8', 10),
                shadowSpread: parseInt(document.getElementById('styleCustomShadowSpreadInput').value || '0', 10),
                shadowColor: document.getElementById('styleCustomShadowColorText').value.trim() || '#000000',
                shadowOpacity: parseFloat(document.getElementById('styleCustomShadowOpacityInput').value || '0.1', 10),
                headPadding: parseInt(document.getElementById('styleCustomHeadPaddingInput').value || '12', 10),
                bodyPadding: parseInt(document.getElementById('styleCustomBodyPaddingInput').value || '20', 10),
                headBg: document.getElementById('styleCustomHeadBgText').value.trim() || '#ffffff',
                headBorder: document.getElementById('styleCustomHeadBorderText').value.trim() || '#f0f0f0',
                bodyBg: document.getElementById('styleCustomBodyBgText').value.trim() || '#ffffff'
            };
            if (currentStyleType === 'transfer') {
                if (!userSettings.transferStyles) userSettings.transferStyles = [];
                userSettings.transferStyles.push(style);
                userSettings.currentTransferStyle = style.id;
            } else {
                if (!userSettings.redpackStyles) userSettings.redpackStyles = [];
                userSettings.redpackStyles.push(style);
                userSettings.currentRedpackStyle = style.id;
            }
            saveApiSettings();
            if (currentStyleType === 'transfer') {
                renderStyleLibrary('transfer');
            } else {
                renderStyleLibrary('redpack');
            }
            closeStyleCustomModal();
        }

        let lastGiftSearchResults = [];

        function openGiftPanel() {
            closeChatPlusMenu();
            document.getElementById('giftSearchInput').value = '';
            if (lastGiftSearchResults && lastGiftSearchResults.length > 0) {
                renderGiftGrid(lastGiftSearchResults);
            } else {
                document.getElementById('giftGrid').innerHTML = '';
                document.getElementById('giftEmptyHint').style.display = 'block';
            }
            document.getElementById('giftLoadingHint').style.display = 'none';
            document.getElementById('giftPanel').classList.add('show');
        }

        function closeGiftPanel() {
            document.getElementById('giftPanel').classList.remove('show');
        }

        /** 无 API 时的兜底图（Picsum，与礼物名无关） */
        function getGiftImageUrl(name) {
            const seed = (name || 'gift').toString().trim() || 'gift';
            return 'https://picsum.photos/seed/' + encodeURIComponent(seed) + '/400/400';
        }

        /** 内置 Pexels API Key，未在设置中填写时使用 */
        const PEXELS_BUILTIN_KEY = '4hWRHWXOvNOBFMRQQ69zPgsKvI6udyL3k3AHXCBxuEzB7cdlmjUbtQZU';
        /** 使用 Pexels API 按礼物名称搜索对应图片 */
        async function fetchGiftImageFromPexels(keyword) {
            const key = (userSettings.pexelsKey || '').trim() || PEXELS_BUILTIN_KEY;
            if (!key) return null;
            let q = (keyword || 'gift').toString().trim() || 'gift';
            if (!/gift|present|bouquet|box|bottle|toy|bracelet|watch|book|chocolate|flower|perfume/i.test(q)) q = q + ' gift';
            const query = encodeURIComponent(q);
            try {
                const res = await fetch('https://api.pexels.com/v1/search?query=' + query + '&per_page=1', {
                    headers: { 'Authorization': key }
                });
                if (!res.ok) return null;
                const data = await res.json();
                const photo = data.photos && data.photos[0];
                if (photo && photo.src && (photo.src.medium || photo.src.large)) return photo.src.medium || photo.src.large;
                return null;
            } catch (e) {
                return null;
            }
        }

        let currentGiftDetail = null;

        function openGiftDetailModal(gift) {
            if (!gift) return;
            currentGiftDetail = gift;
            const imgUrl = gift.imageUrl || gift.img || gift.image || getGiftImageUrl(gift.name || gift.title);
            document.getElementById('giftDetailPic').src = imgUrl;
            document.getElementById('giftDetailName').textContent = gift.name || gift.title || '未命名';
            document.getElementById('giftDetailPrice').textContent = gift.price != null ? '¥' + gift.price : '';
            document.getElementById('giftDetailPrice').style.display = gift.price != null ? '' : 'none';
            document.getElementById('giftDetailDesc').textContent = gift.desc || gift.description || '';
            document.getElementById('giftDetailDesc').style.display = (gift.desc || gift.description) ? '' : 'none';
            document.getElementById('giftDetailOverlay').classList.add('show');
        }

        function closeGiftDetailModal() {
            document.getElementById('giftDetailOverlay').classList.remove('show');
            currentGiftDetail = null;
        }

        function renderGiftGrid(items) {
            const grid = document.getElementById('giftGrid');
            const emptyHint = document.getElementById('giftEmptyHint');
            const loadingHint = document.getElementById('giftLoadingHint');
            if (loadingHint) loadingHint.style.display = 'none';
            if (!items || items.length === 0) {
                grid.innerHTML = '';
                emptyHint.style.display = 'block';
                emptyHint.textContent = '未找到相关礼物，换个关键词试试';
                return;
            }
            emptyHint.style.display = 'none';
            grid.innerHTML = items.map((g, i) => {
                const name = escapeHtml((g.name || g.title || '').toString());
                const desc = escapeHtml((g.desc || g.description || '').toString());
                const price = escapeHtml((g.price != null ? g.price : '').toString());
                const imgUrl = g.imageUrl || g.img || g.image || getGiftImageUrl(g.name || g.title);
                const img = `<img src="${escapeHtml(imgUrl)}" alt="">`;
                return `<div class="gift-cell" data-idx="${i}">
                    <div class="gift-cell-pic">${img}</div>
                    <div class="gift-cell-info">
                        <div class="gift-cell-name">${name || '未命名'}</div>
                        ${desc ? `<div class="gift-cell-desc">${desc}</div>` : ''}
                        ${price ? `<div class="gift-cell-price">¥${price}</div>` : ''}
                    </div>
                </div>`;
            }).join('');
            grid.querySelectorAll('.gift-cell').forEach(cell => {
                cell.addEventListener('click', () => {
                    const idx = parseInt(cell.dataset.idx, 10);
                    const g = items[idx];
                    if (g) openGiftDetailModal(g);
                });
            });
        }

        async function searchGifts() {
            const input = document.getElementById('giftSearchInput');
            const keyword = (input && input.value || '').trim();
            const emptyHint = document.getElementById('giftEmptyHint');
            const loadingHint = document.getElementById('giftLoadingHint');
            const grid = document.getElementById('giftGrid');
            const btn = document.getElementById('giftSearchBtn');
            if (!userSettings.api || !userSettings.api.endpoint || !userSettings.api.key) {
                emptyHint.style.display = 'block';
                emptyHint.textContent = '请先在设置中配置 API';
                loadingHint.style.display = 'none';
                return;
            }
            grid.innerHTML = '';
            emptyHint.style.display = 'none';
            loadingHint.style.display = 'block';
            if (btn) btn.disabled = true;
            const sysPrompt = `你是礼物推荐助手。根据用户关键词返回一个JSON数组，必须返回12-15个礼物。
每项必须包含：
- name: 礼物中文名称
- desc: 简短描述
- price: 价格数字或字符串（可选）
- imageKeyword: 英文搜图关键词，必须与name一一对应、描述同一件礼物，用于搜索到与礼物名称贴合的配图。要求：2-5个英文单词，具体到物品形态，如「巧克力」用 chocolate gift box，「鲜花」用 fresh flower bouquet，「手链」用 silver bracelet，「玩偶」用 stuffed toy plush，「香水」用 perfume bottle，「书籍」用 book gift。imageKeyword 要能让图库搜到与name完全对应的商品/礼物照片。
只返回纯JSON数组，不要其他文字、markdown或说明。`;
            const userContent = keyword || '随机推荐一些适合送人的礼物';
            let endpoint = userSettings.api.endpoint.trim();
            if (!endpoint.endsWith('/chat/completions')) {
                endpoint = endpoint.replace(/\/$/, '') + '/chat/completions';
            }
            try {
                const res = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + userSettings.api.key },
                    body: JSON.stringify({
                        model: userSettings.api.model || 'gpt-3.5-turbo',
                        messages: [
                            { role: 'system', content: sysPrompt },
                            { role: 'user', content: userContent }
                        ]
                    })
                });
                if (!res.ok) {
                    const errorText = await res.text();
                    throw new Error(`API返回错误 ${res.status}: ${errorText.slice(0, 100)}`);
                }
                const data = await res.json();
                let content = (data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content) ? data.choices[0].message.content.trim() : '';
                if (!content) throw new Error('未返回内容');
                content = content.replace(/^```(?:json)?\s*/i, '').replace(/\s*```$/i, '').trim();
                const list = JSON.parse(content);
                const arr = Array.isArray(list) ? list : [];
                for (const g of arr) {
                    if (g.imageUrl || g.img || g.image) continue;
                    const searchWord = (g.imageKeyword || g.image_keyword || '').toString().trim() || (g.name || g.title || '').toString().trim();
                    g.imageUrl = await fetchGiftImageFromPexels(searchWord) || getGiftImageUrl(g.name || g.title);
                }
                lastGiftSearchResults = arr;
                renderGiftGrid(arr);
            } catch (e) {
                console.error('搜索礼物失败:', e);
                emptyHint.style.display = 'block';
                emptyHint.textContent = '搜索失败：' + (e.message || '请检查 API 配置');
                renderGiftGrid([]);
            } finally {
                loadingHint.style.display = 'none';
                if (btn) btn.disabled = false;
            }
        }

        function sendImageMessage() {
            if (!currentChatRelationId || !imageSendPending.src) return;
            if (!gameState.chatLogs[currentChatRelationId]) gameState.chatLogs[currentChatRelationId] = [];
            gameState.chatLogs[currentChatRelationId].push({ from: 'me', imageSrc: imageSendPending.src, imageDesc: imageSendPending.desc || '' });
            renderChatMessages();
            closeImageSendModal();
            saveGame();
        }

        function renderChatMessages() {
            const container = document.getElementById('chatMessages');
            const logs = (gameState.chatLogs && currentChatRelationId && gameState.chatLogs[currentChatRelationId]) || [];
            const r = gameState.relations.find(x => x.id === currentChatRelationId);
            const otherName = r ? r.name[0] : '?';
            container.innerHTML = logs.map((msg, idx) => {
                let bubble;
                if (msg.transferAccepted) {
                    const ta = msg.transferAccepted;
                    const amt = escapeHtml((ta.amount != null ? ta.amount : '').toString());
                    const note = escapeHtml((ta.note || '').toString());
                    const style = getCurrentStyle('transfer');
                    const safeHex6 = (c, fallback) => (/^#[0-9A-Fa-f]{6}$/.test((c || '').toString().trim()) ? c.toString().trim() : fallback);
                    const borderColor = safeHex6(style.borderColor, '#000000');
                    const shadowColor = safeHex6(style.shadowColor, '#000000');
                    const iconColor = safeHex6(style.iconColor, '#07c160');
                    const titleColor = safeHex6(style.titleColor, '#333333');
                    const noteColor = safeHex6(style.noteColor, '#999999');
                    const borderColorRgba = hexToRgba(borderColor, style.borderOpacity ?? 0.08);
                    const shadowColorRgba = hexToRgba(shadowColor, style.shadowOpacity ?? 0.1);
                    const iconBg = hexToRgba(iconColor, 0.12);
                    const shadow = `${style.shadowX || 0}px ${style.shadowY || 2}px ${style.shadowBlur || 8}px ${style.shadowSpread || 0}px ${shadowColorRgba}`;
                    bubble = `<div class="chat-msg-transfer-accepted-card" style="width:${style.width || 240}px;border-radius:${style.radius || 8}px;border:${style.borderWidth || 1}px solid ${borderColorRgba};box-shadow:${shadow};background:${style.bodyBg || '#ffffff'};">
                        <div class="chat-msg-transfer-accepted-card-icon" style="background:${iconBg};color:${iconColor};">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M20 6L9 17l-5-5"/>
                            </svg>
                        </div>
                        <div class="chat-msg-transfer-accepted-card-info">
                            <div class="chat-msg-transfer-accepted-card-title" style="color:${titleColor};">转账已接收</div>
                            <div class="chat-msg-transfer-accepted-card-amount" style="color:${noteColor};">收款 ￥${amt}${note ? ' · ' + note : ''}</div>
                        </div>
                    </div>`;
                } else if (msg.transfer) {
                    const t = msg.transfer;
                    const amt = escapeHtml((t.amount != null ? t.amount : '').toString());
                    const note = escapeHtml((t.note || '').toString());
                    const isAccepted = t.accepted === true;
                    const isFromOther = msg.from === 'other';
                    const style = getCurrentStyle('transfer');
                    const borderColorRgba = hexToRgba(style.borderColor || '#000000', style.borderOpacity || 0.08);
                    const shadowColorRgba = hexToRgba(style.shadowColor || '#000000', style.shadowOpacity || 0.1);
                    const shadow = `${style.shadowX || 0}px ${style.shadowY || 2}px ${style.shadowBlur || 8}px ${style.shadowSpread || 0}px ${shadowColorRgba}`;
                    const acceptedClass = isAccepted ? 'accepted' : '';
                    const clickableAttr = (isFromOther && !isAccepted) ? `data-msg-idx="${idx}" data-transfer-accepted="false"` : `data-transfer-accepted="${isAccepted}"`;
                    bubble = `<div class="chat-msg-transfer-card ${acceptedClass}" ${clickableAttr} style="width: ${style.width || 240}px; background: linear-gradient(${style.gradientDir || '180deg'}, ${style.bg1}, ${style.bg2}); border-radius: ${style.radius || 8}px; border: ${style.borderWidth || 1}px solid ${borderColorRgba}; box-shadow: ${shadow};">
                        <div class="chat-msg-transfer-head" style="padding: ${style.headPadding || 12}px 16px; background: ${style.headBg || '#ffffff'}; border-bottom: 1px solid ${style.headBorder || '#f0f0f0'};">
                            <div class="chat-msg-transfer-icon" style="width: ${style.iconSize || 24}px; height: ${style.iconSize || 24}px; color: ${style.iconColor || '#07c160'};"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20M17 7H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg></div>
                            <span class="chat-msg-transfer-title" style="font-size: ${style.titleSize || 14}px; color: ${style.titleColor || '#333'};">
                                转账
                            </span>
                        </div>
                        <div class="chat-msg-transfer-body" style="padding: ${style.bodyPadding || 20}px 16px; background: ${style.bodyBg || '#ffffff'};">
                            <div class="chat-msg-transfer-amount" style="color: ${style.amountColor}; font-size: ${style.amountSize || 36}px;">
                                <span class="unit" style="font-size: ${style.unitSize || 20}px;">¥</span>${amt}
                            </div>
                            ${note ? `<div class="chat-msg-transfer-note" style="color: ${style.noteColor || '#888'}; font-size: ${style.noteSize || 13}px;">${note}</div>` : ''}
                        </div>
                    </div>`;
                } else if (msg.redpack) {
                    const rp = msg.redpack;
                    const amt = escapeHtml((rp.amount != null ? rp.amount : '').toString());
                    const blessing = escapeHtml((rp.blessing || '').toString());
                    const isOpened = rp.opened === true;
                    const style = getCurrentStyle('redpack');
                    const borderColorRgba = hexToRgba(style.borderColor || '#000000', style.borderOpacity || 0);
                    const shadowColorRgba = hexToRgba(style.shadowColor || '#000000', style.shadowOpacity || 0.1);
                    const shadow = `${style.shadowX || 0}px ${style.shadowY || 2}px ${style.shadowBlur || 8}px ${style.shadowSpread || 0}px ${shadowColorRgba}`;
                    bubble = `<div class="chat-msg-redpack-card" data-msg-idx="${idx}" style="width: ${style.width || 240}px; background: linear-gradient(${style.gradientDir || '180deg'}, ${style.bg1}, ${style.bg2}); border-radius: ${style.radius || 8}px; border: ${style.borderWidth || 0}px solid ${borderColorRgba}; box-shadow: ${shadow};">
                        <div class="chat-msg-redpack-head" style="padding: ${style.headPadding || 12}px 16px; background: ${style.headBg || 'transparent'};">
                            <div class="chat-msg-redpack-icon" style="width: ${style.iconSize || 24}px; height: ${style.iconSize || 24}px; color: ${style.iconColor || '#fff'};"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="8" width="18" height="12" rx="1"/><path d="M12 8v12M3 12h18"/><path d="M7 8V6a2 2 0 012-2h6a2 2 0 012 2v2"/></svg></div>
                        </div>
                        <div class="chat-msg-redpack-body" style="padding: ${style.bodyPadding || 24}px 16px; background: ${style.bodyBg || '#ffffff'};">
                            <div class="chat-msg-redpack-amount ${isOpened ? 'opened' : ''}" style="color: ${style.amountColor}; font-size: ${style.amountSize || 36}px;">
                                <span class="unit" style="font-size: ${style.unitSize || 20}px;">¥</span>${amt}
                            </div>
                            <div class="chat-msg-redpack-open-btn ${isOpened ? 'opened' : ''}" data-msg-idx="${idx}">開</div>
                            ${blessing ? `<div class="chat-msg-redpack-blessing" style="color: ${style.noteColor || '#999'}; font-size: ${style.noteSize || 12}px;">${blessing}</div>` : ''}
                        </div>
                    </div>`;
                } else if (msg.gift) {
                    const g = msg.gift;
                    const imgUrl = g.imageUrl || g.img || g.image || getGiftImageUrl(g.name || g.title);
                    const name = escapeHtml((g.name || g.title || '礼物').toString());
                    const desc = escapeHtml((g.desc || g.description || '').toString());
                    const price = g.price != null ? escapeHtml(g.price.toString()) : '';
                    bubble = `<div class="chat-msg-gift-card">
                        <img class="chat-msg-gift-pic" src="${escapeHtml(imgUrl)}" alt="${name}">
                        <div class="chat-msg-gift-info">
                            <div class="chat-msg-gift-name">${name}</div>
                            ${desc ? `<div class="chat-msg-gift-desc">${desc}</div>` : ''}
                            ${price ? `<div class="chat-msg-gift-price">¥${price}</div>` : ''}
                        </div>
                    </div>`;
                } else if (msg.voiceCallSummary) {
                    const v = msg.voiceCallSummary || {};
                    const secs = typeof v.duration === 'number' && v.duration > 0 ? v.duration : 0;
                    const mm = String(Math.floor(secs / 60)).padStart(2, '0');
                    const ss = String(secs % 60).padStart(2, '0');
                    const durText = secs > 0 ? `${mm}:${ss}` : '00:00';
                    let statusLabel = '语音通话';
                    if (v.status === 'rejected') statusLabel = '未接听的语音通话';
                    else if (v.status === 'ended') statusLabel = '已结束的语音通话';
                    bubble = `<div class="chat-msg-voicecall-card">
                        <div class="chat-msg-voicecall-head">
                            <div class="chat-msg-voicecall-icon" aria-hidden="true">
                                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M7 5l3-2h4l3 2v6a7 7 0 01-14 0V5z" fill="none" stroke="currentColor" stroke-width="1.8"/>
                                    <path d="M10 10v2M14 10v2" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                                </svg>
                            </div>
                            <span>${escapeHtml(statusLabel)}</span>
                        </div>
                        <div class="chat-msg-voicecall-meta">通话时长 ${durText}</div>
                    </div>`;
                } else if (msg.music) {
                    const m = msg.music || {};
                    const title = escapeHtml((m.title || '音乐').toString());
                    const artist = escapeHtml((m.artist || '').toString());
                    const cover = (m.cover || '').toString();
                    const preview = (m.preview || '').toString();
                    const playableAttr = preview ? `data-preview="${escapeHtml(preview)}"` : '';
                    const progressHtml = preview ? `<div class="chat-msg-music-progress-wrap"><div class="chat-msg-music-progress-time"><span class="chat-msg-music-time-current">0:00</span><span class="chat-msg-music-time-total">--:--</span></div><div class="chat-msg-music-progress"><input type="range" min="0" max="100" value="0" step="1"></div></div>` : '';
                    bubble = `<div class="chat-msg-music-card" ${playableAttr}>
                        <div class="chat-msg-music-cover">${cover ? `<img src="${escapeHtml(cover)}" alt="">` : ''}</div>
                        <div class="chat-msg-music-info">
                            <div class="chat-msg-music-title">${title}</div>
                            <div class="chat-msg-music-artist">${artist}</div>
                        </div>
                        ${preview ? `<button type="button" class="chat-msg-music-play" aria-label="播放音乐">
                            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="14" height="14">
                                <path d="M9 7v10l8-5z" fill="currentColor"/>
                            </svg>
                        </button>` : ''}
                        ${progressHtml}
                    </div>`;
                } else if (msg.location) {
                    const loc = msg.location || {};
                    const latNum = typeof loc.lat === 'number' ? loc.lat : parseFloat(loc.lat);
                    const lngNum = typeof loc.lng === 'number' ? loc.lng : parseFloat(loc.lng);
                    const hasCoords = !isNaN(latNum) && !isNaN(lngNum);
                    const latStr = hasCoords ? latNum.toFixed(5) : '';
                    const lngStr = hasCoords ? lngNum.toFixed(5) : '';
                    const label = escapeHtml((loc.label || '位置').toString());
                    const sub = hasCoords ? `纬度 ${latStr} · 经度 ${lngStr}` : '坐标未知';
                    // 将经纬度映射到迷你抽象地图上的一个点（与弹窗预览风格呼应，非真实地图）
                    const normLat = hasCoords ? (1 - (latNum + 90) / 180) : 0.5;
                    const normLng = hasCoords ? ((lngNum + 180) / 360) : 0.5;
                    const dotX = 12 + 16 + normLng * (100 - 16 * 2);
                    const dotY = 4 + 8 + normLat * (46 - 8 * 2);
                    const miniDotStyle = `left:${dotX.toFixed(1)}px;top:${dotY.toFixed(1)}px;`;
                    bubble = `<div class="chat-msg-location-card">
                        <div class="chat-msg-location-pill">位置</div>
                        <div class="chat-msg-location-head">
                            <div class="chat-msg-location-icon" aria-hidden="true">
                                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="14" height="14">
                                    <path d="M12 3.5c-3 0-5.5 2.4-5.5 5.5 0 4.1 4.6 8.6 5.1 9.1.2.2.6.2.8 0 .5-.5 5.1-5 5.1-9.1 0-3.1-2.5-5.5-5.5-5.5z" fill="none" stroke="currentColor" stroke-width="1.6"/>
                                    <circle cx="12" cy="9" r="2.1" fill="none" stroke="currentColor" stroke-width="1.6"/>
                                </svg>
                            </div>
                            <div class="chat-msg-location-title">${label}</div>
                        </div>
                        <div class="chat-msg-location-sub">${escapeHtml(sub)}</div>
                        <div class="chat-msg-location-mini-map">
                            <div class="chat-msg-location-mini-map-grid"></div>
                            <div class="chat-msg-location-mini-dot" style="${miniDotStyle}"></div>
                        </div>
                    </div>`;
                } else if (msg.stickerSrc) {
                    bubble = `<div class="chat-msg-bubble"><img src="${escapeHtml(msg.stickerSrc)}" alt="${escapeHtml(msg.stickerDesc || '')}" style="max-width:120px;max-height:120px;border-radius:8px;display:block;"></div>`;
                } else if (msg.imageSrc) {
                    const descHtml = msg.imageDesc ? `<div class="chat-msg-image-desc" data-msg-idx="${idx}">${escapeHtml(msg.imageDesc)}</div>` : '';
                    bubble = `<div class="chat-msg-bubble chat-msg-image" data-msg-idx="${idx}"><img src="${escapeHtml(msg.imageSrc)}" alt="${escapeHtml(msg.imageDesc || '')}" style="max-width:200px;max-height:200px;border-radius:8px;display:block;">${descHtml}</div>`;
                } else {
                    bubble = `<div class="chat-msg-bubble">${escapeHtml(msg.text || '')}</div>`;
                }
                const myAvatar = (gameState.profile && gameState.profile.avatar) ? `<img src="${escapeHtml(gameState.profile.avatar)}" alt="">` : '我';
                const avatarContent = msg.from === 'me' ? myAvatar : (r && r.avatar ? `<img src="${escapeHtml(r.avatar)}" alt="">` : otherName);
                return `<div class="chat-msg ${msg.from === 'me' ? 'mine' : 'other'}">
                    <div class="chat-msg-avatar">${avatarContent}</div>
                    ${bubble}
                </div>`;
            }).join('') || '<div style="text-align:center;color:var(--text-muted);padding:24px;font-size:14px">暂无消息，发一句打个招呼吧</div>';
            container.querySelectorAll('.chat-msg-image').forEach(el => {
                el.addEventListener('click', () => {
                    const idx = el.dataset.msgIdx;
                    const descEl = container.querySelector(`.chat-msg-image-desc[data-msg-idx="${idx}"]`);
                    if (descEl) {
                        descEl.classList.toggle('show');
                    }
                });
            });
            container.querySelectorAll('.chat-msg-redpack-open-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const idx = parseInt(btn.dataset.msgIdx, 10);
                    const logs = (gameState.chatLogs && currentChatRelationId && gameState.chatLogs[currentChatRelationId]) || [];
                    const msg = logs[idx];
                    if (msg && msg.redpack && !msg.redpack.opened) {
                        msg.redpack.opened = true;
                        renderChatMessages();
                        saveGame();
                    }
                });
            });
            container.querySelectorAll('.chat-msg-transfer-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const idx = parseInt(card.dataset.msgIdx, 10);
                    const isAccepted = card.dataset.transferAccepted === 'true';
                    if (isAccepted) return; // 已接受的不再处理
                    const logs = (gameState.chatLogs && currentChatRelationId && gameState.chatLogs[currentChatRelationId]) || [];
                    const msg = logs[idx];
                    if (msg && msg.transfer && !msg.transfer.accepted && msg.from === 'other') {
                        // 只有对方发送的转账才能被接受
                        msg.transfer.accepted = true;
                        renderChatMessages();
                        saveGame();
                    }
                });
            });
            container.scrollTop = container.scrollHeight;
            bindChatMusicPlayers();
        }


        function escapeHtml(s) {
            const div = document.createElement('div');
            div.textContent = s;
            return div.innerHTML;
        }

        function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const text = (input.value || '').trim();
            if (!text || !currentChatRelationId) return;
            if (!gameState.chatLogs[currentChatRelationId]) gameState.chatLogs[currentChatRelationId] = [];
            gameState.chatLogs[currentChatRelationId].push({ from: 'me', text });
            input.value = '';
            renderChatMessages();
            const reply = REPLY_POOL[Math.floor(Math.random() * REPLY_POOL.length)];
            setTimeout(() => {
                if (!currentChatRelationId) return;
                gameState.chatLogs[currentChatRelationId].push({ from: 'other', text: reply });
                renderChatMessages();
                saveGame();
            }, 600 + Math.random() * 800);
            saveGame();
        }

        function renderSaveSlots() {
            const slots = JSON.parse(localStorage.getItem('tabula_saves') || '{}');
            const html = [1, 2, 3].map(i => {
                const s = slots['slot' + i];
                if (!s) return `<div class="save-card"><div class="save-card-header"><div class="save-avatar"></div><div class="save-meta"><div class="save-age">空存档</div><div class="save-detail">点击保存</div></div></div><div class="save-actions"><button class="save-load" disabled>读取</button><button class="save-del" onclick="saveSlot(${i})">保存</button></div></div>`;
                return `<div class="save-card filled"><div class="save-card-header"><div class="save-avatar"></div><div class="save-meta"><div class="save-age">${s.meta.currentAge}岁 · ${s.stats.money}元</div><div class="save-detail">${s.meta.currentYear}年</div></div></div><div class="save-actions"><button class="save-load" onclick="loadSlot(${i})">读取</button><button class="save-del" onclick="delSlot(${i})">删除</button></div></div>`;
            }).join('');
            document.getElementById('saveSlots').innerHTML = html;
        }

        function saveSlot(n) {
            const slots = JSON.parse(localStorage.getItem('tabula_saves') || '{}');
            slots['slot' + n] = JSON.parse(JSON.stringify(gameState));
            localStorage.setItem('tabula_saves', JSON.stringify(slots));
            renderSaveSlots();
            alert('存档成功');
        }

        function loadSlot(n) {
            const slots = JSON.parse(localStorage.getItem('tabula_saves') || '{}');
            const s = slots['slot' + n];
            if (!s) { alert('该存档为空'); return; }
            gameState = JSON.parse(JSON.stringify(s));
            if (!gameState.meta.currentMonth) gameState.meta.currentMonth = 1;
            if (!gameState.meta.currentDay) gameState.meta.currentDay = 1;
            renderStats();
            renderTimeline();
            renderRelations('all');
            updateMap(gameState.meta.currentAge);
            updateDateDisplay();
            document.getElementById('ageBadge').textContent = gameState.meta.currentAge + ' 岁';
            alert('读取成功');
        }

        function delSlot(n) {
            if (!confirm('确定删除该存档？')) return;
            const slots = JSON.parse(localStorage.getItem('tabula_saves') || '{}');
            delete slots['slot' + n];
            localStorage.setItem('tabula_saves', JSON.stringify(slots));
            renderSaveSlots();
        }

        function saveGame() {
            localStorage.setItem('tabula_state', JSON.stringify(gameState));
            localStorage.setItem('tabula_settings', JSON.stringify(userSettings));
        }

        function loadGame() {
            const s = localStorage.getItem('tabula_state');
            const u = localStorage.getItem('tabula_settings');
            if (s) gameState = JSON.parse(s);
            if (u) {
                userSettings = JSON.parse(u);
                if (userSettings.pexelsKey === undefined) userSettings.pexelsKey = '';
                if (!userSettings.transferStyles) userSettings.transferStyles = [];
                if (!userSettings.redpackStyles) userSettings.redpackStyles = [];
                if (!userSettings.currentTransferStyle) userSettings.currentTransferStyle = 'default';
                if (!userSettings.currentRedpackStyle) userSettings.currentRedpackStyle = 'default';
            }
        }

        document.querySelectorAll('.dock-item').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.dock-item').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                btn.classList.add('active');
                const tab = document.getElementById('tab' + btn.dataset.tab.charAt(0).toUpperCase() + btn.dataset.tab.slice(1));
                if (tab) tab.classList.add('active');
            });
        });


        document.getElementById('closeModal').addEventListener('click', () => {
            document.getElementById('interactModal').classList.remove('show');
            document.getElementById('modalOverlay').classList.remove('show');
        });
        document.getElementById('modalOverlay').addEventListener('click', () => {
            document.getElementById('interactModal').classList.remove('show');
            document.getElementById('modalOverlay').classList.remove('show');
        });

        document.getElementById('chatBack').addEventListener('click', closeChat);
        document.getElementById('giftBackBtn').addEventListener('click', closeGiftPanel);
        const giftSearchBtn = document.getElementById('giftSearchBtn');
        const giftSearchInput = document.getElementById('giftSearchInput');
        if (giftSearchBtn) {
            giftSearchBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                searchGifts();
            });
        }
        if (giftSearchInput) {
            giftSearchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    searchGifts();
                }
            });
        }
        document.getElementById('giftDetailOverlay').addEventListener('click', (e) => {
            if (e.target.id === 'giftDetailOverlay') closeGiftDetailModal();
        });
        document.getElementById('giftDetailCancelBtn').addEventListener('click', closeGiftDetailModal);
        document.getElementById('giftDetailSendBtn').addEventListener('click', () => {
            if (!currentGiftDetail || !currentChatRelationId) {
                closeGiftDetailModal();
                return;
            }
            const g = currentGiftDetail;
            if (!gameState.chatLogs[currentChatRelationId]) gameState.chatLogs[currentChatRelationId] = [];
            gameState.chatLogs[currentChatRelationId].push({ 
                from: 'me', 
                gift: {
                    name: g.name || g.title || '礼物',
                    desc: g.desc || g.description || '',
                    price: g.price != null ? g.price : null,
                    imageUrl: g.imageUrl || g.img || g.image || getGiftImageUrl(g.name || g.title)
                }
            });
            renderChatMessages();
            closeGiftDetailModal();
            closeGiftPanel();
            saveGame();
        });
        document.getElementById('chatSend').addEventListener('click', sendChatMessage);
        document.getElementById('chatInput').addEventListener('keydown', e => {
            if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendChatMessage(); }
        });

        // +号菜单处理
        const chatPlusBtn = document.getElementById('chatPlusBtn');
        const chatPlusMenu = document.getElementById('chatPlusMenu');
        let chatPlusMenuOpen = false;

        function toggleChatPlusMenu() {
            chatPlusMenuOpen = !chatPlusMenuOpen;
            if (chatPlusMenuOpen) {
                chatPlusMenu.classList.add('show');
            } else {
                chatPlusMenu.classList.remove('show');
            }
        }

        function closeChatPlusMenu() {
            chatPlusMenuOpen = false;
            chatPlusMenu.classList.remove('show');
        }

        chatPlusBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleChatPlusMenu();
        });

        // 点击菜单项
        chatPlusMenu.querySelectorAll('.chat-plus-item').forEach(item => {
            item.addEventListener('click', (e) => {
                e.stopPropagation();
                const action = item.dataset.action;
                closeChatPlusMenu();
                if (action === 'edit-relation') {
                    openRelationModal();
                } else if (action === 'emoji') {
                    openStickerPickerModal();
                } else if (action === 'image') {
                    openImageSendModal();
                } else if (action === 'gift') {
                    openGiftPanel();
                } else if (action === 'share-music') {
                    openMusicPanel();
                } else if (action === 'transfer') {
                    openTransferModal();
                } else if (action === 'redpack') {
                    openRedpackModal();
                } else if (action === 'send-location') {
                    openLocationModal(action);
                } else if (action === 'share-location') {
                    // 再次点击“位置共享”视为快速打开位置共享配置（允许多次切换位置）
                    openLocationModal(action);
                } else if (action === 'voice-call') {
                    openVoiceCallPanel();
                } else if (action === 'share-music') {
                    openMusicPanel();
                } else {
                    console.log('选择了:', action);
                }
            });
        });

        // 点击聊天界面其他地方关闭菜单
        document.getElementById('chatPanel').addEventListener('click', (e) => {
            if (chatPlusMenuOpen && !chatPlusMenu.contains(e.target) && !chatPlusBtn.contains(e.target)) {
                closeChatPlusMenu();
            }
        });

        function openRelationModal() {
            if (!currentChatRelationId) return;
            const r = gameState.relations.find(x => x.id === currentChatRelationId);
            if (!r) return;
            relationEditCache.id = r.id;
            relationEditCache.avatar = r.avatar || '';
            relationEditCache.age = r.age || 0;
            relationEditCache.affinity = r.affinity || 0;
            relationEditCache.personality = r.personality || '';
            relationEditCache.background = r.background || '';
            relationEditCache.name = r.name || '';
            relationEditCache.remarkName = r.remarkName || '';
            relationEditCache.displayId = r.displayId || '';
            relationEditCache.meetTime = r.meetTime || '';

            const img = document.getElementById('relationAvatarImg');
            const ph = document.getElementById('relationAvatarPlaceholder');
            if (relationEditCache.avatar) {
                img.src = relationEditCache.avatar;
                img.style.display = 'block';
                ph.style.display = 'none';
            } else {
                img.src = '';
                img.style.display = 'none';
                ph.style.display = 'flex';
                if (r.name) {
                    ph.textContent = r.name[0];
                } else {
                    ph.innerHTML = '<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="26" height="26" aria-hidden="true"><circle cx="9" cy="9" r="2.6" fill="none" stroke="currentColor" stroke-width="1.8"/><circle cx="16" cy="10" r="2.2" fill="none" stroke="currentColor" stroke-width="1.8"/><path d="M3.8 20c1.2-3 3.3-4.6 5.6-4.6s4.4 1.6 5.6 4.6" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/><path d="M13.2 20c.7-1.9 2-3 3.7-3 1.8 0 3.2 1.2 3.7 3" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/></svg>';
                }
            }

            document.getElementById('relationNameInput').value = relationEditCache.name;
            document.getElementById('relationRemarkInput').value = relationEditCache.remarkName;
            document.getElementById('relationAgeInput').value = relationEditCache.age;
            document.getElementById('relationAffinityInput').value = relationEditCache.affinity;
            document.getElementById('relationPersonalityInput').value = relationEditCache.personality;
            document.getElementById('relationBgInput').value = relationEditCache.background;
            document.getElementById('relationDisplayIdInput').value = relationEditCache.displayId;
            document.getElementById('relationMeetTimeInput').value = relationEditCache.meetTime;

            document.getElementById('relationModal').classList.add('show');
            document.getElementById('relationOverlay').classList.add('show');
        }

        function closeRelationModal() {
            document.getElementById('relationModal').classList.remove('show');
            document.getElementById('relationOverlay').classList.remove('show');
        }

        function openChatSettingsModal() {
            if (!currentChatRelationId) return;
            const r = gameState.relations.find(x => x.id === currentChatRelationId);
            if (!r) return;
            const name = getRelationDisplayName(r) || r.name || '';
            const sub = r.meetTime ? `相遇时间：${r.meetTime}` : '聊天信息';
            const img = document.getElementById('chatSettingsAvatarImg');
            const ph = document.getElementById('chatSettingsAvatarPlaceholder');
            const nameEl = document.getElementById('chatSettingsName');
            const subEl = document.getElementById('chatSettingsSub');
            nameEl.textContent = name || '好友';
            subEl.textContent = sub;
            if (r.avatar) {
                img.src = r.avatar;
                img.style.display = 'block';
                ph.style.display = 'none';
            } else {
                img.src = '';
                img.style.display = 'none';
                ph.style.display = 'flex';
                ph.textContent = (name || '?')[0];
            }
            const mute = !!r.muted;
            const pinned = !!r.pinned;
            const starred = !!r.starred;
            const muteToggle = document.getElementById('chatSettingsMuteToggle');
            const muteThumb = document.getElementById('chatSettingsMuteThumb');
            const muteSwitch = document.getElementById('chatSettingsMuteSwitch');
            muteToggle.checked = mute;
            muteThumb.style.transform = mute ? 'translateX(18px)' : 'translateX(0)';
            muteSwitch.classList.toggle('on', mute);

            const pinToggle = document.getElementById('chatSettingsPinToggle');
            const pinThumb = document.getElementById('chatSettingsPinThumb');
            const pinSwitch = document.getElementById('chatSettingsPinSwitch');
            pinToggle.checked = pinned;
            pinThumb.style.transform = pinned ? 'translateX(18px)' : 'translateX(0)';
            pinSwitch.classList.toggle('on', pinned);

            const starToggle = document.getElementById('chatSettingsStarToggle');
            const starThumb = document.getElementById('chatSettingsStarThumb');
            const starSwitch = document.getElementById('chatSettingsStarSwitch');
            starToggle.checked = starred;
            starThumb.style.transform = starred ? 'translateX(18px)' : 'translateX(0)';
            starSwitch.classList.toggle('on', starred);
            document.getElementById('chatSettingsModal').classList.add('show');
            document.getElementById('chatSettingsOverlay').classList.add('show');
        }

        function closeChatSettingsModal() {
            document.getElementById('chatSettingsModal').classList.remove('show');
            document.getElementById('chatSettingsOverlay').classList.remove('show');
        }

        document.getElementById('ageBadge').addEventListener('click', openProfileModal);
        document.getElementById('monthBtn').addEventListener('click', advanceMonth);
        document.getElementById('timelineToggle').addEventListener('click', () => {
            const w = document.getElementById('timelineWrap');
            const arr = document.getElementById('timelineArrow');
            w.classList.toggle('collapsed');
            arr.textContent = w.classList.contains('collapsed') ? '▶' : '▼';
        });

        function applyApiSettings() {
            const h = document.getElementById('apiHost'), k = document.getElementById('apiKey'), m = document.getElementById('apiModel'), pk = document.getElementById('pexelsKey');
            if (h) h.value = userSettings.api.endpoint || '';
            if (k) k.value = userSettings.api.key || '';
            if (m) m.value = userSettings.api.model || '';
            if (pk) pk.value = userSettings.pexelsKey || '';
        }
        function saveApiSettings() {
            userSettings.api.endpoint = document.getElementById('apiHost').value.trim();
            userSettings.api.key = document.getElementById('apiKey').value;
            userSettings.api.model = document.getElementById('apiModel').value.trim();
            const pkEl = document.getElementById('pexelsKey');
            userSettings.pexelsKey = pkEl ? pkEl.value.trim() : '';
            localStorage.setItem('tabula_settings', JSON.stringify(userSettings));
        }
        ['apiHost','apiKey','apiModel','pexelsKey'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.addEventListener('change', saveApiSettings);
        });
        document.getElementById('apiFetchModels').addEventListener('click', async () => {
            const host = document.getElementById('apiHost').value.trim();
            const key = document.getElementById('apiKey').value.trim();
            if (!host || !key) { alert('请先填写 API Host 和 API Key'); return; }
            const modelsUrl = host.replace(/\/chat\/completions\/?$/, '') + '/models';
            const listEl = document.getElementById('modelList');
            listEl.innerHTML = '<div style="padding:12px;color:var(--text-muted)">加载中...</div>';
            listEl.classList.add('show');
            try {
                const res = await fetch(modelsUrl, { headers: { 'Authorization': 'Bearer ' + key } });
                const data = await res.json();
                const models = data.data ? data.data.map(x => x.id) : [];
                if (models.length === 0) { listEl.innerHTML = '<div style="padding:12px;color:var(--text-muted)">未获取到模型</div>'; return; }
                listEl.innerHTML = models.map(id => `<div class="model-item" data-model="${id}">${id}</div>`).join('');
                listEl.querySelectorAll('.model-item').forEach(el => {
                    el.addEventListener('click', () => {
                        document.getElementById('apiModel').value = el.dataset.model;
                        saveApiSettings();
                        listEl.classList.remove('show');
                    });
                });
            } catch (e) {
                listEl.innerHTML = '<div style="padding:12px;color:#e74c3c">获取失败: ' + (e.message || '网络错误') + '</div>';
            }
        });

        document.getElementById('reincarnateBtn').addEventListener('click', openReincarnateModal);
        document.getElementById('reincarnateOverlay').addEventListener('click', closeReincarnateModal);

        function openReincarnateModal() {
            const ds = gameState.descendants || [];
            const optDesc = document.getElementById('reincOptDescendant');
            const hint = document.getElementById('reincDescHint');
            if (ds.length > 0) {
                optDesc.classList.remove('disabled');
                optDesc.style.cursor = 'pointer';
                hint.textContent = `可继承 ${ds.length} 名后代的血脉`;
            } else {
                optDesc.classList.add('disabled');
                optDesc.style.cursor = 'not-allowed';
                hint.textContent = '暂无后代可继承';
            }
            document.getElementById('reincarnateModal').classList.add('show');
            document.getElementById('reincarnateOverlay').classList.add('show');
        }
        function closeReincarnateModal() {
            document.getElementById('reincarnateModal').classList.remove('show');
            document.getElementById('reincarnateOverlay').classList.remove('show');
        }
        function doReincarnate(mode) {
            closeReincarnateModal();
            const prevStats = JSON.parse(JSON.stringify(gameState.stats));
            const prevProfile = JSON.parse(JSON.stringify(gameState.profile || {}));
            const prevDesc = gameState.descendants || [];

            const baseState = {
                meta: { currentAge: 0, currentYear: 2024, currentMonth: 1, currentDay: 1, isAlive: true, causeOfDeath: null },
                activeMapId: 'map_crib',
                descendants: [],
                relations: [
                    { id: 'npc_001', role: 'father', name: '父亲', age: 28, affinity: 50, category: 'family' },
                    { id: 'npc_002', role: 'mother', name: '母亲', age: 26, affinity: 50, category: 'family' }
                ],
                inventory: { items: [], properties: [], jobs: [] },
                historyLog: [{ age: 0, month: 1, text: '你出生了。人生如白纸，等待被描绘。', source: 'local' }]
            };

            if (mode === 'descendant' && prevDesc.length > 0) {
                const d = prevDesc[prevDesc.length - 1];
                gameState = {
                    ...baseState,
                    stats: { ...prevStats, ...d.stats, health: 100, happiness: 100, pressure: 0, money: d.money || 0 },
                    profile: { ...prevProfile, gender: Math.random() > 0.5 ? 'male' : 'female' }
                };
            } else if (mode === 'fresh') {
                const gender = Math.random() > 0.5 ? 'male' : 'female';
                gameState = {
                    ...baseState,
                    stats: { health: 100, happiness: 100, money: 0, intelligence: 10, eq: 10, charm: 50, appearance: 50, pressure: 0, ageSpecific: {} },
                    profile: { avatar: prevProfile.avatar || '', gender, background: '' }
                };
            } else {
                gameState = {
                    ...baseState,
                    stats: {
                        health: 100, happiness: 100, pressure: 0,
                        intelligence: prevStats.intelligence ?? 10,
                        eq: prevStats.eq ?? 10,
                        charm: prevStats.charm ?? 50,
                        appearance: prevStats.appearance ?? 50,
                        money: Math.floor((prevStats.money || 0) * 0.1),
                        ageSpecific: {}
                    },
                    profile: { ...prevProfile }
                };
            }
            gameState.stats.ageSpecific = {};
            saveGame();
            location.reload();
        }

        document.getElementById('reincOptDescendant').addEventListener('click', () => {
            if (!document.getElementById('reincOptDescendant').classList.contains('disabled')) doReincarnate('descendant');
        });
        document.getElementById('reincOptFresh').addEventListener('click', () => doReincarnate('fresh'));
        document.getElementById('reincOptInherit').addEventListener('click', () => doReincarnate('inherit'));

        document.getElementById('chatMoreBtn').addEventListener('click', (e) => {
            e.stopPropagation();
            openChatSettingsModal();
        });
        document.getElementById('relationOverlay').addEventListener('click', closeRelationModal);
        document.getElementById('relationCancelBtn').addEventListener('click', closeRelationModal);
        document.getElementById('relationSaveBtn').addEventListener('click', () => {
            if (!relationEditCache.id) { closeRelationModal(); return; }
            const r = gameState.relations.find(x => x.id === relationEditCache.id);
            if (!r) { closeRelationModal(); return; }
            const nameVal = document.getElementById('relationNameInput').value.trim();
            const remarkVal = document.getElementById('relationRemarkInput').value.trim();
            const ageVal = parseInt(document.getElementById('relationAgeInput').value, 10);
            const affinityVal = parseInt(document.getElementById('relationAffinityInput').value, 10);
            let displayIdVal = document.getElementById('relationDisplayIdInput').value.trim();
            const meetTimeVal = document.getElementById('relationMeetTimeInput').value.trim();
            if (!displayIdVal) {
                const rels = gameState.relations || [];
                let candidate = '';
                let safeGuard = 0;
                do {
                    const len = Math.max(1, Math.min(10, Math.floor(Math.random() * 10) + 1));
                    let s = '';
                    for (let i = 0; i < len; i++) s += Math.floor(Math.random() * 10);
                    candidate = s;
                    safeGuard++;
                } while (rels.some(x => x.displayId === candidate) && safeGuard < 50);
                displayIdVal = candidate;
            }
            if (nameVal) r.name = nameVal;
            r.remarkName = remarkVal || '';
            r.age = isNaN(ageVal) ? r.age : Math.min(120, Math.max(0, ageVal));
            r.affinity = isNaN(affinityVal) ? r.affinity : Math.min(100, Math.max(0, affinityVal));
            r.personality = document.getElementById('relationPersonalityInput').value.trim();
            r.background = document.getElementById('relationBgInput').value.trim();
            r.displayId = displayIdVal;
            r.meetTime = meetTimeVal;
            if (relationEditCache.avatar) {
                r.avatar = relationEditCache.avatar;
            }
            saveGame();
            renderRelations(currentRelationFilter);
            if (currentChatRelationId === r.id) {
                document.getElementById('chatTitle').textContent = getRelationDisplayName(r) || r.name;
            }
            closeRelationModal();
        });
        document.getElementById('relationAvatarWrap').addEventListener('click', () => {
            document.getElementById('relationAvatarInput').click();
        });
        document.getElementById('relationAvatarInput').addEventListener('change', (e) => {
            const f = e.target.files[0];
            if (!f || !f.type.startsWith('image/')) return;
            compressImageFile(f, 320, (dataUrl) => {
                relationEditCache.avatar = dataUrl;
                const img = document.getElementById('relationAvatarImg');
                const ph = document.getElementById('relationAvatarPlaceholder');
                img.src = dataUrl;
                img.style.display = 'block';
                ph.style.display = 'none';
            });
            e.target.value = '';
        });
        document.getElementById('chatSettingsBackBtn').addEventListener('click', closeChatSettingsModal);
        document.getElementById('chatSettingsMuteToggle').addEventListener('change', (e) => {
            if (!currentChatRelationId) return;
            const r = gameState.relations.find(x => x.id === currentChatRelationId);
            if (!r) return;
            r.muted = !!e.target.checked;
            const thumb = document.getElementById('chatSettingsMuteThumb');
            const sw = document.getElementById('chatSettingsMuteSwitch');
            thumb.style.transform = r.muted ? 'translateX(18px)' : 'translateX(0)';
            sw.classList.toggle('on', r.muted);
            saveGame();
        });
        document.getElementById('chatSettingsPinToggle').addEventListener('change', (e) => {
            if (!currentChatRelationId) return;
            const r = gameState.relations.find(x => x.id === currentChatRelationId);
            if (!r) return;
            r.pinned = !!e.target.checked;
            const thumb = document.getElementById('chatSettingsPinThumb');
            const sw = document.getElementById('chatSettingsPinSwitch');
            thumb.style.transform = r.pinned ? 'translateX(18px)' : 'translateX(0)';
            sw.classList.toggle('on', r.pinned);
            saveGame();
        });
        document.getElementById('chatSettingsStarToggle').addEventListener('change', (e) => {
            if (!currentChatRelationId) return;
            const r = gameState.relations.find(x => x.id === currentChatRelationId);
            if (!r) return;
            r.starred = !!e.target.checked;
            const thumb = document.getElementById('chatSettingsStarThumb');
            const sw = document.getElementById('chatSettingsStarSwitch');
            thumb.style.transform = r.starred ? 'translateX(18px)' : 'translateX(0)';
            sw.classList.toggle('on', r.starred);
            saveGame();
        });
        document.getElementById('stickerPickerClose').addEventListener('click', closeStickerPickerModal);
        document.getElementById('stickerPickerOverlay').addEventListener('click', closeStickerPickerModal);
        document.getElementById('albumPickBtn').addEventListener('click', () => document.getElementById('stickerAlbumFileInput').click());
        document.getElementById('stickerAlbumFileInput').addEventListener('change', (e) => {
            const file = e.target.files && e.target.files[0];
            e.target.value = '';
            if (!file || !file.type.startsWith('image/')) return;
            const reader = new FileReader();
            reader.onload = function() {
                albumPending.src = reader.result;
                const preview = document.getElementById('albumPreview');
                preview.src = albumPending.src;
                preview.classList.add('show');
            };
            reader.readAsDataURL(file);
        });
        document.getElementById('albumCancelBtn').addEventListener('click', () => { closeAlbumModalOnly(); openStickerPickerModal(); });
        document.getElementById('albumConfirmBtn').addEventListener('click', () => {
            const desc = (document.getElementById('albumDescInput').value || '').trim();
            if (albumEditIdx >= 0) {
                const arr = albumAddTarget === 'self'
                    ? (gameState.profile && gameState.profile.stickers) || []
                    : (currentChatRelationId && gameState.relations.find(x => x.id === currentChatRelationId) && gameState.relations.find(x => x.id === currentChatRelationId).stickers) || [];
                if (arr[albumEditIdx]) {
                    if (albumPending.src) arr[albumEditIdx].src = albumPending.src;
                    arr[albumEditIdx].desc = desc;
                }
            } else {
                if (!albumPending.src) return;
                albumPending.desc = desc;
                if (albumAddTarget === 'self') {
                    if (!gameState.profile) gameState.profile = {};
                    if (!Array.isArray(gameState.profile.stickers)) gameState.profile.stickers = [];
                    gameState.profile.stickers.push({ src: albumPending.src, desc: albumPending.desc });
                } else {
                    const r = currentChatRelationId ? gameState.relations.find(x => x.id === currentChatRelationId) : null;
                    if (r) {
                        if (!Array.isArray(r.stickers)) r.stickers = [];
                        r.stickers.push({ src: albumPending.src, desc: albumPending.desc });
                    }
                }
            }
            saveGame();
            closeAlbumModal();
        });
        document.getElementById('albumOverlay').addEventListener('click', () => { closeAlbumModalOnly(); openStickerPickerModal(); });
        document.getElementById('imageSendPickBtn').addEventListener('click', () => document.getElementById('imageSendFileInput').click());
        document.getElementById('imageSendFileInput').addEventListener('change', (e) => {
            const file = e.target.files && e.target.files[0];
            e.target.value = '';
            if (!file || !file.type.startsWith('image/')) return;
            const reader = new FileReader();
            reader.onload = function() {
                imageSendPending.src = reader.result;
                const preview = document.getElementById('imageSendPreview');
                preview.src = reader.result;
                preview.classList.add('show');
            };
            reader.readAsDataURL(file);
        });
        document.getElementById('imageSendCancelBtn').addEventListener('click', closeImageSendModal);
        document.getElementById('imageSendConfirmBtn').addEventListener('click', () => {
            imageSendPending.desc = (document.getElementById('imageSendDescInput').value || '').trim();
            sendImageMessage();
        });
        document.getElementById('imageSendOverlay').addEventListener('click', closeImageSendModal);
        // 发送位置事件绑定
        document.getElementById('locationOverlay').addEventListener('click', closeLocationModal);
        document.getElementById('locationCancelBtn').addEventListener('click', closeLocationModal);
        document.getElementById('locationRefreshBtn').addEventListener('click', () => {
            requestCurrentLocation();
        });
        document.getElementById('locationSendBtn').addEventListener('click', () => {
            updateLocationFromInputs();
            sendLocationMessage();
        });
        document.getElementById('locationLatInput').addEventListener('change', updateLocationFromInputs);
        document.getElementById('locationLngInput').addEventListener('change', updateLocationFromInputs);
        document.getElementById('locationLatInput').addEventListener('input', updateLocationFromInputs);
        document.getElementById('locationLngInput').addEventListener('input', updateLocationFromInputs);
        // 聊天顶部位置共享状态栏事件
        document.getElementById('chatLocationShareToggle').addEventListener('click', () => {
            const state = getCurrentLocationShare();
            if (state && state.active) {
                setCurrentLocationShare(null);
            } else if (currentChatRelationId) {
                // 未开启时，快捷进入位置共享配置
                openLocationModal('share-location');
            }
        });
        const chatLocationShareBarEl = document.getElementById('chatLocationShareBar');
        if (chatLocationShareBarEl) {
            chatLocationShareBarEl.addEventListener('click', (e) => {
                const toggleEl = document.getElementById('chatLocationShareToggle');
                if (toggleEl && toggleEl.contains(e.target)) return; // 交给“结束”按钮处理
                // 点击拟态条主体，随时重新调整共享位置
                if (currentChatRelationId) {
                    openLocationModal('share-location');
                }
            });
        }
        const voiceCallHangupBtn = document.getElementById('voiceCallHangupBtn');
        if (voiceCallHangupBtn) {
            voiceCallHangupBtn.addEventListener('click', () => {
                closeVoiceCallPanel();
            });
        }
        const voiceCallSendBtn = document.getElementById('voiceCallSendBtn');
        if (voiceCallSendBtn) {
            voiceCallSendBtn.addEventListener('click', () => {
                sendVoiceCallText();
            });
        }
        const voiceCallInput = document.getElementById('voiceCallInput');
        if (voiceCallInput) {
            voiceCallInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendVoiceCallText();
                }
            });
        }
        // 语音通话样式弹窗相关事件
        const voiceCallTagBtn = document.getElementById('voiceCallTagBtn');
        const voiceCallStyleModal = document.getElementById('voiceCallStyleModal');
        const voiceCallStyleOverlay = document.getElementById('voiceCallStyleOverlay');
        const voiceCallBgFileInput = document.getElementById('voiceCallBgFileInput');
        if (voiceCallTagBtn && voiceCallStyleModal && voiceCallStyleOverlay) {
            voiceCallTagBtn.addEventListener('click', () => {
                if (!currentChatRelationId) return;
                const r = gameState.relations.find(x => x.id === currentChatRelationId);
                const style = r && r.voiceCallStyle ? r.voiceCallStyle : {};
                document.getElementById('voiceCallTranscriptBgInput').value = style.transcriptBg || '#111827';
                document.getElementById('voiceCallTranscriptColorInput').value = style.transcriptColor || '#e5e7eb';
                document.getElementById('voiceCallInputBgInput').value = style.inputBg || '#020617';
                document.getElementById('voiceCallInputColorInput').value = style.inputColor || '#e5e7eb';
                voiceCallStyleModal.classList.add('show');
                voiceCallStyleOverlay.classList.add('show');
            });
            const closeStyleModal = () => {
                voiceCallStyleModal.classList.remove('show');
                voiceCallStyleOverlay.classList.remove('show');
            };
            document.getElementById('voiceCallStyleCancelBtn').addEventListener('click', closeStyleModal);
            voiceCallStyleOverlay.addEventListener('click', closeStyleModal);
            document.getElementById('voiceCallStyleConfirmBtn').addEventListener('click', () => {
                if (!currentChatRelationId) { closeStyleModal(); return; }
                const r = gameState.relations.find(x => x.id === currentChatRelationId);
                if (!r) { closeStyleModal(); return; }
                const transcriptBg = document.getElementById('voiceCallTranscriptBgInput').value;
                const transcriptColor = document.getElementById('voiceCallTranscriptColorInput').value;
                const inputBg = document.getElementById('voiceCallInputBgInput').value;
                const inputColor = document.getElementById('voiceCallInputColorInput').value;
                r.voiceCallStyle = {
                    transcriptBg,
                    transcriptColor,
                    inputBg,
                    inputColor
                };
                saveGame();
                applyVoiceCallBackgroundForRelation(r);
                closeStyleModal();
            });
            document.getElementById('voiceCallBgPickBtn').addEventListener('click', () => {
                if (!currentChatRelationId || !voiceCallBgFileInput) return;
                voiceCallBgFileInput.click();
            });
            if (voiceCallBgFileInput) {
                voiceCallBgFileInput.addEventListener('change', (e) => {
                    const f = e.target.files && e.target.files[0];
                    e.target.value = '';
                    if (!f || !f.type.startsWith('image/')) return;
                    if (!currentChatRelationId) return;
                    compressImageFile(f, 720, (dataUrl) => {
                        const r = gameState.relations.find(x => x.id === currentChatRelationId);
                        if (!r) return;
                        r.voiceCallBg = dataUrl;
                        saveGame();
                        applyVoiceCallBackgroundForRelation(r);
                    });
                });
            }
        }

        // 音乐界面事件
        const musicBackBtn = document.getElementById('musicBackBtn');
        const musicSearchBtn = document.getElementById('musicSearchBtn');
        const musicSearchInput = document.getElementById('musicSearchInput');
        if (musicBackBtn) {
            musicBackBtn.addEventListener('click', closeMusicPanel);
        }
        if (musicSearchBtn && musicSearchInput) {
            musicSearchBtn.addEventListener('click', () => {
                searchMusic(musicSearchInput.value.trim());
            });
            musicSearchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    searchMusic(musicSearchInput.value.trim());
                }
            });
        }

        // 聊天里的音乐卡片播放控制
        function bindChatMusicPlayers() {
            if (!musicPreviewAudio) {
                musicPreviewAudio = document.getElementById('musicPreviewAudio');
            }
            const container = document.getElementById('chatMessages');
            if (!container || !musicPreviewAudio) return;
            const cards = container.querySelectorAll('.chat-msg-music-card[data-preview]');
            cards.forEach(card => {
                const preview = card.getAttribute('data-preview') || '';
                const playBtn = card.querySelector('.chat-msg-music-play');
                const range = card.querySelector('.chat-msg-music-progress input[type="range"]');
                if (playBtn && preview) {
                    playBtn.onclick = () => {
                        if (!preview) return;
                        if (currentMusicPlayingId === preview && !musicPreviewAudio.paused) {
                            musicPreviewAudio.pause();
                            currentMusicPlayingId = null;
                        } else {
                            musicPreviewAudio.src = preview;
                            musicPreviewAudio.play().catch(() => {});
                            currentMusicPlayingId = preview;
                        }
                    };
                }
                if (range && preview) {
                    range.oninput = () => {
                        if (currentMusicPlayingId !== preview) return;
                        if (!musicPreviewAudio.duration || isNaN(musicPreviewAudio.duration)) return;
                        const ratio = parseInt(range.value || '0', 10) / 100;
                        musicPreviewAudio.currentTime = musicPreviewAudio.duration * ratio;
                    };
                }
            });
            if (musicPreviewAudio) {
                musicPreviewAudio.ontimeupdate = () => {
                    if (!currentMusicPlayingId || !musicPreviewAudio.duration || isNaN(musicPreviewAudio.duration)) return;
                    const ratio = musicPreviewAudio.currentTime / musicPreviewAudio.duration;
                    const percent = String(Math.floor(ratio * 100));
                    const cur = musicPreviewAudio.currentTime;
                    const dur = musicPreviewAudio.duration;
                    const fmt = (s) => {
                        if (!s || isNaN(s)) return '--:--';
                        const m = Math.floor(s / 60);
                        const sec = Math.floor(s % 60);
                        return m + ':' + (sec < 10 ? '0' : '') + sec;
                    };
                    cards.forEach(card => {
                        const preview = card.getAttribute('data-preview') || '';
                        if (preview !== currentMusicPlayingId) return;
                        const range = card.querySelector('.chat-msg-music-progress input[type="range"]');
                        if (range) range.value = percent;
                        const curSpan = card.querySelector('.chat-msg-music-time-current');
                        const totalSpan = card.querySelector('.chat-msg-music-time-total');
                        if (curSpan) curSpan.textContent = fmt(cur);
                        if (totalSpan) {
                            if (dur && !isNaN(dur)) {
                                totalSpan.textContent = fmt(dur);
                            }
                        }
                    });
                };
            }
        }
        document.getElementById('transferCancelBtn').addEventListener('click', closeTransferModal);
        document.getElementById('transferOverlay').addEventListener('click', closeTransferModal);
        document.getElementById('transferStyleBtn').addEventListener('click', (e) => {
            e.stopPropagation();
            openTransferStyleLibrary();
        });
        document.getElementById('redpackStyleBtn').addEventListener('click', (e) => {
            e.stopPropagation();
            openRedpackStyleLibrary();
        });
        document.getElementById('transferStyleCloseBtn').addEventListener('click', closeTransferStyleLibrary);
        document.getElementById('transferStyleOverlay').addEventListener('click', closeTransferStyleLibrary);
        document.getElementById('redpackStyleCloseBtn').addEventListener('click', closeRedpackStyleLibrary);
        document.getElementById('redpackStyleOverlay').addEventListener('click', closeRedpackStyleLibrary);
        document.getElementById('transferStyleAddBtn').addEventListener('click', () => {
            currentStyleType = 'transfer';
            openStyleCustomModal();
        });
        document.getElementById('redpackStyleAddBtn').addEventListener('click', () => {
            currentStyleType = 'redpack';
            openStyleCustomModal();
        });
        document.getElementById('styleCustomCloseBtn').addEventListener('click', closeStyleCustomModal);
        document.getElementById('styleCustomOverlay').addEventListener('click', closeStyleCustomModal);
        document.getElementById('styleCustomCancelBtn').addEventListener('click', closeStyleCustomModal);
        document.getElementById('styleCustomSaveBtn').addEventListener('click', saveCustomStyle);
        document.getElementById('styleCustomColor1Input').addEventListener('input', (e) => {
            document.getElementById('styleCustomColor1Text').value = e.target.value;
            updateStylePreview();
        });
        document.getElementById('styleCustomColor1Text').addEventListener('input', (e) => {
            const val = e.target.value.trim();
            if (/^#[0-9A-Fa-f]{6}$/.test(val)) {
                document.getElementById('styleCustomColor1Input').value = val;
            }
            updateStylePreview();
        });
        document.getElementById('styleCustomColor2Input').addEventListener('input', (e) => {
            document.getElementById('styleCustomColor2Text').value = e.target.value;
            updateStylePreview();
        });
        document.getElementById('styleCustomColor2Text').addEventListener('input', (e) => {
            const val = e.target.value.trim();
            if (/^#[0-9A-Fa-f]{6}$/.test(val)) {
                document.getElementById('styleCustomColor2Input').value = val;
            }
            updateStylePreview();
        });
        document.getElementById('styleCustomAmountColorInput').addEventListener('input', (e) => {
            document.getElementById('styleCustomAmountColorText').value = e.target.value;
            updateStylePreview();
        });
        document.getElementById('styleCustomAmountColorText').addEventListener('input', (e) => {
            const val = e.target.value.trim();
            if (/^#[0-9A-Fa-f]{6}$/.test(val)) {
                document.getElementById('styleCustomAmountColorInput').value = val;
            }
            updateStylePreview();
        });
        document.getElementById('styleCustomAmountSizeInput').addEventListener('input', updateStylePreview);
        document.getElementById('styleCustomRadiusInput').addEventListener('input', updateStylePreview);
        document.querySelectorAll('.style-custom-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.dataset.tab;
                document.querySelectorAll('.style-custom-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.style-custom-tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById('styleTab' + tabName.charAt(0).toUpperCase() + tabName.slice(1)).classList.add('active');
            });
        });
        document.getElementById('styleCustomGradientDir').addEventListener('change', updateStylePreview);
        document.getElementById('styleCustomWidthInput').addEventListener('input', updateStylePreview);
        document.getElementById('styleCustomUnitSizeInput').addEventListener('input', updateStylePreview);
        document.getElementById('styleCustomTitleColorInput').addEventListener('input', (e) => {
            document.getElementById('styleCustomTitleColorText').value = e.target.value;
            updateStylePreview();
        });
        document.getElementById('styleCustomTitleColorText').addEventListener('input', (e) => {
            const val = e.target.value.trim();
            if (/^#[0-9A-Fa-f]{6}$/.test(val)) {
                document.getElementById('styleCustomTitleColorInput').value = val;
            }
            updateStylePreview();
        });
        document.getElementById('styleCustomTitleSizeInput').addEventListener('input', updateStylePreview);
        document.getElementById('styleCustomNoteColorInput').addEventListener('input', (e) => {
            document.getElementById('styleCustomNoteColorText').value = e.target.value;
            updateStylePreview();
        });
        document.getElementById('styleCustomNoteColorText').addEventListener('input', (e) => {
            const val = e.target.value.trim();
            if (/^#[0-9A-Fa-f]{6}$/.test(val) || val.startsWith('rgba')) {
                document.getElementById('styleCustomNoteColorInput').value = val.startsWith('#') ? val : '#888888';
            }
            updateStylePreview();
        });
        document.getElementById('styleCustomNoteSizeInput').addEventListener('input', updateStylePreview);
        document.getElementById('styleCustomIconColorInput').addEventListener('input', (e) => {
            document.getElementById('styleCustomIconColorText').value = e.target.value;
            updateStylePreview();
        });
        document.getElementById('styleCustomIconColorText').addEventListener('input', (e) => {
            const val = e.target.value.trim();
            if (/^#[0-9A-Fa-f]{6}$/.test(val)) {
                document.getElementById('styleCustomIconColorInput').value = val;
            }
            updateStylePreview();
        });
        document.getElementById('styleCustomIconSizeInput').addEventListener('input', updateStylePreview);
        document.getElementById('styleCustomBorderWidthInput').addEventListener('input', updateStylePreview);
        document.getElementById('styleCustomBorderColorInput').addEventListener('input', (e) => {
            document.getElementById('styleCustomBorderColorText').value = e.target.value;
            updateStylePreview();
        });
        document.getElementById('styleCustomBorderColorText').addEventListener('input', (e) => {
            const val = e.target.value.trim();
            if (/^#[0-9A-Fa-f]{6}$/.test(val)) {
                document.getElementById('styleCustomBorderColorInput').value = val;
            }
            updateStylePreview();
        });
        document.getElementById('styleCustomBorderOpacityInput').addEventListener('input', updateStylePreview);
        document.getElementById('styleCustomShadowXInput').addEventListener('input', updateStylePreview);
        document.getElementById('styleCustomShadowYInput').addEventListener('input', updateStylePreview);
        document.getElementById('styleCustomShadowBlurInput').addEventListener('input', updateStylePreview);
        document.getElementById('styleCustomShadowSpreadInput').addEventListener('input', updateStylePreview);
        document.getElementById('styleCustomShadowColorInput').addEventListener('input', (e) => {
            document.getElementById('styleCustomShadowColorText').value = e.target.value;
            updateStylePreview();
        });
        document.getElementById('styleCustomShadowColorText').addEventListener('input', (e) => {
            const val = e.target.value.trim();
            if (/^#[0-9A-Fa-f]{6}$/.test(val)) {
                document.getElementById('styleCustomShadowColorInput').value = val;
            }
            updateStylePreview();
        });
        document.getElementById('styleCustomShadowOpacityInput').addEventListener('input', updateStylePreview);
        document.getElementById('styleCustomHeadPaddingInput').addEventListener('input', updateStylePreview);
        document.getElementById('styleCustomBodyPaddingInput').addEventListener('input', updateStylePreview);
        document.getElementById('styleCustomHeadBgInput').addEventListener('input', (e) => {
            document.getElementById('styleCustomHeadBgText').value = e.target.value;
            updateStylePreview();
        });
        document.getElementById('styleCustomHeadBgText').addEventListener('input', (e) => {
            const val = e.target.value.trim();
            if (/^#[0-9A-Fa-f]{6}$/.test(val) || val === 'transparent') {
                document.getElementById('styleCustomHeadBgInput').value = val === 'transparent' ? '#ffffff' : val;
            }
            updateStylePreview();
        });
        document.getElementById('styleCustomHeadBorderInput').addEventListener('input', (e) => {
            document.getElementById('styleCustomHeadBorderText').value = e.target.value;
            updateStylePreview();
        });
        document.getElementById('styleCustomHeadBorderText').addEventListener('input', (e) => {
            const val = e.target.value.trim();
            if (/^#[0-9A-Fa-f]{6}$/.test(val) || val.startsWith('rgba')) {
                document.getElementById('styleCustomHeadBorderInput').value = val.startsWith('#') ? val : '#f0f0f0';
            }
            updateStylePreview();
        });
        document.getElementById('styleCustomBodyBgInput').addEventListener('input', (e) => {
            document.getElementById('styleCustomBodyBgText').value = e.target.value;
            updateStylePreview();
        });
        document.getElementById('styleCustomBodyBgText').addEventListener('input', (e) => {
            const val = e.target.value.trim();
            if (/^#[0-9A-Fa-f]{6}$/.test(val)) {
                document.getElementById('styleCustomBodyBgInput').value = val;
            }
            updateStylePreview();
        });
        document.getElementById('transferConfirmBtn').addEventListener('click', () => {
            const amount = document.getElementById('transferAmountInput').value.trim();
            const note = (document.getElementById('transferNoteInput').value || '').trim();
            if (!amount || !currentChatRelationId) return;
            const num = parseFloat(amount);
            if (isNaN(num) || num <= 0) return;
            if (!gameState.chatLogs[currentChatRelationId]) gameState.chatLogs[currentChatRelationId] = [];
            const transferMsg = { from: 'me', transfer: { amount: num, note, accepted: false } };
            gameState.chatLogs[currentChatRelationId].push(transferMsg);
            renderChatMessages();
            closeTransferModal();
            saveGame();
            // 对方自动接受转账（延迟1-2秒），以对方视角新增"转账已接收"卡片
            setTimeout(() => {
                if (!currentChatRelationId) return;
                const logs = gameState.chatLogs[currentChatRelationId] || [];
                let lastTransfer = null;
                for (let i = logs.length - 1; i >= 0; i--) {
                    const m = logs[i];
                    if (m.transfer && m.from === 'me' && !m.transfer.accepted) {
                        lastTransfer = m;
                        break;
                    }
                }
                if (lastTransfer && lastTransfer.transfer) {
                    lastTransfer.transfer.accepted = true;
                    gameState.chatLogs[currentChatRelationId].push({
                        from: 'other',
                        transferAccepted: {
                            amount: lastTransfer.transfer.amount,
                            note: lastTransfer.transfer.note
                        }
                    });
                    renderChatMessages();
                    saveGame();
                }
            }, 1000 + Math.random() * 1000);
        });
        document.getElementById('redpackCancelBtn').addEventListener('click', closeRedpackModal);
        document.getElementById('redpackOverlay').addEventListener('click', closeRedpackModal);
        document.getElementById('redpackConfirmBtn').addEventListener('click', () => {
            const amount = document.getElementById('redpackAmountInput').value.trim();
            const blessing = (document.getElementById('redpackBlessingInput').value || '').trim();
            if (!amount || !currentChatRelationId) return;
            const num = parseFloat(amount);
            if (isNaN(num) || num <= 0) return;
            if (!gameState.chatLogs[currentChatRelationId]) gameState.chatLogs[currentChatRelationId] = [];
            gameState.chatLogs[currentChatRelationId].push({ from: 'me', redpack: { amount: num, blessing, opened: false } });
            renderChatMessages();
            closeRedpackModal();
            saveGame();
        });
        document.getElementById('chatSettingsBgRow').addEventListener('click', () => {
            closeChatSettingsModal();
            document.getElementById('chatBgFileInput').click();
        });
        document.getElementById('chatBgFileInput').addEventListener('change', (e) => {
            const file = e.target && e.target.files && e.target.files[0];
            e.target.value = '';
            if (!file || !currentChatRelationId) return;
            const r = gameState.relations.find(x => x.id === currentChatRelationId);
            if (!r) return;
            const reader = new FileReader();
            reader.onload = function() {
                r.chatBg = reader.result;
                applyChatBackground();
                saveGame();
            };
            reader.readAsDataURL(file);
        });

        loadGame();
        if (!gameState.meta.currentMonth) gameState.meta.currentMonth = 1;
        if (!gameState.meta.currentDay) gameState.meta.currentDay = 1;
        if (!gameState.stats.eq) gameState.stats.eq = 10;
        if (!gameState.stats.charm) gameState.stats.charm = 50;
        if (!gameState.profile) gameState.profile = { avatar: '', gender: 'female', background: '' };
        if (!gameState.profile.gender) gameState.profile.gender = 'female';
        if (!gameState.descendants) gameState.descendants = [];
        if (!gameState.relationGroups) gameState.relationGroups = ['family','lover','work','enemy'];
        applyApiSettings();
        renderMapGrids();
        renderStats();
        renderTimeline();
        renderRelationFilterTabs();
        renderRelations(currentRelationFilter);
        renderSaveSlots();
        updateMap(gameState.meta.currentAge);
        updateDateDisplay();
        document.getElementById('ageBadge').textContent = gameState.meta.currentAge + ' 岁';
    </script>
</body>
</html>
